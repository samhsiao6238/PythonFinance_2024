# 向量索引

<br>

## 步驟

1. 在 `solutions` 下建立一個子資料夾 `tools` 用來存放一些功能腳本。

<br>

2. 在 `tools` 之內建立腳本 `vector.py`。

    ```python
    # vector.py
    from langchain_community.vectorstores.neo4j_vector import Neo4jVector
    from langchain.chains import RetrievalQA
    from solutions.llm import llm, embeddings
    #
    import streamlit as st

    # 取得環境變數
    NEO4J_URI = st.secrets["NEO4J_URI"]
    NEO4J_USERNAME = st.secrets["NEO4J_USERNAME"]
    NEO4J_PASSWORD = st.secrets["NEO4J_PASSWORD"]

    # 使用 `Neo4jVector.from_existing_index` 函數從既有的索引中建立向量索引
    neo4jvector = Neo4jVector.from_existing_index(
        embeddings,                 # <1> 使用的嵌入向量模型
        url=NEO4J_URI,              # <2> Neo4j 資料庫的 URI
        username=NEO4J_USERNAME,    # <3> Neo4j 資料庫的使用者名稱
        password=NEO4J_PASSWORD,    # <4> Neo4j 資料庫的密碼
        index_name="moviePlots",    # <5> 向量索引的名稱
        node_label="Movie",         # <6> 用於索引的節點標籤
        text_node_property="plot",  # <7> 節點中的文字屬性
        embedding_node_property="plotEmbedding",  # <8> 節點中的嵌入向量屬性
        retrieval_query="""
        RETURN
            node.plot AS text,
            score,
            {
                title: node.title,
                directors: [ (person)-[:DIRECTED]->(node) | person.name ],
                actors: [ (person)-[r:ACTED_IN]->(node) | [person.name, r.role] ],
                tmdbId: node.tmdbId,
                source: 'https://www.themoviedb.org/movie/'+ node.tmdbId
            } AS metadata
        """,
    )
    # 將 Neo4j 向量轉換為檢索器
    retriever = neo4jvector.as_retriever()

    # 使用 RetrievalQA 類別建立問答系統
    kg_qa = RetrievalQA.from_chain_type(
        llm,  # <1> 使用的語言模型
        chain_type="stuff",  # <2> 鏈的類型，這裡使用 "stuff"
        retriever=retriever,  # <3> 用於檢索的檢索器
    )

    ```

<br>

3. 補充說明：`kg_qa` 是指表示一個 `使用知識圖譜（Knowledge Graph）技術來實現的問答（Question Answering）系統`；`知識圖譜` 是一種結構化的知識表示方式，將實體和實體之間的關係以圖的形式進行表示；`問答系統` 則是根據用戶的自然語言問題在知識圖譜中查找相應的答案；`kg_qa` 。

<br>

4. 以下腳本可查詢向量索引。

    ```python
    from neo4j import GraphDatabase

    # 設定 Neo4j 資料庫的 URI 和認證資訊
    URI = "neo4j+s://bfc46ed1.databases.neo4j.io"
    AUTH = ("neo4j", "8Yc-sCEfoQN5XjrKlV4VqqMilhv6HM4jLrwzLf2P-Ic")

    # 建立 Neo4j 連接
    driver = GraphDatabase.driver(URI, auth=AUTH)

    def create_vector_index():
        with driver.session(database="neo4j") as session:
            result = session.run("SHOW INDEXES")
            indexes = result.data()
            index_names = [index['name'] for index in indexes]
            if 'moviePlots' not in index_names:
                session.run(
                    """
                    CREATE INDEX moviePlots FOR (m:Movie) ON (m.plotEmbedding)
                    """
                )
                print("向量索引 moviePlots 已創建")
            else:
                print("向量索引 moviePlots 已存在")

    def check_indexes():
        with driver.session(database="neo4j") as session:
            result = session.run("SHOW INDEXES")
            indexes = result.data()
            for index in indexes:
                print(index)
            if any(index['name'] == 'moviePlots' for index in indexes):
                print("向量索引 moviePlots 確實存在")
            else:
                print("向量索引 moviePlots 不存在")

    if __name__ == "__main__":
        create_vector_index()
        check_indexes()
        driver.close()
    ```

<br>

___

_END_