# 起手式

_01_Neo4jBot_

<br>

## 說明

<br>

1. 這個專案主要包含了三個腳本：`app.py`、`cypher_chain.py`、`cypher_validator.py`。

<br>

2. 另外還有一個 `import.cql` 文件，副檔名 `.cql` 就是 `Cypher Query Language` 的縮寫，是 Neo4j 圖形資料庫專用的查詢語言文件。

<br>

3. 以下將分別解說這三個腳本與一個文件。

<br>

## 專案邏輯流程

1. 本專案是基於 `Streamlit` 搭配 `Neo4j` 圖形數據庫和 `OpenAI` 的語言模型構建的 _互動式對話應用_ 。

<br>

2. 首先， `用戶輸入的對話` 被轉換為具體的 `Cypher 查詢`，然後執行這些查詢來 `獲取數據`，再由語言模型 `生成人類可讀的回答`。

<br>

3. 在這個流程中， `OpenAI` 提供了 `生成 Cypher 查詢` 和 `處理問答 QA` 的功能，這是通過語言模型實現的。

<br>

4. 此外， `Neo4j` 則提供數據庫管理系統的功能，包含儲存和管理結構化數據，以及提供圖形查詢功能。

<br>

## 各腳本功能

1. **用戶界面初始化與設置（`app.py`）**

    - 導入所需的模組和函數。

    - 通過 Streamlit 的 `st.secrets` 從隱藏配置中讀取 Neo4j 的連接信息。
    
    - 建立與 Neo4j 的連接，初始化全局變量和會話狀態。

<br>

2. **用戶輸入處理**

    - 用戶在界面中通過 `st.chat_input` 輸入問題。

    - 檢查 OpenAI API 密鑰是否正確。

    - 若輸入有效，則將輸入文本作為用戶問題進行處理。

<br>

3. **生成上下文（`app.py`的`generate_context`）**

    - 根據用戶的當前問題和會話歷史來構建對話上下文，包括過去的問題和回答。

<br>

4. **查詢處理與生成回答**

    - 使用定義在 `cypher_chain.py` 中的 `CustomCypherChain` 類，這整合了 `生成 Cypher 查詢`、`處理問答` 和 `處理實體` 的功能。

    - 使用 OpenAI 模型生成符合用戶問題的 Cypher 查詢。

    - 執行 Cypher 查詢以從 Neo4j 獲取數據。

    - 生成回答，並處理相關的實體以供視覺化使用。

<br>

5. **會話狀態更新**

    - 將用戶輸入、生成的回答、查詢語句、數據庫查詢結果和視覺化數據存儲在 Streamlit 的 `session_state` 中，用於後續的處理和顯示。

<br>

6. **動態響應標籤的展示（`app.py`的`dynamic_response_tabs`）**

    - 為每次互動創建響應標籤。

    - 根據用戶與助手的對話內容顯示不同標籤，如聊天、Cypher 查詢、數據庫結果和視覺化內容。

<br>

7. **異常處理**

    - 捕捉和處理任何可能發生的異常，確保用戶界面不會因未處理的錯誤而崩潰。

<br>

___

_END_