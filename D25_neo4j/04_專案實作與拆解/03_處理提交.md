# 處理提交

_接下來進行用戶訊息提交後的處理，這部分相對複雜，將拆解多章節說明_

<br>

## 當前狀態

1. 當前是模擬了一個訊息 `_reponse` 作為回應，並傳給 `write_message` 作為參數顯示在對話上，所以在這個部分，將寫代碼生成這個回應 `_reponse`。
```python
# 自訂函數：處理提交訊息
def handle_submit(message):
    # 助理
    with st.spinner('讓我思考一下...'):
        sleep(1)
        _reponse = "我還無法回應你的問題。"
        write_message("assistant", _reponse)
```

2. 建立一個生成回應的函數 `generate_response`，由於需引用 `LangChain` 等套件，為便於管理，將建立新的模組 `agent.py` 進行管理。
```bash
touch agent.py
```

3. 編輯 `agent.py`。
```python
def generate_response(prompt):
    _response = "我還無法回應你的問題"
    return _response
```

4. 在主腳本 `bot.py` 導入自訂模組的自訂函數。
```python
from agent import generate_response
```

5. 修改 `handle_submit`。
```python
# 自訂函數：處理提交訊息
def handle_submit(message):
    # 助理
    with st.spinner('讓我思考一下...'):
        sleep(1)
        # 使用自訂模組內的函數
        _reponse = generate_response(message)
        write_message("assistant", _reponse)
```

6. 當前只能顯示最後一個訊息，所以修改主腳本，在用戶輸入新的訊息前，先遍歷當前 `session_state.messages` 中的紀錄並顯示在對話中。
```python
# 遍歷訊息狀態中的鍵 `messages` 的值
for message in st.session_state.messages:
    write_message(
        message['role'],
        message['content']
    )
```

7. 但是調用 `write_message` 的同時會將讀取出來的訊息又 `再次寫入`，所以要修改函數 `write_message`，添加一個參數 `save`，在調用函數 `write_message` 時決定是否要寫入，或僅僅讀出訊息，並提供預設值 `True`，僅在遍歷顯示時將 `save` 參數設為 `False`。
```python
# 自訂函數
def write_message(_role, _text="", save=True):
    if "messages" not in st.session_state:
        _text = "哈囉，這是初次啟動，請問需要什麼服務？"
        _role = "assistant"
        with st.chat_message(_role):
            st.markdown(_text)
            st.session_state.messages = [{
                "role": _role,
                "content": _text
            }]
    elif _text:
        with st.chat_message(_role):
            st.markdown(_text)
            st.session_state.messages.append(
                {"role": _role, "content": _text}
            )
    # 添加判斷
    if save:
        # 依據傳入的角色將訊息寫入 session_state
        st.session_state.messages.append({
            "role": _role, "content": _text
        })
```


#### 這裡有邏輯謬誤，待修改


8. 修改在主腳本中調用的 `write_message`，添加參數 `save` 並設置為 `False`。
```python
# 遍歷訊息狀態中的鍵 `messages` 的值
for message in st.session_state.messages:
    write_message(
        message['role'],
        message['content'],
        save=False
    )
```
