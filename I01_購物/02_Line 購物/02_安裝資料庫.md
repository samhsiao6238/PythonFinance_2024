# MariaDB

_在 NAS 使用 Docker 部署_

## 步驟

1. 檢查是否已安裝 Docker。

```bash
docker -v
```


2. 拉取 MariaDB 映像。

```bash
docker pull mariadb:latest
```

3. 檢查是否成功拉取 mariadb:latest；特別注意，在 NAS 上必須加入 sudo。


```bash
sudo docker images
```

## 建立數據目錄

1. 建立數據存儲目錄。

```bash
mkdir -p /volume1/docker/mariadb/data
```

2. 建立配置存儲目錄

```bash
mkdir -p /volume1/docker/mariadb/conf
```

## 啟動容器

1. 先建立帳號密碼等變數。

```bash
export MYSQL_USER=sam6238
export MYSQL_PASSWORD=sam112233
export MYSQL_ROOT_PASSWORD=<NAS-的密碼>
export MYSQL_DATABASE=testdb
```

2. 執行以下指令確認變數已正確設置。

```bash
echo $MYSQL_USER $MYSQL_PASSWORD $MYSQL_ROOT_PASSWORD $MYSQL_DATABASE
```

3. 啟動 MariaDB 容器，並設置端口、帳號和密碼。

```bash
sudo docker run -d \
  --name mariadb \
  -e MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD \
  -e MYSQL_DATABASE=$MYSQL_DATABASE \
  -e MYSQL_USER=$MYSQL_USER \
  -e MYSQL_PASSWORD=$MYSQL_PASSWORD \
  -p 3306:3306 \
  -v /volume1/docker/mariadb/data:/var/lib/mysql \
  mariadb:latest
```

## 參數說明
1. `-d`：在後台運行容器。
2. `-p 3306:3306`：將宿主機的 `3306` 端口映射到容器的 `3306` 端口。
3. `-v /volume1/docker/mariadb/data:/var/lib/mysql`：將數據目錄掛載到宿主機。



## 檢查容器狀態

1. 查看容器是否運行中。

```bash
sudo docker ps
```

2. 查看 MariaDB 的日誌，確認是否正常啟動。

```bash
sudo docker logs mariadb
```



## 測試連線

1. 使用 `mysql` 命令行工具或任何支持 MariaDB 的客戶端連線到 MariaDB。

1. 在宿主機使用 MySQL 命令行工具測試連線。

```bash
sudo docker exec -it mariadb mariadb -u root -p
```
   輸入 `root_password`，應該能進入 MariaDB 控制台。


## 運行資料庫

1. 查看現有資料庫。

```sql
SHOW DATABASES;
```

2. 切換到特定資料庫 `testdb`。
```sql
USE testdb;
```

3. 建立新資料庫

```sql
CREATE DATABASE newdb_test;
```

4. 然後確認資料庫是否建立成功。

```sql
SHOW DATABASES;
```

5. 查看資料表。

```sql
SHOW TABLES;
```

## 建立新用戶

1. 查詢當前正在使用資料庫的用戶訊息。

```sql
SELECT USER();
```

2. 查看所有用戶及其主機訊息。

```sql
SELECT User, Host FROM mysql.user;
```

3. 重新建立，先刪除。

```sql
DROP USER IF EXISTS 'sam6238'@'%';
```

4. 建立用戶、授權、確保插件、刷新授權。

```sql
CREATE USER 'sam6238'@'%' IDENTIFIED BY 'sam112233';
GRANT ALL PRIVILEGES ON testdb.* TO 'sam6238'@'%';
ALTER USER 'sam6238'@'%' IDENTIFIED VIA mysql_native_password USING PASSWORD('sam112233');
FLUSH PRIVILEGES;
```

5. 確認用戶是否正確建立。

```sql
SELECT User, Host, Plugin FROM mysql.user WHERE User = 'sam6238';
```

## 安裝

1. 取消 mysql 連結。

```bash
brew unlink mysql
```

2. 安裝 mariaDB 連結。

```bash
brew unlink mariaDB
```

3. 安裝 mariadb。

```bash
brew install mariadb
```

4. 連結 mariadb。

```bash
brew link mariadb
```

5. 連線。

```bash
mariadb -h 192.168.1.239 -P 3306 -u sam6238 -p
```

6. 若要改用 mysql，要先取消連線 mariaDB。

```bash
brew unlink mariaDB
```

7. 重新連線 mysql。

```bash
brew link mysql
```



## 操作資料庫

1. 切換到目標資料庫。

```sql
USE testdb;
```

2. 確認當前選中的資料庫。

```sql
SELECT DATABASE();
```

3. 建立一個資料表。

```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100),
    email VARCHAR(100)
);
```

4. 插入數據。

```sql
INSERT INTO users (name, email) 
VALUES ('Alice', 'alice@example.com'), ('Bob', 'bob@example.com');
```

5. 查看數據。

```sql
SELECT * FROM users;
```

6. 退出 MariaDB。

```sql
EXIT;
```


## 容器管理常用指令

1. 停止容器。

    ```bash
    docker stop mariadb
    ```

2. 啟動容器。

    ```bash
    docker start mariadb
    ```

3. 刪除容器（不刪數據）。

    ```bash
    docker rm mariadb
    ```

4. 刪除數據和容器。

    ```bash
    docker rm -v mariadb
    rm -rf /volume1/docker/mariadb/data
    ```

