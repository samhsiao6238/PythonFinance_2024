# é€²éšæŸ¥è©¢

_åœ¨æ¥ä¸‹ä¾†çš„æ“ä½œä¸­ï¼Œå°‡å°è³‡æ–™åº«çš„æ•¸æ“šé€²è¡Œæå–ï¼ŒåŒæ™‚ä¾æ“šæ¢ä»¶åˆ¤æ–·å½™æ•´æœ‰ç”¨çš„æ•¸æ“š_

<br>

## èªªæ˜

1. åˆ—å‡ºåŒä¸€æ¨™é¡Œçš„å…¨éƒ¨åƒ¹æ ¼ã€‚

    ```python
    import pymysql
    import os
    from dotenv import load_dotenv
    from collections import defaultdict

    # è¼‰å…¥è¨­å®š
    load_dotenv()
    db_config = {
        "host": os.getenv("DB_HOST"),
        "port": int(os.getenv("DB_PORT", 3306)),
        "user": os.getenv("DB_USER"),
        "password": os.getenv("DB_PASSWORD"),
        "database": os.getenv("DB_NAME")
    }

    # ğŸ”¸ æŸ¥è©¢æ¢ä»¶ï¼ˆå¯ä¾éœ€æ±‚ä¿®æ”¹ï¼‰
    search_keyword = "BLUE BAY å€åŠ› Sense"
    # filter_keyword_in_title = "é›ªè‚Œç²¹"
    filter_keyword_in_title = "3ç¨®é­š"

    # é€£ç·šä¸¦æŸ¥è©¢
    connection = pymysql.connect(
        host=db_config["host"],
        port=db_config["port"],
        user=db_config["user"],
        password=db_config["password"],
        database=db_config["database"],
        charset='utf8mb4',
        cursorclass=pymysql.cursors.DictCursor
    )

    with connection:
        with connection.cursor() as cursor:
            sql = """
            SELECT title, price
            FROM coupang_products
            WHERE search_keyword LIKE %s AND title LIKE %s
            ORDER BY title
            """
            cursor.execute(
                sql,
                (f"%{search_keyword}%", f"%{filter_keyword_in_title}%")
            )
            rows = cursor.fetchall()

    # åˆ†çµ„ï¼šä¾ title å°æ‡‰å¤šå€‹ä¸åŒåƒ¹æ ¼
    grouped = defaultdict(set)
    for row in rows:
        grouped[row['title']].add(row['price'])

    # è¼¸å‡ºæ¯å€‹æ¨™é¡Œå°æ‡‰çš„åƒ¹æ ¼åˆ—è¡¨
    print(f"ğŸ“Š æœå°‹æ¢ä»¶ï¼šsearch_keyword å«ã€{search_keyword}ã€ï¼Œtitle å«ã€{filter_keyword_in_title}ã€\n")
    for title, prices in grouped.items():
        print(f"ğŸ”¹ æ¨™é¡Œ: {title}")
        for price in sorted(prices):
            print(f"   - åƒ¹æ ¼: {price}")
        print("-" * 50)
    ```

<br>

2. è¼¸å‡ºã€‚

    ```bash
    ğŸ“Š æœå°‹æ¢ä»¶ï¼šsearch_keyword å«ã€BLUE BAY å€åŠ› Senseã€ï¼Œtitle å«ã€3ç¨®é­šã€

    ğŸ”¹ æ¨™é¡Œ: BLUE BAY å€åŠ› Sense å…¨è­·ä½æ•è²“é£¼æ–™ ç¾è†šçˆ†æ¯›é…æ–¹ 3ç¨®é­š + å°ç£é±‰è›‹, çš®è†š/æ¯›é«®, 1.5kg, 1è¢‹
    - åƒ¹æ ¼: $345
    --------------------------------------------------
    ğŸ”¹ æ¨™é¡Œ: BLUE BAY å€åŠ› Sense å…¨è­·ä½æ•è²“é£¼æ–™ ç¾è†šçˆ†æ¯›é…æ–¹ 3ç¨®é­š + å°ç£é±‰è›‹, çš®è†š/æ¯›é«®, 1.5kg, 2è¢‹
    - åƒ¹æ ¼: $790
    --------------------------------------------------
    ğŸ”¹ æ¨™é¡Œ: BLUE BAY å€åŠ› Sense å…¨è­·ä½æ•è²“é£¼æ–™ ç¾è†šçˆ†æ¯›é…æ–¹ 3ç¨®é­š + å°ç£é±‰è›‹, çš®è†š/æ¯›é«®, 1.5kg, 3è¢‹
    - åƒ¹æ ¼: $1,235
    --------------------------------------------------
    ğŸ”¹ æ¨™é¡Œ: BLUE BAY å€åŠ› Sense å…¨è­·ä½æ•è²“é£¼æ–™ ç¾è†šçˆ†æ¯›é…æ–¹ 3ç¨®é­š + å°ç£é±‰è›‹, çš®è†š/æ¯›é«®, 1.5kg, 4è¢‹
    - åƒ¹æ ¼: $1,680
    --------------------------------------------------
    ```

<br>

3. åˆ—å‡ºåƒ¹æ ¼æœ‰å…©ç¨®ä»¥ä¸Šè€…ã€‚

    ```python
    import pymysql
    import os
    from dotenv import load_dotenv
    from collections import defaultdict

    # è¼‰å…¥è¨­å®š
    load_dotenv()
    db_config = {
        "host": os.getenv("DB_HOST"),
        "port": int(os.getenv("DB_PORT", 3306)),
        "user": os.getenv("DB_USER"),
        "password": os.getenv("DB_PASSWORD"),
        "database": os.getenv("DB_NAME")
    }

    # æŸ¥è©¢æ¢ä»¶
    search_keyword = "BLUE BAY å€åŠ› Sense"
    # é€²éšç¯©é¸é—œéµå­—åˆ—è¡¨ï¼Œé‚è¼¯æ¢ä»¶æ˜¯äº¤é›†å‡ºç¾åœ¨ title ä¸­
    filter_keywords_in_title = ["3ç¨®é­š"]

    # SQL æŸ¥è©¢ï¼Œä¸å«é€²éšç¯©é¸
    sql = """
        SELECT title, price, timestamp
        FROM coupang_products
        WHERE search_keyword LIKE %s
        ORDER BY title, timestamp
    """

    # å»ºç«‹é€£ç·šä¸¦æŸ¥è©¢
    connection = pymysql.connect(
        host=db_config["host"],
        port=db_config["port"],
        user=db_config["user"],
        password=db_config["password"],
        database=db_config["database"],
        charset='utf8mb4',
        cursorclass=pymysql.cursors.DictCursor
    )

    with connection:
        with connection.cursor() as cursor:
            cursor.execute(sql, (f"%{search_keyword}%",))
            rows = cursor.fetchall()

    # é€²éšç¯©é¸ï¼štitle åŒæ™‚åŒ…å«æ‰€æœ‰é—œéµå­—
    def is_match_advanced(title: str, keywords: list[str]) -> bool:
        return all(kw in title for kw in keywords)

    # éæ¿¾ rows
    if filter_keywords_in_title:
        rows = [r for r in rows if is_match_advanced(r['title'], filter_keywords_in_title)]

    # åˆ†çµ„ï¼šä¾ title å°æ‡‰å¤šç­† (åƒ¹æ ¼ï¼Œæ™‚é–“)
    grouped = defaultdict(list)
    for row in rows:
        grouped[row['title']].append((row['price'], row['timestamp']))

    # åƒ…ä¿ç•™æœ‰å…©ç¨®ä»¥ä¸Šåƒ¹æ ¼çš„ titleï¼Œæ ¹æ“šåƒ¹æ ¼ç¨®é¡å»é‡
    filtered_grouped = {
        title: entries
        for title, entries in grouped.items()
        if len(set(price for price, _ in entries)) >= 2
    }

    # è¼¸å‡ºçµæœ
    print(f"æœå°‹æ¢ä»¶ï¼šsearch_keyword å«ã€{search_keyword}ã€")
    if filter_keywords_in_title:
        print(
            "é€²éšæ¢ä»¶ï¼štitle åŒæ™‚åŒ…å«"
            f"ã€{'ã€'.join(filter_keywords_in_title)}ã€\n"
        )
    # å¤šç­†åƒ¹æ ¼è³‡è¨Š
    if not filtered_grouped:
        print("âš ï¸ æŸ¥ç„¡é‡è¤‡åƒ¹æ ¼è®ŠåŒ–çš„é …ç›®")
    else:
        for title, records in filtered_grouped.items():
            print(f"ğŸ”¹ æ¨™é¡Œï¼š{title}")
            for price, timestamp in sorted(records, key=lambda x: x[1]):
                print(f"   - åƒ¹æ ¼ï¼š{price}ï¼ˆæ™‚é–“ï¼š{timestamp}ï¼‰")
            print("-" * 60)
    ```

<br>

4. è¼¸å‡ºã€‚

    ```bash
    æœå°‹æ¢ä»¶ï¼šsearch_keyword å«ã€BLUE BAY å€åŠ› Senseã€
    é€²éšæ¢ä»¶ï¼štitle åŒæ™‚åŒ…å«ã€3ç¨®é­šã€

    ğŸ”¹ æ¨™é¡Œï¼šBLUE BAY å€åŠ› Sense å…¨è­·ä½æ•è²“é£¼æ–™ ç¾è†šçˆ†æ¯›é…æ–¹ 3ç¨®é­š + å°ç£é±‰è›‹, çš®è†š/æ¯›é«®, 1.5kg, 1è¢‹
    - åƒ¹æ ¼ï¼š$345ï¼ˆæ™‚é–“ï¼š2025-05-12 02:20:02ï¼‰
    - åƒ¹æ ¼ï¼š$345ï¼ˆæ™‚é–“ï¼š2025-05-12 02:23:24ï¼‰
    - åƒ¹æ ¼ï¼š$345ï¼ˆæ™‚é–“ï¼š2025-05-12 02:26:48ï¼‰
    - åƒ¹æ ¼ï¼š$345ï¼ˆæ™‚é–“ï¼š2025-05-12 02:27:55ï¼‰
    - åƒ¹æ ¼ï¼š$345ï¼ˆæ™‚é–“ï¼š2025-05-12 02:37:14ï¼‰
    - åƒ¹æ ¼ï¼š$345ï¼ˆæ™‚é–“ï¼š2025-05-12 02:37:31ï¼‰
    - åƒ¹æ ¼ï¼š$345ï¼ˆæ™‚é–“ï¼š2025-05-12 02:37:32ï¼‰
    - åƒ¹æ ¼ï¼š$279ï¼ˆæ™‚é–“ï¼š2025-05-17 19:48:13ï¼‰
    - åƒ¹æ ¼ï¼š$341ï¼ˆæ™‚é–“ï¼š2025-05-17 20:06:34ï¼‰
    ------------------------------------------------------------
    # å…¶é¤˜çœç•¥...
    ------------------------------------------------------------
    ğŸ”¹ æ¨™é¡Œï¼šBLUE BAY å€åŠ› Sense å…¨è­·ä½æ•è²“é£¼æ–™ ç¾è†šçˆ†æ¯›é…æ–¹ 3ç¨®é­š + å°ç£é±‰è›‹, çš®è†š/æ¯›é«®, 1.5kg, 4è¢‹
    - åƒ¹æ ¼ï¼š$1,680ï¼ˆæ™‚é–“ï¼š2025-05-12 02:20:02ï¼‰
    - åƒ¹æ ¼ï¼š$1,680ï¼ˆæ™‚é–“ï¼š2025-05-12 02:23:24ï¼‰
    - åƒ¹æ ¼ï¼š$1,680ï¼ˆæ™‚é–“ï¼š2025-05-12 02:26:48ï¼‰
    - åƒ¹æ ¼ï¼š$1,680ï¼ˆæ™‚é–“ï¼š2025-05-12 02:27:55ï¼‰
    - åƒ¹æ ¼ï¼š$1,680ï¼ˆæ™‚é–“ï¼š2025-05-12 02:37:14ï¼‰
    - åƒ¹æ ¼ï¼š$1,680ï¼ˆæ™‚é–“ï¼š2025-05-12 02:37:31ï¼‰
    - åƒ¹æ ¼ï¼š$1,680ï¼ˆæ™‚é–“ï¼š2025-05-12 02:37:32ï¼‰
    - åƒ¹æ ¼ï¼š$1,416ï¼ˆæ™‚é–“ï¼š2025-05-17 19:48:13ï¼‰
    - åƒ¹æ ¼ï¼š$1,466ï¼ˆæ™‚é–“ï¼š2025-05-17 20:06:34ï¼‰
    ------------------------------------------------------------
    ```

<br>

___

_END_