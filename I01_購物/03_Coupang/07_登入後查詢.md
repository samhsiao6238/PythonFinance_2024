# 登入

_由於 Coupang 對於新加入會員有首購優惠，所以使用 Selenium 進行爬取數據時，所得到的價格是 `新手優惠的價格`，的這並非實際可買到的價格；以下將進行代碼優化，在取得數據資錢，先進行會員登入再查詢，如此便可排除前述的錯誤。_

<br>

## 登入測試

_需提供 `Coupang` 的帳號與密碼_

<br>

1. 將帳號密碼等敏感資訊加入 `.env` 文件中。

    ```bash
    COUPANG_EMAIL=<酷澎帳號>
    COUPANG_PASSWORD=<酷澎密碼>
    ```

<br>

2. 進行登入測試；以下暫時關閉啟動選項中的 `無頭模式` 設定，用以觀察瀏覽器開啟網頁後是否正確登入會員帳號，同時也將 `driver.quit()` 註解用以觀察頁面。

    ```python

    from selenium import webdriver
    from selenium.webdriver.common.by import By
    from selenium.webdriver.chrome.service import Service
    from selenium.webdriver.chrome.options import Options
    from webdriver_manager.chrome import ChromeDriverManager
    import time

    # 處理敏感資訊
    from dotenv import load_dotenv
    import os

    load_dotenv()
    EMAIL = os.getenv("COUPANG_EMAIL")
    PASSWORD = os.getenv("COUPANG_PASSWORD")

    options = Options()
    # 無頭
    # options.add_argument("--headless=new")
    options.add_argument("--disable-gpu")
    options.add_argument("--no-sandbox")
    options.add_argument("--lang=zh-TW")

    driver = webdriver.Chrome(
        service=Service(ChromeDriverManager().install()),
        options=options
    )
    driver.get("https://member.tw.coupang.com/login/login.pang")
    # 等待兩秒，確保頁面加載完成
    time.sleep(2)

    # 輸入帳號
    email_input = driver.find_element(
        By.ID, "login-email-input"
    )
    email_input.send_keys(EMAIL)

    # 輸入密碼
    password_input = driver.find_element(
        By.ID, "login-password-input"
    )
    password_input.send_keys(PASSWORD)

    # 點擊登入按鈕
    login_button = driver.find_element(
        By.CLASS_NAME, "login__button--submit"
    )
    login_button.click()

    # 等待跳轉
    time.sleep(5)

    # 可自行接著進入訂單頁、商品頁
    print("✅ 登入流程已觸發")
    # 結束時再關閉瀏覽器
    # driver.quit()
    ```

    ![](images/img_09.png)

<br>

3. 對於可能出現的警告彈窗無需理會，不會影響後續進行。

    ![](images/img_02.png)

<br>

## 整合查詢

_確認帳號可正確登入後，繼續以下步驟_

<br>

1. 登入後進行查詢。

    ```python
    from selenium import webdriver
    from selenium.webdriver.common.by import By
    from selenium.webdriver.chrome.service import Service
    from selenium.webdriver.chrome.options import Options
    from webdriver_manager.chrome import ChromeDriverManager
    from bs4 import BeautifulSoup
    from urllib.parse import quote
    import time
    from dotenv import load_dotenv
    import os

    # 敏感資訊
    load_dotenv()
    EMAIL = os.getenv("COUPANG_EMAIL")
    PASSWORD = os.getenv("COUPANG_PASSWORD")

    options = Options()
    # 無頭模式
    options.add_argument("--headless=new")
    options.add_argument("--disable-gpu")
    options.add_argument("--no-sandbox")
    options.add_argument("--lang=zh-TW")

    # 共用 driver（登入後重用）
    driver = webdriver.Chrome(
        service=Service(ChromeDriverManager().install()),
        options=options
    )

    # === 登入流程 ===
    driver.get("https://member.tw.coupang.com/login/login.pang")
    time.sleep(2)

    email_input = driver.find_element(
        By.ID, "login-email-input"
    )
    email_input.send_keys(EMAIL)

    password_input = driver.find_element(
        By.ID, "login-password-input"
    )
    password_input.send_keys(PASSWORD)

    login_button = driver.find_element(
        By.CLASS_NAME, "login__button--submit"
    )
    login_button.click()
    time.sleep(5)

    print("✅ 已登入 Coupang")


    def get_coupang_search_results(driver, search_keyword: str, advanced_keywords: list[str]):
        encoded_keyword = quote(search_keyword)
        url = f"https://www.tw.coupang.com/search?q={encoded_keyword}&channel=user"
        driver.get(url)
        time.sleep(5)

        html = driver.page_source

        # 若需重複操作瀏覽器可先保留不關閉
        driver.quit()

        soup = BeautifulSoup(html, "html.parser")
        product_cards = soup.select(
            "div.SearchResult_searchResultProduct___h6E9"
        )

        results = []
        matched_results = []

        for card in product_cards:
            try:
                full_text = card.get_text(separator=" ", strip=True)

                title_tag = card.select_one("div.Product_title__8K0xk")
                title = title_tag.get_text(strip=True) if title_tag else "N/A"

                price_tag = card.select_one("span.Product_salePricePrice__2FbsL span")
                price = price_tag.get_text(strip=True) if price_tag else "N/A"

                unit_price_tag = card.select_one("div.Product_unitPrice__QQPdR")
                unit_price = unit_price_tag.get_text(strip=True) if unit_price_tag else "N/A"

                product = {
                    "title": title,
                    "full_text": full_text,
                    "price": price,
                    "unit_price": unit_price
                }

                results.append(product)

                if all(kw in full_text for kw in advanced_keywords):
                    matched_results.append(product)

            except Exception as e:
                print("解析錯誤：", e)
                continue

        return results, matched_results


    if __name__ == "__main__":
        # 關鍵字搜尋
        search_keyword = "味丹 氣泡水"
        # 針對結果進階篩選
        advanced_keywords = ["檸檬風味"]

        all_products, filtered_products = get_coupang_search_results(
            driver,
            search_keyword, 
            advanced_keywords
        )

        driver.quit()
        # 輸出關鍵字
        print(f"搜尋關鍵字：{search_keyword}")

        # 完整查詢結果，若不想查看可進行註解
        for idx, product in enumerate(all_products, 1):
            print(f"{idx}. 標題: {product['title']}")
            print(f"   價格: {product['price']}")
            print(f"   每單位: {product['unit_price']}")
            print(f"   完整內容: {product['full_text']}")
            print("-" * 60)

        # 進階查詢
        print(f"\n進階條件符合項目（包含：{'、'.join(advanced_keywords)}）：")
        for idx, product in enumerate(filtered_products, 1):
            print(f"{idx}. 標題: {product['title']}")
            print(f"   價格: {product['price']}")
            print(f"   每單位: {product['unit_price']}")
            print(f"   完整內容: {product['full_text']}")
            print("-" * 60)
    ```

<br>

2. 優化代碼，當 `進階搜尋` 列表為空的時候，不需要顯示進階搜尋結果。

```python


___

_END_