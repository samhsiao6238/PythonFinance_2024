# ç¶²é æŸ¥è©¢

<br>

## ç’°å¢ƒ

1. å®‰è£ã€‚

    ```bash
    pip install flask
    ```

<br>

2. å»ºç«‹å°ˆæ¡ˆçµæ§‹ã€‚

    ```bash
    mkdir -p coupang_webapp/templates && \
    touch coupang_webapp/app.py coupang_webapp/.env coupang_webapp/.gitignore coupang_webapp/templates/index.html && \
    echo "âœ… å°ˆæ¡ˆç›®éŒ„å·²å»ºç«‹ï¼šcoupang_webapp/"
    ```

<br>

3. å¯é€éæŒ‡ä»¤æŸ¥è©¢ã€‚

    ```bash
    cd coupang_webapp && tree
    ```

<br>

4. ç·¨è¼¯ `.env` åŠ `.gitignore`ï¼Œè«‹åƒè€ƒå‰é¢ç›¸åŒçš„æ­¥é©Ÿï¼Œæ­¤è™•ä¸å†è´…è¿°ã€‚

<br>

## ä»£ç¢¼

1. ç·¨è¼¯ `app.py`ã€‚

    ```python
    from flask import Flask, request, jsonify, render_template
    import pymysql
    import os
    from dotenv import load_dotenv

    # è¼‰å…¥ .env è¨­å®š
    load_dotenv()

    app = Flask(__name__)

    # è³‡æ–™åº«é€£ç·šåƒæ•¸
    DB_CONFIG = {
        "host": os.getenv("DB_HOST"),
        "port": int(os.getenv("DB_PORT", 3306)),
        "user": os.getenv("DB_USER"),
        "password": os.getenv("DB_PASSWORD"),
        "database": os.getenv("DB_NAME"),
        "charset": "utf8mb4",
        "cursorclass": pymysql.cursors.DictCursor,
    }


    @app.route("/")
    def index():
        return render_template("index.html")


    @app.route("/query", methods=["POST"])
    def query():
        data = request.get_json()
        keywords = data.get("keywords", [])

        if not keywords:
            return jsonify([])

        # å»ºç«‹è³‡æ–™åº«é€£ç·š
        connection = pymysql.connect(**DB_CONFIG)
        seen_full_text = set()
        results = []

        with connection:
            with connection.cursor() as cursor:
                sql = "SELECT title, price, unit_price, full_text, timestamp FROM coupang_products ORDER BY timestamp DESC"
                cursor.execute(sql)
                rows = cursor.fetchall()

                for row in rows:
                    full_text = row["full_text"]
                    if all(kw in full_text for kw in keywords):
                        if full_text in seen_full_text:
                            continue
                        seen_full_text.add(full_text)
                        results.append(row)

        return jsonify(results)


    if __name__ == "__main__":
        app.run(debug=True)
    ```

<br>

2. ç·¨è¼¯ `index.html`ã€‚

    ```html
    <!DOCTYPE html>
    <html lang="zh-Hant">

    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Coupang å•†å“é€²éšæŸ¥è©¢</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
            .remove-btn {
                cursor: pointer;
                color: red;
                margin-left: 10px;
            }
        </style>
    </head>

    <body>
        <div class="container py-5">
            <h2 class="mb-4">ğŸ” Coupang å•†å“é€²éšæŸ¥è©¢</h2>

            <form id="query-form">
                <div id="keyword-fields" class="mb-3">
                    <label class="form-label">è«‹è¼¸å…¥æŸ¥è©¢é—œéµå­—ï¼ˆæ¯æ ¼ä¸€å€‹ï¼‰</label>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control keyword" placeholder="ä¾‹å¦‚ï¼šå‘³ä¸¹ å¤šå–æ°´">
                        <span class="input-group-text btn btn-outline-secondary" onclick="addKeywordField()">ï¼‹</span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">æŸ¥è©¢</button>
            </form>

            <hr>

            <div id="results" class="mt-4">
                <h5 class="mb-3">æŸ¥è©¢çµæœï¼š</h5>
                <div id="output"></div>
            </div>
        </div>

        <script>
            function addKeywordField() {
                const container = document.getElementById("keyword-fields");
                const div = document.createElement("div");
                div.className = "input-group mb-2";
                div.innerHTML = `
            <input type="text" class="form-control keyword" placeholder="è«‹è¼¸å…¥é—œéµå­—">
            <span class="input-group-text btn btn-outline-danger" onclick="removeField(this)">ï¼</span>
        `;
                container.appendChild(div);
            }

            function removeField(btn) {
                btn.parentNode.remove();
            }

            document.getElementById("query-form").addEventListener("submit", async function (event) {
                event.preventDefault();
                const inputs = document.querySelectorAll(".keyword");
                const keywords = Array.from(inputs)
                    .map(input => input.value.trim())
                    .filter(Boolean);

                if (keywords.length === 0) {
                    alert("è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹é—œéµå­—ï¼");
                    return;
                }

                const res = await fetch("/query", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ keywords })
                });

                const data = await res.json();
                const output = document.getElementById("output");
                output.innerHTML = "";

                if (data.length === 0) {
                    output.innerHTML = '<p class="text-muted">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚</p>';
                } else {
                    data.forEach(item => {
                        const card = document.createElement("div");
                        card.className = "card mb-3";
                        card.innerHTML = `
                            <div class="card-body">
                            <h5 class="card-title">${item.title}</h5>
                            <p class="card-text">åƒ¹æ ¼ï¼š${item.price} ï½œ æ¯å–®ä½ï¼š${item.unit_price}</p>
                            <p class="card-text text-muted small">å®Œæ•´å…§å®¹ï¼š${item.full_text}</p>
                            <p class="card-text text-end"><small class="text-muted">æ™‚é–“ï¼š${item.timestamp}</small></p>
                            </div>
                        `;
                        output.appendChild(card);
                    });
                }
            });
        </script>
    </body>

    </html>
    ```

<br>

3. é‹è¡Œè…³æœ¬

    ```bash
    python app.py
    ```

<br>

4. è¼¸å…¥é—œéµå­— `å‘³ä¸¹`ã€`å¤šå–æ°´`ã€`æª¸æª¬`ã€‚

    ![](images/img_01.png)

<br>

___

_END_