# æ­·å²é—œéµå­—è³‡æ–™åº«æŸ¥è©¢

_æå–æ­·å²æŸ¥è©¢é—œéµå­—åˆ—è¡¨ï¼Œä¸¦å¾æœ¬åœ°è³‡æ–™åº«ä¸­æŸ¥è©¢æ•¸æ“š_

## èªªæ˜

1. ä»£ç¢¼ã€‚

```python
# å°å…¥åº«
import os
import time
import pymysql
from dotenv import load_dotenv
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager
from bs4 import BeautifulSoup
from urllib.parse import quote
from datetime import datetime
from collections import defaultdict

# è¼‰å…¥ç’°å¢ƒè®Šæ•¸
load_dotenv()
EMAIL = os.getenv("COUPANG_EMAIL")
PASSWORD = os.getenv("COUPANG_PASSWORD")

# è³‡æ–™åº«
DB_CONFIG = {
    "host": os.getenv("DB_HOST"),
    "port": int(os.getenv("DB_PORT", 3306)),
    "user": os.getenv("DB_USER"),
    "password": os.getenv("DB_PASSWORD"),
    "database": os.getenv("DB_NAME")
}

# å¾è³‡æ–™åº«æå–æ‰€æœ‰ä¸é‡è¤‡çš„æœå°‹é—œéµå­—
def fetch_distinct_keywords(db_config):
    conn = pymysql.connect(
        host=db_config["host"],
        port=db_config["port"],
        user=db_config["user"],
        password=db_config["password"],
        database=db_config["database"],
        charset="utf8mb4",
        cursorclass=pymysql.cursors.DictCursor
    )
    with conn:
        with conn.cursor() as cursor:
            cursor.execute("""
                SELECT DISTINCT search_keyword FROM coupang_products
                WHERE search_keyword IS NOT NULL AND search_keyword <> ''
            """)
            return [row["search_keyword"] for row in cursor.fetchall()]

# æŸ¥è©¢åˆ†æå‡½æ•¸ï¼ˆä¾æ¯å€‹é—œéµå­—åˆ—å‡ºåƒ¹æ ¼ç•°å‹•å•†å“ï¼‰
def analyze_keyword(keyword, db_config):
    conn = pymysql.connect(
        host=db_config["host"],
        port=db_config["port"],
        user=db_config["user"],
        password=db_config["password"],
        database=db_config["database"],
        charset='utf8mb4',
        cursorclass=pymysql.cursors.DictCursor
    )
    sql = """
        SELECT title, price, timestamp, source_type
        FROM coupang_products
        WHERE search_keyword LIKE %s AND source_type = 'login'
        ORDER BY title, timestamp
    """

    with conn:
        with conn.cursor() as cursor:
            cursor.execute(sql, (f"%{keyword}%",))
            rows = cursor.fetchall()

    # å»é™¤ (title, timestamp) é‡è¤‡
    grouped = defaultdict(list)
    seen = set()
    for row in rows:
        key = (row['title'], row['timestamp'])
        if key in seen:
            continue
        seen.add(key)
        grouped[row['title']].append((row['price'], row['timestamp'], row['source_type'] or "guest"))

    # æ‹†åˆ†ï¼šæœ‰åƒ¹æ ¼ç•°å‹•çš„èˆ‡åªæœ‰å–®ä¸€åƒ¹æ ¼çš„
    multi_price_grouped = {}
    single_price_grouped = {}
    for title, entries in grouped.items():
        prices = set(price for price, _, _ in entries)
        if len(prices) >= 2:
            multi_price_grouped[title] = entries
        elif len(prices) == 1:
            single_price_grouped[title] = entries

    # è¼¸å‡º
    print(f"\nğŸ“Œ é—œéµå­—ï¼šã€{keyword}ã€")

    if not multi_price_grouped and not single_price_grouped:
        print("âš ï¸ ç„¡ç›¸é—œè³‡æ–™")
        return

    if multi_price_grouped:
        print("\nğŸ“ˆ ç™¼ç¾åƒ¹æ ¼ç•°å‹•ï¼š")
        for title, records in multi_price_grouped.items():
            print(f"ğŸ”¹ æ¨™é¡Œï¼š{title}")
            for price, timestamp, source in sorted(records, key=lambda x: x[1]):
                print(f"   - åƒ¹æ ¼ï¼š{price}ï¼ˆæ™‚é–“ï¼š{timestamp}ï¼Œä¾†æºï¼š{source}ï¼‰")
            print("-" * 60)

    if single_price_grouped:
        print("\nğŸ“Œ åƒ…å‡ºç¾å–®ä¸€åƒ¹æ ¼ï¼š")
        for title, records in single_price_grouped.items():
            price, timestamp, source = records[0]
            print(f"ğŸ”¸ æ¨™é¡Œï¼š{title}\n   - åƒ¹æ ¼ï¼š{price}ï¼ˆæ™‚é–“ï¼š{timestamp}ï¼Œä¾†æºï¼š{source}ï¼‰")
        print("-" * 60)

# ä¸»ç¨‹å¼
if __name__ == "__main__":
    keywords = fetch_distinct_keywords(DB_CONFIG)
    if not keywords:
        print("âš ï¸ æŸ¥ç„¡æ­·å²é—œéµå­—")
        exit()

    print(f"ğŸ” å…±ç™¼ç¾ {len(keywords)} çµ„æ­·å²é—œéµå­—ï¼Œé–‹å§‹åˆ†æ...")

    for idx, kw in enumerate(keywords, 1):
        print(f"\n[{idx}] åˆ†æé—œéµå­—ï¼š{kw}")
        analyze_keyword(kw, DB_CONFIG)
```

## èªªæ˜

1. é—œæ–¼ `åƒ¹æ ¼ç•°å‹•` èˆ‡ `åƒ…æœ‰å–®ä¸€åƒ¹æ ¼` çš„åˆ¤æ–·é‚è¼¯å¦‚ä¸‹ã€‚


```python
# å°æ¯å€‹å•†å“æ¨™é¡Œ `title`ï¼Œå°‡å®ƒæ‰€æœ‰æ­·æ¬¡ç´€éŒ„ä¸­çš„ `price` æ”¶é›†æˆä¸€å€‹ `set`
# å› ç‚º `set` æœƒè‡ªå‹•å»é™¤é‡è¤‡ï¼Œæ‰€ä»¥ `len(prices)` ä»£è¡¨çš„æ˜¯ `ä¸åŒåƒ¹æ ¼çš„æ•¸é‡`
prices = set(price for price, _, _ in entries)
# åªè¦é€™å€‹å•†å“æœ‰éå…©ç­†ä»¥ä¸Šä¸åŒåƒ¹æ ¼çš„ç´€éŒ„å°±è¦–ç‚ºç™¼ç”Ÿéåƒ¹æ ¼ç•°å‹•
if len(prices) >= 2:
    multi_price_grouped[title] = entries
```

2. åŒç†ï¼Œåƒ…æœ‰å–®ä¸€åƒ¹æ ¼å°±æ˜¯åƒ¹æ ¼æ•¸æ“šçš„é›†åˆæˆå“¡ç‚º `1`ã€‚

```python
elif len(prices) == 1:
    single_price_grouped[title] = entries
```

3. å¦å¤–ï¼Œåœ¨åˆ¤æ–·æ˜¯å¦ç•°å‹•ä¹‹å‰ï¼Œæœƒå…ˆæ’é™¤é‡è¤‡çš„ `(title, timestamp)` çµ„åˆï¼Œé‚è¼¯ä¸Šå°±æ˜¯æŸå•†å“æ¨™é¡Œ `title` åœ¨åŒä¸€å€‹ `timestamp` æ™‚é–“æˆ³è¢«è¨˜éŒ„å¤šæ¬¡ï¼Œåªä¿ç•™ç¬¬ä¸€ç­†ã€‚

```python
key = (row['title'], row['timestamp'])
if key in seen:
    continue
seen.add(key)
```

### ğŸ§  ç¸½çµï¼š

| é¡åˆ¥      | åˆ¤æ–·æ¨™æº–                     | èªªæ˜    |
| ------- | ------------------------ | ----- |
| ğŸ“ˆ åƒ¹æ ¼ç•°å‹• | åŒä¸€å•†å“æ¨™é¡Œå°æ‡‰ **å…©ç¨®ä»¥ä¸Šä¸åŒåƒ¹æ ¼**    | æœ‰å¯¦è³ªè®ŠåŒ– |
| ğŸ“Œ å–®ä¸€åƒ¹æ ¼ | åŒä¸€å•†å“æ¨™é¡Œå°æ‡‰ **åªæœ‰ä¸€ç¨®åƒ¹æ ¼**ï¼ˆå¯é‡è¤‡ï¼‰ | ç„¡åƒ¹æ ¼ç•°å‹• |

å¦‚éœ€é€²ä¸€æ­¥ç´å…¥ã€Œæ¯ç­†ç´€éŒ„çš„ç­†æ•¸ã€æˆ–ã€Œä¾†æºæ•¸é‡çµ±è¨ˆã€ä¹Ÿå¯é¡å¤–æ“´å……ã€‚æ˜¯å¦éœ€è¦ï¼Ÿ
