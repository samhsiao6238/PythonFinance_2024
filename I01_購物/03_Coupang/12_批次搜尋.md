# æ‰¹æ¬¡æœå°‹

_æ‰¹æ¬¡æœå°‹å¤šå€‹é …ç›®ä¸¦å¯«å…¥è³‡æ–™åº«_

<br>

## èªªæ˜

1. å°‡åŸæœ¬çš„å–®ä¸€ `keyword` æŸ¥è©¢é‚è¼¯ï¼Œå„ªåŒ–ç‚ºæ‰¹æ¬¡æŸ¥è©¢å¤šå€‹é—œéµå­—æ¸…å–®ï¼Œä¸¦çµ±ä¸€ç”¨ä¸€å€‹ `driver` åŸ·è¡Œç™»å…¥èˆ‡æ“ä½œï¼Œç¯€çœè³‡æºèˆ‡æ™‚é–“ã€‚

    ```python
    # å°å…¥åº«
    import os
    import time
    import pymysql
    from dotenv import load_dotenv
    from selenium import webdriver
    from selenium.webdriver.common.by import By
    from selenium.webdriver.chrome.service import Service
    from selenium.webdriver.chrome.options import Options
    from webdriver_manager.chrome import ChromeDriverManager
    from bs4 import BeautifulSoup
    from urllib.parse import quote
    from datetime import datetime

    # è¼‰å…¥ç’°å¢ƒè®Šæ•¸
    load_dotenv()
    EMAIL = os.getenv("COUPANG_EMAIL")
    PASSWORD = os.getenv("COUPANG_PASSWORD")

    # è³‡æ–™åº«
    DB_CONFIG = {
        "host": os.getenv("DB_HOST"),
        "port": int(os.getenv("DB_PORT", 3306)),
        "user": os.getenv("DB_USER"),
        "password": os.getenv("DB_PASSWORD"),
        "database": os.getenv("DB_NAME")
    }

    # ç™»å…¥ä¸¦å–å¾— driver
    def login_and_get_driver(email, password):
        options = Options()
        # æš«æ™‚è¨»è§£å¯ç”¨æ–¼è§€å¯Ÿ
        # options.add_argument("--headless=new")
        options.add_argument("--disable-gpu")
        options.add_argument("--no-sandbox")
        options.add_argument("--lang=zh-TW")

        driver = webdriver.Chrome(
            service=Service(ChromeDriverManager().install()),
            options=options
        )

        # ç™»å…¥
        driver.get("https://member.tw.coupang.com/login/login.pang")
        time.sleep(2)
        driver.find_element(By.ID, "login-email-input").send_keys(email)
        driver.find_element(By.ID, "login-password-input").send_keys(password)
        driver.find_element(By.CLASS_NAME, "login__button--submit").click()
        time.sleep(5)
        print("âœ… ç™»å…¥æˆåŠŸ")
        return driver

    # è‡ªè¨‚å‡½æ•¸ï¼›å–®ä¸€é—œéµå­—æœå°‹
    def get_search_results(driver, keyword, max_pages=5):
        encoded = quote(keyword)
        now = datetime.now()
        results = []

        for page in range(1, max_pages + 1):
            url = f"https://www.tw.coupang.com/search?q={encoded}&channel=user&page={page}"
            driver.get(url)
            time.sleep(5)

            soup = BeautifulSoup(driver.page_source, "html.parser")
            cards = soup.select("div.SearchResult_searchResultProduct___h6E9")

            if not cards:
                print(f"âš ï¸ ç¬¬ {page} é ç„¡è³‡æ–™ï¼Œåœæ­¢ç¿»é ã€‚")
                break

            for card in cards:
                try:
                    full_text = card.get_text(" ", strip=True)
                    title = card.select_one("div.Product_title__8K0xk")
                    price = card.select_one("span.Product_salePricePrice__2FbsL span")
                    unit_price = card.select_one("div.Product_unitPrice__QQPdR")

                    results.append({
                        "search_keyword": keyword,
                        "title": title.get_text(strip=True) if title else "N/A",
                        "full_text": full_text,
                        "price": price.get_text(strip=True) if price else "N/A",
                        "unit_price": unit_price.get_text(strip=True) if unit_price else "N/A",
                        "timestamp": now,
                        "source_type": "login"
                    })
                except Exception as e:
                    print("âŒ éŒ¯èª¤ï¼š", e)
                    continue
            print(f"âœ… ç¬¬ {page} é æ“·å–å®Œæˆï¼Œå…± {len(cards)} ç­†")
        return results


    # è‡ªè¨‚å‡½æ•¸ï¼›å¯«å…¥è³‡æ–™åº«
    def insert_into_db(data_list, db_config):
        conn = pymysql.connect(
            host=db_config["host"],
            port=db_config["port"],
            user=db_config["user"],
            password=db_config["password"],
            database=db_config["database"],
            charset="utf8mb4"
        )

        with conn:
            with conn.cursor() as cursor:
                cursor.execute("SHOW COLUMNS FROM coupang_products LIKE 'source_type';")
                if not cursor.fetchone():
                    cursor.execute("ALTER TABLE coupang_products ADD COLUMN source_type VARCHAR(20) NULL;")

                cursor.execute("""
                    CREATE TABLE IF NOT EXISTS coupang_products (
                        id INT AUTO_INCREMENT PRIMARY KEY,
                        search_keyword VARCHAR(255),
                        title TEXT,
                        full_text TEXT,
                        price VARCHAR(50),
                        unit_price VARCHAR(50),
                        timestamp DATETIME,
                        source_type VARCHAR(20) NULL
                    );
                """)

                for item in data_list:
                    cursor.execute("""
                        INSERT INTO coupang_products
                        (search_keyword, title, full_text, price, unit_price, timestamp, source_type)
                        VALUES (%s, %s, %s, %s, %s, %s, %s);
                    """, (
                        item["search_keyword"],
                        item["title"],
                        item["full_text"],
                        item["price"],
                        item["unit_price"],
                        item["timestamp"],
                        item.get("source_type")
                    ))
            conn.commit()
        print("âœ… å·²å¯«å…¥è³‡æ–™åº«")


    # ä¸»ç¨‹å¼ï¼Œå¤šé—œéµå­—æ‰¹æ¬¡è™•ç†
    if __name__ == "__main__":
        
        keywords = [
            "BLUE BAY å€åŠ› Animate",
            "BLUE BAY å€åŠ› Sense",
            "INABA CIAO å•¾åš•",
            "å‘³ä¸¹ MOREæ°£æ³¡æ°´"
        ]

        driver = login_and_get_driver(EMAIL, PASSWORD)
        all_results = []

        for keyword in keywords:
            print(f"\nğŸ” æœå°‹ï¼š{keyword}")
            results = get_search_results(driver, keyword, max_pages=5)
            all_results.extend(results)

        driver.quit()

        if all_results:
            for idx, r in enumerate(all_results, 1):
                print(f"{idx}. {r['title']} - {r['price']} - {r['unit_price']} - ä¾†æº: {r.get('source_type')}")
            insert_into_db(all_results, DB_CONFIG)
        else:
            print("âš ï¸ æŸ¥ç„¡çµæœ")
    ```

<br>

2. æœƒä¾åºæœå°‹ä¸¦é¡¯ç¤ºé æ•¸ï¼Œæœ€å¾Œæ‰é¡¯ç¤ºçµæœï¼›ç‰¹åˆ¥æ³¨æ„ï¼Œé€™äº›è¼¸å‡ºéƒ½æ˜¯åœ¨æ¸¬è©¦éšæ®µæ‰éœ€è¦ä½¿ç”¨ï¼Œæ­£å¼éšæ®µå»ºè­°åœç”¨ã€‚

    ![](images/img_14.png)

<br>

## ä¸»è¦è®Šæ›´

1. æ”¯æ´å¤šç­†é—œéµå­—ï¼ŒåŠ å…¥ `keywords = [...]`ï¼Œfor è¿´åœˆé€ä¸€æŸ¥è©¢ã€‚

<br>

2. æ•´åˆæœå°‹çµæœï¼Œå°‡æ¯æ¬¡ `results` ç´¯åŠ åˆ° `all_results`ã€‚

<br>

3. å…±ç”¨ driverï¼Œä¸€æ¬¡ç™»å…¥å¾Œé‡è¤‡ä½¿ç”¨ driverï¼Œä¸é‡è¤‡å•Ÿå‹•ç€è¦½å™¨ã€‚

<br>

4. source\_type å¯«å…¥ï¼Œç¢ºä¿ `"login"` ä½œç‚ºæ¬„ä½å„²å­˜ä¸¦å¯«å…¥è³‡æ–™åº«ã€‚

<br>

5. å®‰å…¨å¯«å…¥æ¬„ä½ï¼Œæª¢æŸ¥ `source_type` æ¬„ä½æ˜¯å¦å­˜åœ¨ï¼Œè‡ªå‹•æ–°å¢ã€‚

<br>

6. å¦‚æœ‰ç‰¹å®šæœå°‹ç¯„åœæ¯ç­†åªæŠ“å‰ 2 é ï¼Œå¯ä¿®æ”¹ `max_pages=2` å³å¯ï¼›å¦‚éœ€å†åŠ é€Ÿï¼Œä¹Ÿå¯æ•´åˆå¤šåŸ·è¡Œç·’ã€éåŒæ­¥åŒ–é€²è¡Œã€‚

<br>

## å„ªåŒ–è¼¸å‡º

1. å°‡è¼¸å‡ºä¾æ“š `é—œéµå­—` åˆ†çµ„å¾Œé‡æ–°ç·¨è™Ÿä»¥æå‡å¯è®€æ€§ã€‚

    ```python
    # ä¸»ç¨‹å¼ï¼Œå¤šé—œéµå­—æ‰¹æ¬¡è™•ç†
    if __name__ == "__main__":
        # é—œéµå­—
        keywords = [
            "BLUE BAY å€åŠ› Animate",
            "BLUE BAY å€åŠ› Sense",
            "INABA CIAO å•¾åš•",
            "å‘³ä¸¹ MOREæ°£æ³¡æ°´"
        ]
        # é©…å‹•å™¨
        driver = login_and_get_driver(EMAIL, PASSWORD)
        all_results = []
        # å­˜æ”¾çµæœçš„é›†åˆ
        grouped_results = {}

        for keyword in keywords:
            print(f"\nğŸ” æœå°‹ï¼š{keyword}")
            results = get_search_results(driver, keyword, max_pages=5)
            if results:
                grouped_results[keyword] = results
                all_results.extend(results)
            else:
                print(f"âš ï¸ ã€{keyword}ã€æŸ¥ç„¡çµæœ")

        driver.quit()

        if all_results:
            # âœ… åˆ†çµ„è¼¸å‡ºï¼Œæ¯çµ„ç·¨è™Ÿå¾ 1 é–‹å§‹
            for keyword in grouped_results:
                print(f"\nğŸ“Œ æœå°‹é—œéµå­—ï¼š{keyword}")
                for idx, r in enumerate(grouped_results[keyword], 1):
                    print(f"{idx}. {r['title']} - {r['price']} - {r['unit_price']} - ä¾†æº: {r.get('source_type')}")
            # å­˜å…¥è³‡æ–™åº«
            insert_into_db(all_results, DB_CONFIG)
        else:
            print("âš ï¸ æŸ¥ç„¡ä»»ä½•é—œéµå­—çš„çµæœ")
    ```

<br>

2. è¼¸å‡ºå¦‚ä¸‹ï¼Œæ¯å€‹é—œéµå­—éƒ½æœƒå…ˆè¼¸å‡ºæŠ¬é ­ã€‚

    ![](images/img_16.png)

<br>

___

_END_