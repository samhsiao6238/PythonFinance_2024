# å°è£å‡½æ•¸

_ä»¥ä¸Šå®Œæˆæ ¸å¿ƒåŠŸèƒ½ `ç™»å…¥`ã€`è‡ªå‹•åŒ–çˆ¬èŸ²`ã€`è³‡æ–™åº«å¯«å…¥`ï¼Œæ¥ä¸‹ä¾†è¦é€²è¡Œæ¨¡çµ„åŒ–æ•´åˆ_

<br>

## å»ºç«‹å°ˆæ¡ˆ

1. æ¶æ§‹è¦åŠƒï¼›ä»¥ä¸‹é †åºåƒ…ä¾ç…§ç³»çµ±è¦å‰‡é¡¯ç¤ºã€‚

    ```bash
    coupang_crawler/
    â”‚
    â”œâ”€â”€ .env                    # å„²å­˜å¸³å¯†èˆ‡è³‡æ–™åº«è³‡è¨Š
    â”œâ”€â”€ .gitignore              # æ’é™¤è¦å‰‡
    â”œâ”€â”€ crawler.py              # çˆ¬èŸ²é‚è¼¯
    â”œâ”€â”€ db.py                   # è³‡æ–™åº«é€£ç·šèˆ‡å¯«å…¥
    â”œâ”€â”€ login.py                # ç™»å…¥ç›¸é—œåŠŸèƒ½
    â”œâ”€â”€ main.py                 # ä¸»ç¨‹å¼ï¼šåŒ¯ç¸½æ‰€æœ‰åŠŸèƒ½ä¸¦æ§åˆ¶æµç¨‹
    â”œâ”€â”€ main.ipynb              # æ¸¬è©¦ç”¨è…³æœ¬
    â””â”€â”€ requirements.txt        # å¥—ä»¶æ¸…å–®
    ```

<br>

2. ä½¿ç”¨æŒ‡ä»¤å»ºç«‹å°ˆæ¡ˆç›®éŒ„åŠæ‰€æœ‰æ–‡ä»¶ï¼›ä»¥ä¸‹çš„é †åºä¾å‰é …æ‰€ææ¶æ§‹æ›¸å¯«ï¼Œå®Œæˆå¾Œå°çµæœä¸¦ç„¡å½±éŸ¿ã€‚

    ```bash
    mkdir coupang_crawler && cd coupang_crawler
    touch .env .gitignore crawler.py db.py login.py main.py main.ipynb requirements.txt 
    ```

<br>

## ç·¨è¼¯è¨­å®šæ–‡ä»¶

1. åœ¨ `.gitignore` æ–‡ä»¶ä¸­æ·»åŠ è¦æ’é™¤çš„é …ç›®ã€‚

    ```bash
    .env
    ```

<br>

2. åœ¨ `.env` æ–‡ä»¶ä¸­å¯«å…¥æ•æ„Ÿè³‡è¨Šã€‚

    ```bash
    DB_HOST=<è³‡æ–™åº«-IP>
    DB_PORT=3306
    DB_NAME=<è³‡æ–™åº«åç¨±>
    DB_USER=<è³‡æ–™åº«å¸³è™Ÿ>
    DB_PASSWORD=<è³‡æ–™åº«å¯†ç¢¼>
    COUPANG_EMAIL=<é…·æ¾æœƒå“¡å¸³è™Ÿ>
    COUPANG_PASSWORD=<é…·æ¾æœƒå“¡å¯†ç¢¼>
    ```

<br>

## ç·¨è¼¯æ¨¡çµ„

1. ç™»å…¥åŠŸèƒ½æ¨¡çµ„ `login.py`ã€‚

    ```python
    from selenium import webdriver
    from selenium.webdriver.common.by import By
    from selenium.webdriver.chrome.service import Service
    from selenium.webdriver.chrome.options import Options
    from webdriver_manager.chrome import ChromeDriverManager
    import time

    def login_and_get_driver(email: str, password: str):
        options = Options()
        options.add_argument("--headless=new")
        options.add_argument("--disable-gpu")
        options.add_argument("--no-sandbox")
        options.add_argument("--lang=zh-TW")

        driver = webdriver.Chrome(
            service=Service(ChromeDriverManager().install()),
            options=options
        )

        driver.get("https://member.tw.coupang.com/login/login.pang")
        time.sleep(2)

        driver.find_element(By.ID, "login-email-input").send_keys(email)
        driver.find_element(By.ID, "login-password-input").send_keys(password)
        driver.find_element(By.CLASS_NAME, "login__button--submit").click()
        time.sleep(5)

        print("âœ… å·²ç™»å…¥ Coupang")
        return driver
    ```

<br>

2. çˆ¬èŸ²åŠŸèƒ½æ¨¡çµ„ `crawler.py`ã€‚

    ```python
    # crawler.py

    from bs4 import BeautifulSoup
    from urllib.parse import quote
    import time
    from datetime import datetime

    def get_coupang_search_results(driver, search_keyword: str, advanced_keywords: list[str]):
        encoded_keyword = quote(search_keyword)
        url = f"https://www.tw.coupang.com/search?q={encoded_keyword}&channel=user"

        driver.get(url)
        time.sleep(5)

        html = driver.page_source
        soup = BeautifulSoup(html, "html.parser")
        product_cards = soup.select("div.SearchResult_searchResultProduct___h6E9")

        now = datetime.now()
        all_results = []
        filtered_results = []

        for card in product_cards:
            try:
                full_text = card.get_text(separator=" ", strip=True)

                title_tag = card.select_one("div.Product_title__8K0xk")
                title = title_tag.get_text(strip=True) if title_tag else "N/A"

                price_tag = card.select_one("span.Product_salePricePrice__2FbsL span")
                price = price_tag.get_text(strip=True) if price_tag else "N/A"

                unit_price_tag = card.select_one("div.Product_unitPrice__QQPdR")
                unit_price = unit_price_tag.get_text(strip=True) if unit_price_tag else "N/A"

                product = {
                    "search_keyword": search_keyword,
                    "title": title,
                    "full_text": full_text,
                    "price": price,
                    "unit_price": unit_price,
                    "timestamp": now
                }

                all_results.append(product)

                if all(kw in full_text for kw in advanced_keywords):
                    filtered_results.append(product)

            except Exception as e:
                print("è§£æéŒ¯èª¤ï¼š", e)
                continue

        return all_results, filtered_results
    ```

<br>

3. è³‡æ–™åº«å¯«å…¥æ¨¡çµ„ `db.py`ã€‚

    ```python
    import pymysql

    def insert_into_db(data_list, db_config):
        connection = pymysql.connect(
            host=db_config["host"],
            port=db_config["port"],
            user=db_config["user"],
            password=db_config["password"],
            database=db_config["database"],
            charset='utf8mb4'
        )
        with connection:
            with connection.cursor() as cursor:
                cursor.execute("""
                    CREATE TABLE IF NOT EXISTS coupang_products (
                        id INT AUTO_INCREMENT PRIMARY KEY,
                        search_keyword VARCHAR(255),
                        title TEXT,
                        full_text TEXT,
                        price VARCHAR(50),
                        unit_price VARCHAR(50),
                        timestamp DATETIME
                    );
                """)
                for data in data_list:
                    cursor.execute("""
                        INSERT INTO coupang_products (search_keyword, title, full_text, price, unit_price, timestamp)
                        VALUES (%s, %s, %s, %s, %s, %s)
                    """, (
                        data["search_keyword"], data["title"], data["full_text"],
                        data["price"], data["unit_price"], data["timestamp"]
                    ))
            connection.commit()
            print("âœ… å·²å¯«å…¥è³‡æ–™åº«ã€‚")
    ```

<br>

## ä¸»ç¨‹å¼

_è‹¥è¦é€²è¡Œæ¸¬è©¦ï¼Œå¯ä½¿ç”¨ `.ipynb` è…³æœ¬é‹è¡Œï¼Œå…©å€‹ä¸»æ§æµè…³æœ¬ `main.py` èˆ‡ `main.ipynb` å…§å®¹ç›¸åŒï¼Œä¸é‡è¤‡è´…è¿°_

<br>

1. æ•´åˆä¸»æ§æµç¨‹ã€‚

    ```python
    # å°å…¥åº«
    import os
    from dotenv import load_dotenv
    from login import login_and_get_driver
    from crawler import get_coupang_search_results
    from db import insert_into_db

    # è¼‰å…¥è³‡æ–™åº«è¨­å®š
    load_dotenv()
    db_config = {
        "host": os.getenv("DB_HOST"),
        "port": int(os.getenv("DB_PORT", 3306)),
        "user": os.getenv("DB_USER"),
        "password": os.getenv("DB_PASSWORD"),
        "database": os.getenv("DB_NAME")
    }

    # è¼‰å…¥æœƒå“¡å¸³è™Ÿå¯†ç¢¼
    EMAIL = os.getenv("COUPANG_EMAIL")
    PASSWORD = os.getenv("COUPANG_PASSWORD")

    # é—œéµå­—
    search_keyword = "kose æ´—é¢ä¹³"
    # ç©ºåˆ—è¡¨æœƒè‡ªå‹•é—œé–‰ç¯©é¸
    advanced_keywords = ["2æ¢"]

    # èª¿ç”¨è‡ªè¨‚ã€Œç™»å…¥ã€æ¨¡çµ„ï¼Œç™»å…¥ä¸¦å–å¾— driver
    driver = login_and_get_driver(EMAIL, PASSWORD)

    # èª¿ç”¨è‡ªè¨‚çˆ¬èŸ²æ¨¡çµ„ï¼Œä½¿ç”¨é©…å‹•å™¨å°é—œéµå­—å–å›çµæœï¼Œä¸¦é€²è¡Œç¯©é¸
    all_results, filtered_results = get_coupang_search_results(
        driver,
        search_keyword,
        advanced_keywords
    )
    driver.quit()

    # å¯«å…¥è³‡æ–™åº«ï¼Œå¯«å…¥æ‰€æœ‰å–å¾—çš„è³‡æ–™
    if all_results:
        # è¼¸å‡ºè³‡è¨ŠæŸ¥çœ‹ï¼Œåœ¨æ­£å¼æ¨¡å¼ä¸­å¯è¨»è§£
        print("ğŸ“¦ å¯«å…¥ä»¥ä¸‹ã€æ‰€æœ‰æœå°‹çµæœã€‘åˆ°è³‡æ–™åº«ï¼š")
        for idx, r in enumerate(all_results, 1):
            print(f"{idx}. æ¨™é¡Œ: {r['title']}")
            print(f"   åƒ¹æ ¼: {r['price']}")
            print(f"   å–®ä½åƒ¹æ ¼: {r['unit_price']}")
            print(f"   æ™‚é–“æˆ³: {r['timestamp']}")
            print("-" * 60)
        # èª¿ç”¨è‡ªè¨‚æ¨¡çµ„å¯«å…¥è³‡æ–™
        insert_into_db(all_results, db_config)
    else:
        print("âš ï¸ æ²’æœ‰æœå°‹çµæœï¼Œä¸é€²è¡Œè³‡æ–™åº«å¯«å…¥ã€‚")

    # åœ¨æ¸¬è©¦æ¨¡å¼ä¸‹å¯é¡å¤–è¼¸å‡ºé€²éšçµæœæŸ¥çœ‹
    if advanced_keywords:
        print(
            "\nğŸ¯ ç¬¦åˆé€²éšç¯©é¸æ¢ä»¶çš„çµæœï¼š"
        )
        print(
            f"\nï¼ˆåŒ…å«ï¼š{'ã€'.join(advanced_keywords)}ï¼‰"
        )
        # å‡å¦‚æœ‰è³‡æ–™
        if filtered_results:
            for idx, r in enumerate(filtered_results, 1):
                print(f"{idx}. æ¨™é¡Œ: {r['title']}")
                print(f"   åƒ¹æ ¼: {r['price']}")
                print(f"   å–®ä½åƒ¹æ ¼: {r['unit_price']}")
                print(f"   æ™‚é–“æˆ³: {r['timestamp']}")
                print("-" * 60)
        else:
            print("âš ï¸ æ²’æœ‰ç¬¦åˆé€²éšæ¢ä»¶çš„é …ç›®")
    ```

<br>

## å¥—ä»¶ç®¡ç†

1. è‡ªå‹•åŒ–è¼¸å‡ºç•¶å‰è™›æ“¬ç’°å¢ƒä¸­æ‰€å®‰è£çš„å¥—ä»¶èˆ‡ç‰ˆæœ¬ï¼Œä¸¦ç”Ÿæˆ `requirements.txt`ï¼›ç‰¹åˆ¥æ³¨æ„ï¼Œå»ºè­°åœ¨ `è™›æ“¬ç’°å¢ƒ` ä¸­åŸ·è¡Œï¼Œä»¥ç¢ºä¿è¼¸å‡ºçš„å¥—ä»¶åˆ—è¡¨æœ€å°ä¸”ç²¾æº–ã€‚

    ```bash
    pip freeze > requirements.txt
    ```

<br>

2. è‹¥è¦æ‰‹å‹•ç·¨è¼¯å¥—ä»¶ç®¡ç†æ–‡ä»¶ï¼Œå¯å¯«å…¥ä»¥ä¸‹å¥—ä»¶ã€‚

    ```bash
    selenium
    webdriver-manager
    beautifulsoup4
    python-dotenv
    pymysql
    ```

<br>

___

_END_