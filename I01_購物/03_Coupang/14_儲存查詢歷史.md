# å„²å­˜æŸ¥è©¢æ­·å²

_å°‡ `æœå°‹æ­·å²` è¨˜éŒ„ä¸¦é‡è¤‡åˆ©ç”¨_

<br>

## è®€å–ç´€éŒ„

1. è‹¥è¦æ‰‹å‹•å»ºç«‹ç´€éŒ„ç”¨çš„è³‡æ–™è¡¨ `search_keywords`ï¼Œå¯é‹è¡Œä»¥ä¸‹èªå¥ï¼Œå¾ŒçºŒå°‡ç”¨ä¾†è¨˜éŒ„æœå°‹éçš„é—œéµå­—èˆ‡æœå°‹æ™‚é–“ã€‚

    ```sql
    CREATE TABLE IF NOT EXISTS search_keywords (
        id INT AUTO_INCREMENT PRIMARY KEY,
        keyword VARCHAR(255) UNIQUE,
        last_searched DATETIME
    );
    ```

<br>

2. é€éå¾ä¸»è³‡æ–™è¡¨ `coupang_products` ä¸­æå–å·²å­˜åœ¨çš„æœå°‹é—œéµå­—ï¼Œç„¶å¾Œå»ºç«‹å°æ‡‰çš„æ­·å²ç´€éŒ„ `search_keywords` è¡¨ï¼›é€™å±¬æ–¼ä¸€æ¬¡æ€§è£œå…¨è…³æœ¬ï¼Œé©ç”¨æ–¼ç›®å‰å·²ç´¯ç©æœå°‹è¨˜éŒ„ä½†æœªåŒæ­¥å¯«å…¥æ­·å²é—œéµå­—è¡¨çš„æƒ…æ³ã€‚

    ```python
    import pymysql
    import os
    from dotenv import load_dotenv
    from datetime import datetime

    # è¼‰å…¥è³‡æ–™åº«è¨­å®š
    load_dotenv()
    DB_CONFIG = {
        "host": os.getenv("DB_HOST"),
        "port": int(os.getenv("DB_PORT", 3306)),
        "user": os.getenv("DB_USER"),
        "password": os.getenv("DB_PASSWORD"),
        "database": os.getenv("DB_NAME")
    }

    def sync_keywords_from_history(db_config):
        conn = pymysql.connect(
            **db_config,
            charset='utf8mb4',
            cursorclass=pymysql.cursors.DictCursor
        )

        with conn:
            with conn.cursor() as cursor:
                # è‹¥å°šæœªå­˜åœ¨å‰‡å»ºç«‹ search_keywords è¡¨
                cursor.execute("""
                    CREATE TABLE IF NOT EXISTS search_keywords (
                        id INT AUTO_INCREMENT PRIMARY KEY,
                        keyword VARCHAR(255) UNIQUE,
                        last_searched DATETIME
                    );
                """)

                # å¾ coupang_products æŠ“å–ä¸åŒé—œéµå­—åŠæœ€æ–°æ™‚é–“
                cursor.execute("""
                    SELECT search_keyword AS keyword, MAX(timestamp) AS last_searched
                    FROM coupang_products
                    GROUP BY search_keyword
                """)
                keyword_rows = cursor.fetchall()

                print(
                    f"ğŸ” å…±ç™¼ç¾ {len(keyword_rows)} å€‹æ­·å²é—œéµå­—ï¼Œæº–å‚™å¯«å…¥..."
                )

                for row in keyword_rows:
                    keyword = row["keyword"]
                    last_searched = row["last_searched"]

                    # å¯«å…¥æˆ–æ›´æ–°ï¼Œå¦‚æœå·²å­˜åœ¨å‰‡æ›´æ–°æœ€å¾Œæ™‚é–“
                    cursor.execute("""
                        INSERT INTO search_keywords (keyword, last_searched)
                        VALUES (%s, %s)
                        ON DUPLICATE KEY UPDATE last_searched = VALUES(last_searched)
                    """, (keyword, last_searched))

            conn.commit()
            print("âœ… æ­·å²é—œéµå­—åŒæ­¥å®Œæˆ")

            # é¡¯ç¤ºæ‰€æœ‰é—œéµå­—ï¼Œä¾æ™‚é–“æ’åº
            with conn.cursor() as cursor:
                cursor.execute("""
                    SELECT keyword, last_searched
                    FROM search_keywords
                    ORDER BY last_searched DESC
                """)
                all_keywords = cursor.fetchall()

                print("\nğŸ“‹ æ­·å²æŸ¥è©¢é—œéµå­—ï¼š")
                for idx, row in enumerate(all_keywords, 1):
                    print(
                        f"{idx}. {row['keyword']}"
                        f"ï¼ˆæœ€å¾ŒæŸ¥è©¢æ™‚é–“ï¼š{row['last_searched']}ï¼‰"
                    )

    # åŸ·è¡Œè£œå¯«å‹•ä½œ
    if __name__ == "__main__":
        sync_keywords_from_history(DB_CONFIG)
    ```

    ![](images/img_15.png)

<br>

## è‡ªå‹•åŒ–ç´€éŒ„

_åœ¨æ¯æ¬¡æœå°‹æ™‚ä¸»å‹•é€²è¡Œé—œéµå­—çš„ç´€éŒ„_

<br>

1. å»ºç«‹æ–°çš„å‡½æ•¸ï¼Œåœ¨ä¸»ç¨‹å¼å…§çš„è¿´åœˆä¸­ï¼Œæœå°‹æ¯å€‹é—œéµå­—æ™‚åŒæ­¥å¯«å…¥ç´€éŒ„ã€‚

    ```python
    def record_keyword(keyword, db_config):
        conn = pymysql.connect(db_config, charset='utf8mb4')
        now = datetime.now()

        with conn:
            with conn.cursor() as cursor:
                cursor.execute("""
                    CREATE TABLE IF NOT EXISTS search_keywords (
                        id INT AUTO_INCREMENT PRIMARY KEY,
                        keyword VARCHAR(255) UNIQUE,
                        last_searched DATETIME
                    );
                """)
                cursor.execute("""
                    INSERT INTO search_keywords (keyword, last_searched)
                    VALUES (%s, %s)
                    ON DUPLICATE KEY UPDATE last_searched = VALUES(last_searched);
                """, (keyword, now))
            conn.commit()
    ```

<br>

2. åœ¨ä¸»ç¨‹å¼ä¸­èª¿ç”¨ã€‚

    ```python
    if __name__ == "__main__":
        # å¾è³‡æ–™åº«è®€å‡ºæ­·å²æœå°‹é—œéµå­—
        keywords = fetch_all_keywords(DB_CONFIG)

        driver = login_and_get_driver(EMAIL, PASSWORD)
        all_results = []

        for keyword in keywords:
            print(f"\nğŸ” æœå°‹ï¼š{keyword}")
            results = get_search_results(driver, keyword, max_pages=5)
            all_results.extend(results)

            # æ¯æ¬¡æœå°‹å¾Œè¨˜éŒ„è©²é—œéµå­—
            record_keyword(keyword, DB_CONFIG)

        driver.quit()

        if all_results:
            for idx, r in enumerate(all_results, 1):
                print(f"{idx}. {r['title']} - {r['price']} - {r['unit_price']} - ä¾†æº: {r.get('source_type')}")
            insert_into_db(all_results, DB_CONFIG)
        else:
            print("âš ï¸ æŸ¥ç„¡çµæœ")
    ```

<br>

___

_END_



