# Selenium

[åƒè€ƒ](https://www.npmjs.com/package/chromedriver) 

<br>

## ä¸€èˆ¬å®‰è£

_ç„¡è«– MacOS æˆ–æ˜¯ Win çš†ç›¸åŒï¼Œé—œæ–¼å®‰è£çš„è£œå……æœƒåœ¨å¾ŒçºŒèªªæ˜_

<br>

1. ç›´æ¥å®‰è£ã€‚

    ```bash
    pip install selenium
    ```

<br>

## æ–°ç‰ˆèªªæ˜

_æ–°çš„ 4.x ç‰ˆ Selenium ç›¸è¼ƒæ–¼ 3.x åŠæ›´æ—©ç‰ˆæœ¬æœ‰è¨±å¤š API è®Šæ›´ï¼Œå°¤å…¶æ˜¯åœ¨ç€è¦½å™¨é©…å‹•ç®¡ç†ã€å…ƒç´ æŸ¥æ‰¾ã€ç­‰å¾…æ©Ÿåˆ¶ã€ä»¥åŠèˆ‡ WebDriver äº’å‹•çš„æ–¹å¼ ä¸Šæœ‰é¡¯è‘—ä¸åŒã€‚_

<br>

## ä¸»è¦è®Šæ›´

1. æ–°ç‰ˆ Selenium å…§å»ºäº† WebDriver ç®¡ç†å·¥å…·ï¼Œä¸å†éœ€è¦æ‰‹å‹•ä¸‹è¼‰ `chromedriver`ã€`geckodriver` ç­‰é©…å‹•ç¨‹å¼ï¼Œä¹Ÿç„¡éœ€å‚³å…¥è·¯å¾‘ `webdriver.Chrome(executable_path="path")`ã€‚

    ```python
    from selenium import webdriver

    # ä¸éœ€è¦æ‰‹å‹•ä¸‹è¼‰ï¼ŒSelenium æœƒè‡ªå‹•å®‰è£èˆ‡ç®¡ç†
    driver = webdriver.Chrome()  
    ```

<br>

2. `find_element` éœ€ä½¿ç”¨ `By` æŒ‡å®šå…ƒç´ ï¼Œèˆ‡èˆŠç‰ˆ Selenium å…è¨±ç›´æ¥å‚³å…¥ `find_element_by_*` æ–¹æ³•ä¸åŒï¼›ç‰¹åˆ¥æ³¨æ„ï¼ŒèˆŠç‰ˆçš„ `find_element_by_id`ã€`find_element_by_class_name` éƒ½å·²æ£„ç”¨ï¼Œéœ€è¦æ”¹ç”¨ `By.ID`ã€`By.CLASS_NAME`ã€‚

    ```python
    from selenium.webdriver.common.by import By

    element = driver.find_element(By.ID, "username")
    ```

<br>

## `ActionChains`ã€`wait` API è®Šæ›´

1. `ActionChains` è®Šæ›´ï¼ŒSelenium 4 æ–°å¢çš„ `scroll_to_element`ã€‚

    ```python
    from selenium.webdriver.common.action_chains import ActionChains

    actions = ActionChains(driver)
    actions.scroll_to_element(element).perform()
    ```

<br>

2. `wait` API è®Šæ›´ï¼Œæ–°ç‰ˆ `By` å¿…é ˆé¡¯å¼æŒ‡å®šã€‚

    ```python
    from selenium.webdriver.support.ui import WebDriverWait
    from selenium.webdriver.support import expected_conditions as EC
    from selenium.webdriver.common.by import By

    WebDriverWait(driver, 10).until(
        EC.presence_of_element_located(
            (By.ID, "username")
        )
    )
    ```

<br>

## æ»¾å‹•èˆ‡è¦–çª—ç®¡ç† API

1. Selenium 4.x æä¾›äº†æ›´å¥½çš„æ»¾å‹•èˆ‡è¦–çª—ç®¡ç†åŠŸèƒ½

    ```python
    # æ»¾å‹•åˆ°ç‰¹å®šå…ƒç´ 
    driver.execute_script("arguments[0].scrollIntoView();", element)

    # å–å¾—ç•¶å‰è¦–çª—å¤§å°
    size = driver.get_window_rect()
    print(size)
    ```

<br>

2. æ–°ç‰ˆ Selenium 4.x å…§å»ºæ”¯æ´ `relative locators` ç›¸å°å®šä½ï¼Œå…è¨±ç›¸å°æ–¼å…¶ä»–å…ƒç´ ä¾†å°‹æ‰¾ç›®æ¨™å…ƒç´ ï¼Œé€™å°æ–¼ç„¡æ³•ç›´æ¥å®šä½çš„å…ƒç´ å¦‚ `å‹•æ…‹ç”¢ç”Ÿçš„æŒ‰éˆ•` å¾ˆæœ‰å¹«åŠ©ã€‚

    ```python
    from selenium.webdriver.common.by import By
    from selenium.webdriver.support.relative_locator import locate_with

    # æ‰¾åˆ°æŸå€‹å…ƒç´ "æ—é‚Š"çš„æŒ‰éˆ•
    element = driver.find_element(
        locate_with(By.TAG_NAME, "button").to_right_of(By.ID, "login-form")
    )
    ```

<br>

## æ¸¬è©¦ä»£ç¢¼

1. åŸºæœ¬æ¸¬è©¦ã€‚

    ```python
    from selenium import webdriver
    from selenium.webdriver.chrome.service import Service
    from selenium.webdriver.common.by import By
    from selenium.webdriver.chrome.options import Options
    from selenium.webdriver.support.ui import WebDriverWait
    from selenium.webdriver.support import expected_conditions as EC
    from webdriver_manager.chrome import ChromeDriverManager

    # è¨­å®š Chrome é¸é …
    options = Options()
    # ç„¡é ­æ¨¡å¼ (æ–°ç‰ˆ)
    options.add_argument("--headless=new") 
    # é¿å…æŸäº›ç’°å¢ƒå•é¡Œ
    options.add_argument("--disable-gpu")
    # åœ¨ Linux ç’°å¢ƒé¿å…æ¬Šé™å•é¡Œ
    options.add_argument("--no-sandbox")
    # é¿å… Chrome åœ¨ Docker å…§è¨˜æ†¶é«”ä¸è¶³
    options.add_argument("--disable-dev-shm-usage")
    # é˜²æ­¢ Selenium è¢«æª¢æ¸¬
    options.add_argument("--disable-blink-features=AutomationControlled")

    # è‡ªå‹•å®‰è£ ChromeDriver
    service = Service(ChromeDriverManager().install())

    # å•Ÿå‹• WebDriver
    driver = webdriver.Chrome(service=service, options=options)

    # ç›®æ¨™ç¶²å€
    _URL = "https://news.google.com/home?hl=zh-TW&gl=TW&ceid=TW:zh-Hant"
    print(f"ğŸ” æ­£åœ¨è¨ªå•: {_URL}")
    driver.get(_URL)

    # ä½¿ç”¨ WebDriverWait ç¢ºä¿é é¢è¼‰å…¥
    try:
        WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.TAG_NAME, "body"))
        )
        print("é é¢åŠ è¼‰æˆåŠŸ")

        # å–å¾—é é¢åŸå§‹ç¢¼
        page_source = driver.page_source
        print(f"é é¢é•·åº¦ï¼š{len(page_source)} å­—å…ƒ")

    except Exception as e:
        print(f"é é¢åŠ è¼‰å¤±æ•—ï¼š{e}")

    finally:
        # é—œé–‰ WebDriver
        driver.quit()
        print("ç€è¦½å™¨å·²é—œé–‰")
    ```

    ![](images/img_01.png)

<br>

2. å¯¦æ¸¬æŸ¥è©¢ MOMO è³¼ç‰©ç¶²çš„æŒ‡å®šå•†å“ã€‚

    ```python
    from selenium import webdriver
    from selenium.webdriver.chrome.service import Service
    from selenium.webdriver.common.by import By
    from selenium.webdriver.chrome.options import Options
    from selenium.webdriver.support.ui import WebDriverWait
    from selenium.webdriver.support import expected_conditions as EC
    from webdriver_manager.chrome import ChromeDriverManager
    import time

    # è¨­å®š Selenium ç€è¦½å™¨åƒæ•¸
    options = Options()
    # ä½¿ç”¨æ–°ç‰ˆ headless æ¨¡å¼
    options.add_argument("--headless=new")
    # é¿å… GPU éŒ¯èª¤
    options.add_argument("--disable-gpu")
    # é¿å… Linux æ¬Šé™å•é¡Œ
    options.add_argument("--no-sandbox")
    # é˜²æ­¢ Selenium è¢«æª¢æ¸¬
    options.add_argument("--disable-blink-features=AutomationControlled")

    # è‡ªå‹•å®‰è£ ChromeDriver
    service = Service(ChromeDriverManager().install())
    driver = webdriver.Chrome(service=service, options=options)

    # æŒ‡å®šæœ€å¤šæŸ¥è©¢ç­†æ•¸
    MAX_RECORDS = 10
    # è¨­å®šæŸ¥è©¢å•†å“
    PRODUCT = "HFZ-B14A1FV"
    _URL = f"https://www.momoshop.com.tw/search/searchShop.jsp?keyword={PRODUCT}"

    print(f"ğŸ” æ­£åœ¨æœå°‹å•†å“ï¼š{PRODUCT}")
    driver.get(_URL)

    # ä½¿ç”¨ WebDriverWait ç­‰å¾…å•†å“åˆ—è¡¨åŠ è¼‰
    try:
        WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.CLASS_NAME, "listArea"))
        )
        print("å•†å“åˆ—è¡¨åŠ è¼‰æˆåŠŸã€‚")
    except Exception as e:
        print(f"âŒ å•†å“åˆ—è¡¨åŠ è¼‰å¤±æ•—: {e}")
        driver.quit()
        exit()

    # ç¢ºèªå•†å“æ•¸é‡
    product_elements = driver.find_elements(
        By.XPATH, "//ul[@class='listAreaUl']/li[@class='listAreaLi']"
    )
    num_products = len(product_elements)

    if num_products == 0:
        print("âš ï¸ æ²’æœ‰æ‰¾åˆ°å•†å“ï¼ŒçµæŸç¨‹å¼ã€‚")
        driver.quit()
        exit()
    elif num_products == 1:
        print("âš ï¸ åªæœ‰ 1 å€‹å•†å“ï¼Œå°‡åªæŠ“å–é€™ç­†è³‡æ–™ã€‚")

    # æ»¾å‹•é é¢ç¢ºä¿æ‰€æœ‰å•†å“è¼‰å…¥
    driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
    # ç­‰å¾… JavaScript å®Œå…¨è¼‰å…¥
    time.sleep(3)

    # çˆ¬å–æ‰€æœ‰å•†å“ï¼Œæœ€å¤šæŠ“å– `MAX_RECORDS` å€‹å•†å“
    for i in range(1, min(num_products, MAX_RECORDS) + 1):
        try:
            base_xpath = f"//ul[@class='listAreaUl']/li[@class='listAreaLi'][{i}]"

            # ç”¢å“è³‡è¨Š XPath
            img_xpath = base_xpath + "//picture/img[@class='prdImg']"
            title_xpath = base_xpath + "//h3[@class='prdName']"
            price_xpath = base_xpath + "//span[@class='price']/b"

            # å–å¾—å•†å“åœ–ç‰‡
            product_img = (
                WebDriverWait(driver, 5)
                .until(EC.presence_of_element_located((By.XPATH, img_xpath)))
                .get_attribute("src")
            )

            # å–å¾—å•†å“æ¨™é¡Œ
            product_title = (
                WebDriverWait(driver, 5)
                .until(EC.presence_of_element_located((By.XPATH, title_xpath)))
                .text
            )

            # å–å¾—å•†å“åƒ¹æ ¼
            product_price = (
                WebDriverWait(driver, 5)
                .until(EC.presence_of_element_located((By.XPATH, price_xpath)))
                .text
            )

            # é¡¯ç¤ºçµæœ
            print(f"ğŸ“Œ å•†å“ {i}")
            print("ğŸ“· åœ–ç‰‡ï¼š", product_img)
            print("ğŸ· æ¨™é¡Œï¼š", product_title)
            print("ğŸ’° åƒ¹æ ¼ï¼š", product_price)
            # åˆ†éš”
            print("-" * 50)

        except Exception as e:
            print(f"âš ï¸ å•†å“ {i} ç„¡æ³•ç²å–ï¼š{e}")
            continue

    # é—œé–‰ç€è¦½å™¨
    driver.quit()
    print("ç€è¦½å™¨å·²é—œé–‰")
    ```

    ![](images/img_35.png)

<br>

___

_END_