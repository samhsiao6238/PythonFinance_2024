# é€²éšæ‡‰ç”¨

## å›é¡§

_å…ˆå›é¡§ä¸€ä¸‹åŸºç¤æ‡‰ç”¨ä¸­ï¼ŒæŸ¥è©¢å–®ä¸€å•†å“çš„ä»£ç¢¼_

1. æŸ¥è©¢å–®ä¸€æ¨™çš„ã€‚

```python
import requests
import json
import pandas as pd
import pytz

# æŒ‡å®š ISIN ç¨‹å¼ç¢¼å’Œ URL
_ISIN_CODE = 'US02209SBF92'
url = f"https://api.boerse-frankfurt.de/v1/data/price_information?isin={_ISIN_CODE}&mic=XFRA"

# å®šç¾©è‹±æ–‡æ¬„ä½åç¨±åˆ°ä¸­æ–‡çš„æ˜ å°„
column_mapping = {
    'isin': 'è­‰åˆ¸ç·¨ç¢¼',
    'lastPrice': 'æœ€æ–°åƒ¹æ ¼',
    'timestampLastPrice': 'æœ€æ–°åƒ¹æ ¼æ™‚é–“æˆ³',
    'changeToPrevDayAbsolute': 'ä»Šæ—¥æ¼²è·Œåƒ¹æ ¼',
    'changeToPrevDayInPercent': 'ä»Šæ—¥æ¼²è·Œå¹…åº¦',
    'closingPricePrevTradingDay': 'å‰æ—¥æ”¶ç›¤åƒ¹',
    'mic': 'å¸‚å ´è­˜åˆ¥ç¢¼',
    'dayHigh': 'æœ€é«˜åƒ¹',
    'dayLow': 'æœ€ä½åƒ¹',
    'priceFixings': 'åƒ¹æ ¼å®šé»',
    'tradedInPercent': 'ä»¥ç™¾åˆ†æ¯”äº¤æ˜“',
    'tradingTimeEnd': 'äº¤æ˜“çµæŸæ™‚é–“',
    'tradingTimeStart': 'äº¤æ˜“é–‹å§‹æ™‚é–“',
    'turnoverInEur': 'æˆäº¤é¡ï¼ˆæ­å…ƒï¼‰',
    'turnoverInPieces': 'æˆäº¤é‡ï¼ˆä»¶æ•¸ï¼‰',
    'turnoverNominal': 'åç¾©æˆäº¤é¡',
    'weeks52High': '52é€±æœ€é«˜åƒ¹',
    'weeks52Low': '52é€±æœ€ä½åƒ¹',
    'currency': 'è²¨å¹£',
    'minimumTradableUnit': 'æœ€å°å¯äº¤æ˜“å–®ä½'
}

# ä½¿ç”¨ with èªå¥ç™¼é€è«‹æ±‚ä¸¦å–å¾—éŸ¿æ‡‰
with requests.get(url, stream=True) as response:
    # ç¢ºä¿éŸ¿æ‡‰æˆåŠŸ
    if response.status_code == 200:
        data_count = 0
        data_json = None
        for line in response.iter_lines():
            # è§£ç¢¼æ¯ä¸€è¡Œ
            line = line.decode('utf-8')
            # æª¢æŸ¥è¡Œæ˜¯å¦åŒ…å« 'data:'
            if 'data:' in line:
                data_count += 1
                if data_count == 1:
                    # æå–ç¬¬ä¸€æ¬¡å‡ºç¾ 'data:' ä¹‹å¾Œçš„å…§å®¹
                    data_json = line.split('data:', 1)[1].strip()
                elif data_count == 2:
                    # ç•¶ç¬¬äºŒæ¬¡å‡ºç¾ 'data:' æ™‚çµ‚æ­¢å¾ªç’°
                    break
    else:
        print(f"ç™¼ç”ŸéŒ¯èª¤ï¼šç„¡æ³•å–å¾—è³‡æ–™ï¼š{response.status_code}")

# æª¢æŸ¥æ˜¯å¦æœ‰å–å¾—åˆ°æ•¸æ“š
if data_json:
    try:
        # è§£æ JSON æ•¸æ“š
        data = json.loads(data_json)

        # è½‰æ›ç‚º pandas DataFrame
        df = pd.DataFrame([data])
        # è½‰æ› DataFrame çš„åˆ—å
        df.rename(columns=column_mapping, inplace=True)

        # å°‡ 'æœ€æ–°åƒ¹æ ¼æ™‚é–“æˆ³' è½‰æ›ç‚ºå°ç£æ™‚é–“ (UTC+8) ä¸¦æ ¼å¼åŒ–
        df['æœ€æ–°åƒ¹æ ¼æ™‚é–“æˆ³'] = pd.to_datetime(df['æœ€æ–°åƒ¹æ ¼æ™‚é–“æˆ³'])
        taipei_tz = pytz.timezone('Asia/Taipei')
        df['æœ€æ–°åƒ¹æ ¼æ™‚é–“æˆ³'] = df['æœ€æ–°åƒ¹æ ¼æ™‚é–“æˆ³'].dt.tz_convert(taipei_tz)
        df['æœ€æ–°åƒ¹æ ¼æ™‚é–“æˆ³'] = df['æœ€æ–°åƒ¹æ ¼æ™‚é–“æˆ³'].dt.strftime('%Y-%m-%d %H:%M')
        
        # åŸå§‹æ•¸æ“šç‚ºä¸­æ­æ™‚é–“ï¼ˆCET/CESTï¼‰
        frankfurt_tz = pytz.timezone('Europe/Berlin')
        # å°‡ 'äº¤æ˜“é–‹å§‹æ™‚é–“' å’Œ 'äº¤æ˜“çµæŸæ™‚é–“' å¾å­—ä¸²è½‰æ›ç‚º datetime å°è±¡
        # ä¸¦è½‰æ›ç‚ºç•¶åœ°æ™‚é–“
        df['äº¤æ˜“é–‹å§‹æ™‚é–“'] = pd.to_datetime(df['äº¤æ˜“é–‹å§‹æ™‚é–“']).dt.tz_localize(frankfurt_tz)
        df['äº¤æ˜“çµæŸæ™‚é–“'] = pd.to_datetime(df['äº¤æ˜“çµæŸæ™‚é–“']).dt.tz_localize(frankfurt_tz)
        # è½‰æ›ç‚ºå°ç£æ™‚é–“ (UTC+8)
        df['äº¤æ˜“é–‹å§‹æ™‚é–“'] = df['äº¤æ˜“é–‹å§‹æ™‚é–“'].dt.tz_convert(taipei_tz).dt.strftime('%Y-%m-%d %H:%M')
        df['äº¤æ˜“çµæŸæ™‚é–“'] = df['äº¤æ˜“çµæŸæ™‚é–“'].dt.tz_convert(taipei_tz).dt.strftime('%Y-%m-%d %H:%M')

        # å„²å­˜ç‚º Excel æ–‡ä»¶
        excel_file = 'price_information.xlsx'
        df.to_excel(excel_file, index=False)

        print(f"è³‡æ–™å·²å„²å­˜ç‚º {excel_file}")
    except json.JSONDecodeError as e:
        print(f"JSON ç„¡æ³•è§£æï¼š {e}")
else:
    print("æœªæ‰¾åˆ°æœ‰æ•ˆçš„ 'data:' è³‡æ–™")

df
```

## å¤šé‡å•†å“

1. æ‰¹æ¬¡æŸ¥è©¢å¤šå•†å“ã€‚

```python
import requests
import json
import pandas as pd
import pytz
import time

# å°ç…§è¡¨ï¼šISIN å°æ‡‰ä¸­æ–‡å‚µåˆ¸åç¨±
isin_to_name = {
    'US02209SBF92': 'é«˜ç‰¹åŠ› 2039 5.95',
    'US037833BX70': 'è˜‹æœ 2046 4.65',
    'US02209SBE28': 'é«˜ç‰¹åŠ› 2039 5.8',
    'US716973AH54': 'è¼ç‘ 2053 5.3',
    'US842434DA71': 'å—åŠ å·å¤©ç„¶æ°£ 2054 5.6',
    'US872898AJ06': 'å°ç©é›» 2052 4.5',
    'USF2893TAE67': 'æ³•åœ‹é›»åŠ› 2040 5.6',
    'US05526DBV64': 'è‹±ç¾è¸è‰ 2052 5.65',
    'US717081ED10': 'è¼ç‘ 2046 4.125',
    'US716973AG71': 'è¼ç‘ 2053 5.3'
}

# API URL æ ¼å¼
base_url = "https://api.boerse-frankfurt.de/v1/data/price_information?isin={}&mic=XFRA"

# è‹±æ–‡æ¬„ä½åç¨±å°æ‡‰çš„ä¸­æ–‡åç¨±
column_mapping = {
    'isin': 'è­‰åˆ¸ç·¨ç¢¼',
    'lastPrice': 'æœ€æ–°åƒ¹æ ¼',
    'timestampLastPrice': 'æœ€æ–°åƒ¹æ ¼æ™‚é–“æˆ³',
    'changeToPrevDayAbsolute': 'ä»Šæ—¥æ¼²è·Œåƒ¹æ ¼',
    'changeToPrevDayInPercent': 'ä»Šæ—¥æ¼²è·Œå¹…åº¦',
    'closingPricePrevTradingDay': 'å‰æ—¥æ”¶ç›¤åƒ¹',
    'mic': 'å¸‚å ´è­˜åˆ¥ç¢¼',
    'dayHigh': 'æœ€é«˜åƒ¹',
    'dayLow': 'æœ€ä½åƒ¹',
    'priceFixings': 'åƒ¹æ ¼å®šé»',
    'tradedInPercent': 'ä»¥ç™¾åˆ†æ¯”äº¤æ˜“',
    'tradingTimeEnd': 'äº¤æ˜“çµæŸæ™‚é–“',
    'tradingTimeStart': 'äº¤æ˜“é–‹å§‹æ™‚é–“',
    'turnoverInEur': 'æˆäº¤é¡ï¼ˆæ­å…ƒï¼‰',
    'turnoverInPieces': 'æˆäº¤é‡ï¼ˆä»¶æ•¸ï¼‰',
    'turnoverNominal': 'åç¾©æˆäº¤é¡',
    'weeks52High': '52é€±æœ€é«˜åƒ¹',
    'weeks52Low': '52é€±æœ€ä½åƒ¹',
    'currency': 'è²¨å¹£',
    'minimumTradableUnit': 'æœ€å°å¯äº¤æ˜“å–®ä½'
}

# å­˜æ”¾çµæœçš„ DataFrame
all_results = []

# éæ­· ISIN ä»£ç¢¼æŸ¥è©¢
for isin, bond_name in isin_to_name.items():
    url = base_url.format(isin)
    print(f"ğŸ” æŸ¥è©¢ {isin} ({bond_name}) çš„å¸‚å ´åƒ¹æ ¼...")
    # é‡è©¦è¨ˆæ•¸
    attempt = 0
    # æœ€å¤šé‡è©¦ 5 æ¬¡
    max_attempts = 5

    while attempt < max_attempts:
        try:
            # åŠ å…¥è¶…æ™‚ (15ç§’)
            response = requests.get(
                url, stream=True, timeout=15
            )
            # å¦‚æœæ­£ç¢º `200`
            if response.status_code == 200:
                data_count = 0
                data_json = None
                for line in response.iter_lines():
                    line = line.decode('utf-8')
                    if 'data:' in line:
                        data_count += 1
                        if data_count == 1:
                            data_json = line.split('data:', 1)[1].strip()
                        elif data_count == 2:
                            break

                if data_json:
                    data = json.loads(data_json)
                    # æ·»åŠ ã€Œå‚µåˆ¸åç¨±ã€æ¬„ä½
                    data['å‚µåˆ¸åç¨±'] = bond_name
                    all_results.append(data)
                # æˆåŠŸæŸ¥è©¢ï¼Œè·³å‡ºé‡è©¦è¿´åœˆ
                break
            
            elif response.status_code == 404:
                print(
                    f"âš ï¸ {isin} ({bond_name}) "
                    "ç„¡æ³•æŸ¥è©¢ (404 Not Found)ï¼Œè·³é..."
                )
                # å¦‚æœ 404ï¼Œä¸é‡è©¦
                break
            
            else:
                print(
                    f"âŒ {isin} æŸ¥è©¢å¤±æ•—ï¼Œ"
                    f"ç‹€æ…‹ç¢¼: {response.status_code}"
                )

        except (requests.exceptions.Timeout, requests.exceptions.ConnectionError) as e:
            print(f"âš ï¸ {isin} æŸ¥è©¢è¶…æ™‚ï¼Œæ­£åœ¨é‡è©¦ ({attempt+1}/{max_attempts})...")

        attempt += 1
        # æ¯æ¬¡è«‹æ±‚é–“éš” 5 ç§’ï¼Œé™ä½ API éè¼‰
        time.sleep(5)

# è½‰æ›ç‚º DataFrame
df = pd.DataFrame(all_results)

# æ›´æ”¹æ¬„ä½åç¨±
df.rename(columns=column_mapping, inplace=True)

# ä¿®æ­£è²¨å¹£æ¬„ä½ï¼Œæå– `originalValue`
if 'è²¨å¹£' in df.columns:
    df['è²¨å¹£'] = df['è²¨å¹£'].apply(lambda x: x.get('originalValue', 'æœªçŸ¥') if isinstance(x, dict) else 'æœªçŸ¥')

# æ™‚é–“æ ¼å¼è™•ç†
taipei_tz = pytz.timezone('Asia/Taipei')

# ä¿®æ­£æ™‚é–“è™•ç†ï¼Œç¢ºä¿æ™‚å€è½‰æ›æ­£ç¢º
def convert_time_column(df, column_name):
    if column_name in df.columns:
        df[column_name] = pd.to_datetime(df[column_name], errors='coerce')
        # åªæœ‰åœ¨ tz-naive çš„æƒ…æ³ä¸‹æ‰ localize
        if df[column_name].dt.tz is None:
            df[column_name] = df[column_name].dt.tz_localize('UTC')
        df[column_name] = df[column_name].dt.tz_convert(taipei_tz).dt.strftime('%Y-%m-%d %H:%M')

# è™•ç†ä¸‰å€‹æ™‚é–“æ¬„ä½
convert_time_column(df, 'æœ€æ–°åƒ¹æ ¼æ™‚é–“æˆ³')
convert_time_column(df, 'äº¤æ˜“é–‹å§‹æ™‚é–“')
convert_time_column(df, 'äº¤æ˜“çµæŸæ™‚é–“')

# å„²å­˜ç‚º Excel æ–‡ä»¶
excel_file = 'price_information_2.xlsx'
df.to_excel(excel_file, index=False)

print(f"âœ… æ‰€æœ‰æ•¸æ“šå·²å„²å­˜è‡³ {excel_file}")
# å¦‚æœä½¿ç”¨ JupyterNotebook å¯è¼¸å‡ºæŸ¥çœ‹
df
```