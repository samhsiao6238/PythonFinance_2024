# 彙整以上的說明

<br>

## 簡介

1. Amazon Bedrock 是 AWS 提供的一項全託管服務，旨在迅速使用和擴展生成式 AI 應用程式，透過統一的 API，Bedrock 提供從領先的 AI 公司和亞馬遜挑選的高效能基礎模型（Foundation Models，FMs）的存取權。

2. 這些模型可用於多種生成式 AI 應用場景，如文字生成、影像辨識、自然語言處理等。

<br>

## 檢查和設定存取權限

_創建 AWS IAM 使用者及訪問密鑰_

<br>

1. 在 AWS 管理控制台中建立一個新的 IAM 用戶，並產生存取金鑰（Access Key ID 和 Secret Access Key）。

<br>
    
2. 將這些金鑰儲存到 `.env` 檔案中。

    ```bash
    AWS_ACCESS_KEY_ID=your_access_key_id
    AWS_SECRET_ACCESS_KEY=your_secret_access_key
    AWS_REGION=us-west-2
    ```

<br>

3. 配置訪問權限，在 IAM 用戶附加自定義的策略，確保該使用者可以存取所需的模型。

    ```json
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Action": [
                    "bedrock:InvokeModel",
                    "bedrock:ListFoundationModels",
                    "bedrock:GetFoundationModel"
                ],
                "Resource": "*"
            }
        ]
    }
    ```

<br>

## 檢查模型存取權限

1. 腳本。

    ```python
    import os
    import boto3
    from botocore.exceptions import ClientError
    from dotenv import load_dotenv

    # 加载环境变量
    load_dotenv()

    def list_available_models():
        aws_access_key_id = os.getenv("AWS_ACCESS_KEY_ID")
        aws_secret_access_key = os.getenv("AWS_SECRET_ACCESS_KEY")
        region_name = os.getenv("AWS_REGION")

        client = boto3.client(
            "bedrock",
            aws_access_key_id=aws_access_key_id,
            aws_secret_access_key=aws_secret_access_key,
            region_name=region_name,
        )

        try:
            response = client.list_foundation_models()
            models = response.get('models', [])
            if models:
                print("可用模型：")
                for model in models:
                    print(f"模型 ID: {model['modelId']}, 名称: {model['name']}")
            else:
                print("没有找到可用模型。")
        except ClientError as e:
            print(f"错误: {e.response['Error']['Message']}")
        except Exception as e:
            print(f"意外错误: {e}")

    if __name__ == "__main__":
        list_available_models()
    ```

<br>

## 應用範例

_以下是使用 Amazon Bedrock 和 Streamlit 建立食譜產生器的範例腳本：_

<br>

1. 程式碼。

    ```python
    import os
    from dotenv import load_dotenv
    from langchain_core.prompts import PromptTemplate
    from langchain.chains import LLMChain
    from transformers import pipeline
    import streamlit as st
    from langchain.llms.bedrock import Bedrock

    # 设置 Streamlit 页面的配置
    PAGE_CONFIG = {
        "page_title": "Image to Recipe",
        "page_icon": ":chef:",
        "layout": "centered",
    }
    st.set_page_config(PAGE_CONFIG)
    st.markdown(
        """
        <style>
            body {
                background-color: #fafafa;
                color: #333;
            }
            h1, h2 {
                color: #ff6347;
            }
            .fileUploader .btn {
                background-color: #ff6347;
                color: white;
            }
        </style>
        """,
        unsafe_allow_html=True,
    )

    # 载入 .env 文件中的环境变量
    load_dotenv()

    def get_llm():
        bedrock_llm = Bedrock(
            model_id="anthropic.claude-v2",
            model_kwargs={
                "temperature": 0.7,
                "max_tokens_to_sample": 1024
            }
        )
        return bedrock_llm

    # 生成图片描述
    def image_to_text(url):
        with st.spinner("Processing image..."):
            pipe = pipeline(
                "image-to-text",
                model="Salesforce/blip-image-captioning-large",
                max_new_tokens=1000,
            )
            text = pipe(url)[0]["generated_text"]
        return text

    # 生成食谱
    def generate_recipe(ingredients):
        template = """
        你是一位极为博学的营养师、健美运动员和厨师，精通一切关于最佳快速健康食谱的知识。
        你了解所有关于健康食品、保持身材苗条和帮助肌肉生长的健康食谱，以及减少顽固脂肪的一切知识。
        你还训练了许多顶尖健美运动员，他们拥有极为出色的体格。
        你明白如何帮助那些时间和食材都有限的人快速做出餐点。
        你的工作是协助用户找到最佳的食谱和烹饪指导，取决于以下变量：
        {ingredients}

        当找到最佳食谱和烹饪指导时，
        你会自信且直截了当地回答。
        在制定食谱和指导时，请记住5-10分钟的时间限制。

        如果 {ingredients} 少于3种，可以添加一些能补充健康餐点的食材。

        请确保你的回答格式如下：

        - 用餐名称作为粗体标题（换行）

        - 最佳食谱类别（粗体）

        - 准备时间（标题）

        - 难度（粗体）：
            简单

        - 食材（粗体）
            列出所有食材

        - 所需厨房工具（粗体）
            列出所需的厨房工具

        - 烹饪指导（粗体）
            列出所有制作餐点的指导步骤

        - 营养成分（粗体）：
            总卡路里
            列出每种食材的卡路里
            列出所有营养成分

        请务必简明扼要。
        使指导易于理解并逐步进行。
        """
        try:
            prompt = PromptTemplate(
                template=template,
                input_variables=["ingredients"]
            )
            llm = get_llm()
            recipe_chain = LLMChain(
                llm=llm, prompt=prompt, verbose=True
            )
            recipe = recipe_chain.run(ingredients)
            return recipe
        except Exception as e:
            return f"Error: {e}"

    def main():
        st.markdown(
            "<h1 style='text-align: center; color: red;'>🍲 食谱生成器 🍲</h1>",
            unsafe_allow_html=True,
        )
        upload_file = st.file_uploader(
            "选择一张图片：", type=["jpg", "png"], accept_multiple_files=False
        )
        if upload_file is not None:
            file_bytes = upload_file.getvalue()
            with open(upload_file.name, "wb") as file:
                file.write(file_bytes)

            st.image(
                upload_file,
                caption="The uploaded image",
                use_column_width=True,
                width=250
            )

            st.markdown("### 🥗 图片中的原料")
            ingredients = image_to_text(upload_file.name)
            with st.expander("图片描述 👀"):
                st.write(ingredients.capitalize())

            st.markdown("### 📋 食谱")
            recipe = generate_recipe(ingredients=ingredients)
            with st.expander("烹饪指南 👀"):
                st.write(recipe)

    if __name__ == "__main__":
        load_dotenv()
        main()
    ```

<br>

## 解決訪問權問題

_如果在執行腳本時遇到 `AccessDeniedException` 錯誤，檢查已經按照下列步驟正確設定存取權限。_

<br>

1. 確認模型存取權限：確保 AWS 帳戶中已為所需模型請求了存取權限。在 AWS Bedrock 控制台中，選擇 `Model access`，然後啟用所需模型的存取權限。

<br>

2. 檢查 IAM 權限：確保 IAM 使用者或角色附加了正確的策略，允許其存取和呼叫 Amazon Bedrock 服務中的模型。

<br>

3. 使用正確的 AWS 區域：某些模型僅在特定區域可用，確認使用的區域是否支援所需的模型。

<br>

___

_END_
