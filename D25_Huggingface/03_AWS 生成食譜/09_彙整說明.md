# å½™æ•´ä»¥ä¸Šçš„èªªæ˜

<br>

## ç°¡ä»‹

1. Amazon Bedrock æ˜¯ AWS æä¾›çš„ä¸€é …å…¨è¨—ç®¡æœå‹™ï¼Œæ—¨åœ¨è¿…é€Ÿä½¿ç”¨å’Œæ“´å±•ç”Ÿæˆå¼ AI æ‡‰ç”¨ç¨‹å¼ï¼Œé€éçµ±ä¸€çš„ APIï¼ŒBedrock æä¾›å¾é ˜å…ˆçš„ AI å…¬å¸å’Œäºé¦¬éœæŒ‘é¸çš„é«˜æ•ˆèƒ½åŸºç¤æ¨¡å‹ï¼ˆFoundation Modelsï¼ŒFMsï¼‰çš„å­˜å–æ¬Šã€‚

2. é€™äº›æ¨¡å‹å¯ç”¨æ–¼å¤šç¨®ç”Ÿæˆå¼ AI æ‡‰ç”¨å ´æ™¯ï¼Œå¦‚æ–‡å­—ç”Ÿæˆã€å½±åƒè¾¨è­˜ã€è‡ªç„¶èªè¨€è™•ç†ç­‰ã€‚

<br>

## æª¢æŸ¥å’Œè¨­å®šå­˜å–æ¬Šé™

_å‰µå»º AWS IAM ä½¿ç”¨è€…åŠè¨ªå•å¯†é‘°_

<br>

1. åœ¨ AWS ç®¡ç†æ§åˆ¶å°ä¸­å»ºç«‹ä¸€å€‹æ–°çš„ IAM ç”¨æˆ¶ï¼Œä¸¦ç”¢ç”Ÿå­˜å–é‡‘é‘°ï¼ˆAccess Key ID å’Œ Secret Access Keyï¼‰ã€‚

<br>
    
2. å°‡é€™äº›é‡‘é‘°å„²å­˜åˆ° `.env` æª”æ¡ˆä¸­ã€‚

    ```bash
    AWS_ACCESS_KEY_ID=your_access_key_id
    AWS_SECRET_ACCESS_KEY=your_secret_access_key
    AWS_REGION=us-west-2
    ```

<br>

3. é…ç½®è¨ªå•æ¬Šé™ï¼Œåœ¨ IAM ç”¨æˆ¶é™„åŠ è‡ªå®šç¾©çš„ç­–ç•¥ï¼Œç¢ºä¿è©²ä½¿ç”¨è€…å¯ä»¥å­˜å–æ‰€éœ€çš„æ¨¡å‹ã€‚

    ```json
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Action": [
                    "bedrock:InvokeModel",
                    "bedrock:ListFoundationModels",
                    "bedrock:GetFoundationModel"
                ],
                "Resource": "*"
            }
        ]
    }
    ```

<br>

## æª¢æŸ¥æ¨¡å‹å­˜å–æ¬Šé™

1. è…³æœ¬ã€‚

    ```python
    import os
    import boto3
    from botocore.exceptions import ClientError
    from dotenv import load_dotenv

    # åŠ è½½ç¯å¢ƒå˜é‡
    load_dotenv()

    def list_available_models():
        aws_access_key_id = os.getenv("AWS_ACCESS_KEY_ID")
        aws_secret_access_key = os.getenv("AWS_SECRET_ACCESS_KEY")
        region_name = os.getenv("AWS_REGION")

        client = boto3.client(
            "bedrock",
            aws_access_key_id=aws_access_key_id,
            aws_secret_access_key=aws_secret_access_key,
            region_name=region_name,
        )

        try:
            response = client.list_foundation_models()
            models = response.get('models', [])
            if models:
                print("å¯ç”¨æ¨¡å‹ï¼š")
                for model in models:
                    print(f"æ¨¡å‹ ID: {model['modelId']}, åç§°: {model['name']}")
            else:
                print("æ²¡æœ‰æ‰¾åˆ°å¯ç”¨æ¨¡å‹ã€‚")
        except ClientError as e:
            print(f"é”™è¯¯: {e.response['Error']['Message']}")
        except Exception as e:
            print(f"æ„å¤–é”™è¯¯: {e}")

    if __name__ == "__main__":
        list_available_models()
    ```

<br>

## æ‡‰ç”¨ç¯„ä¾‹

_ä»¥ä¸‹æ˜¯ä½¿ç”¨ Amazon Bedrock å’Œ Streamlit å»ºç«‹é£Ÿè­œç”¢ç”Ÿå™¨çš„ç¯„ä¾‹è…³æœ¬ï¼š_

<br>

1. ç¨‹å¼ç¢¼ã€‚

    ```python
    import os
    from dotenv import load_dotenv
    from langchain_core.prompts import PromptTemplate
    from langchain.chains import LLMChain
    from transformers import pipeline
    import streamlit as st
    from langchain.llms.bedrock import Bedrock

    # è®¾ç½® Streamlit é¡µé¢çš„é…ç½®
    PAGE_CONFIG = {
        "page_title": "Image to Recipe",
        "page_icon": ":chef:",
        "layout": "centered",
    }
    st.set_page_config(PAGE_CONFIG)
    st.markdown(
        """
        <style>
            body {
                background-color: #fafafa;
                color: #333;
            }
            h1, h2 {
                color: #ff6347;
            }
            .fileUploader .btn {
                background-color: #ff6347;
                color: white;
            }
        </style>
        """,
        unsafe_allow_html=True,
    )

    # è½½å…¥ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡
    load_dotenv()

    def get_llm():
        bedrock_llm = Bedrock(
            model_id="anthropic.claude-v2",
            model_kwargs={
                "temperature": 0.7,
                "max_tokens_to_sample": 1024
            }
        )
        return bedrock_llm

    # ç”Ÿæˆå›¾ç‰‡æè¿°
    def image_to_text(url):
        with st.spinner("Processing image..."):
            pipe = pipeline(
                "image-to-text",
                model="Salesforce/blip-image-captioning-large",
                max_new_tokens=1000,
            )
            text = pipe(url)[0]["generated_text"]
        return text

    # ç”Ÿæˆé£Ÿè°±
    def generate_recipe(ingredients):
        template = """
        ä½ æ˜¯ä¸€ä½æä¸ºåšå­¦çš„è¥å…»å¸ˆã€å¥ç¾è¿åŠ¨å‘˜å’Œå¨å¸ˆï¼Œç²¾é€šä¸€åˆ‡å…³äºæœ€ä½³å¿«é€Ÿå¥åº·é£Ÿè°±çš„çŸ¥è¯†ã€‚
        ä½ äº†è§£æ‰€æœ‰å…³äºå¥åº·é£Ÿå“ã€ä¿æŒèº«æè‹—æ¡å’Œå¸®åŠ©è‚Œè‚‰ç”Ÿé•¿çš„å¥åº·é£Ÿè°±ï¼Œä»¥åŠå‡å°‘é¡½å›ºè„‚è‚ªçš„ä¸€åˆ‡çŸ¥è¯†ã€‚
        ä½ è¿˜è®­ç»ƒäº†è®¸å¤šé¡¶å°–å¥ç¾è¿åŠ¨å‘˜ï¼Œä»–ä»¬æ‹¥æœ‰æä¸ºå‡ºè‰²çš„ä½“æ ¼ã€‚
        ä½ æ˜ç™½å¦‚ä½•å¸®åŠ©é‚£äº›æ—¶é—´å’Œé£Ÿæéƒ½æœ‰é™çš„äººå¿«é€Ÿåšå‡ºé¤ç‚¹ã€‚
        ä½ çš„å·¥ä½œæ˜¯ååŠ©ç”¨æˆ·æ‰¾åˆ°æœ€ä½³çš„é£Ÿè°±å’Œçƒ¹é¥ªæŒ‡å¯¼ï¼Œå–å†³äºä»¥ä¸‹å˜é‡ï¼š
        {ingredients}

        å½“æ‰¾åˆ°æœ€ä½³é£Ÿè°±å’Œçƒ¹é¥ªæŒ‡å¯¼æ—¶ï¼Œ
        ä½ ä¼šè‡ªä¿¡ä¸”ç›´æˆªäº†å½“åœ°å›ç­”ã€‚
        åœ¨åˆ¶å®šé£Ÿè°±å’ŒæŒ‡å¯¼æ—¶ï¼Œè¯·è®°ä½5-10åˆ†é’Ÿçš„æ—¶é—´é™åˆ¶ã€‚

        å¦‚æœ {ingredients} å°‘äº3ç§ï¼Œå¯ä»¥æ·»åŠ ä¸€äº›èƒ½è¡¥å……å¥åº·é¤ç‚¹çš„é£Ÿæã€‚

        è¯·ç¡®ä¿ä½ çš„å›ç­”æ ¼å¼å¦‚ä¸‹ï¼š

        - ç”¨é¤åç§°ä½œä¸ºç²—ä½“æ ‡é¢˜ï¼ˆæ¢è¡Œï¼‰

        - æœ€ä½³é£Ÿè°±ç±»åˆ«ï¼ˆç²—ä½“ï¼‰

        - å‡†å¤‡æ—¶é—´ï¼ˆæ ‡é¢˜ï¼‰

        - éš¾åº¦ï¼ˆç²—ä½“ï¼‰ï¼š
            ç®€å•

        - é£Ÿæï¼ˆç²—ä½“ï¼‰
            åˆ—å‡ºæ‰€æœ‰é£Ÿæ

        - æ‰€éœ€å¨æˆ¿å·¥å…·ï¼ˆç²—ä½“ï¼‰
            åˆ—å‡ºæ‰€éœ€çš„å¨æˆ¿å·¥å…·

        - çƒ¹é¥ªæŒ‡å¯¼ï¼ˆç²—ä½“ï¼‰
            åˆ—å‡ºæ‰€æœ‰åˆ¶ä½œé¤ç‚¹çš„æŒ‡å¯¼æ­¥éª¤

        - è¥å…»æˆåˆ†ï¼ˆç²—ä½“ï¼‰ï¼š
            æ€»å¡è·¯é‡Œ
            åˆ—å‡ºæ¯ç§é£Ÿæçš„å¡è·¯é‡Œ
            åˆ—å‡ºæ‰€æœ‰è¥å…»æˆåˆ†

        è¯·åŠ¡å¿…ç®€æ˜æ‰¼è¦ã€‚
        ä½¿æŒ‡å¯¼æ˜“äºç†è§£å¹¶é€æ­¥è¿›è¡Œã€‚
        """
        try:
            prompt = PromptTemplate(
                template=template,
                input_variables=["ingredients"]
            )
            llm = get_llm()
            recipe_chain = LLMChain(
                llm=llm, prompt=prompt, verbose=True
            )
            recipe = recipe_chain.run(ingredients)
            return recipe
        except Exception as e:
            return f"Error: {e}"

    def main():
        st.markdown(
            "<h1 style='text-align: center; color: red;'>ğŸ² é£Ÿè°±ç”Ÿæˆå™¨ ğŸ²</h1>",
            unsafe_allow_html=True,
        )
        upload_file = st.file_uploader(
            "é€‰æ‹©ä¸€å¼ å›¾ç‰‡ï¼š", type=["jpg", "png"], accept_multiple_files=False
        )
        if upload_file is not None:
            file_bytes = upload_file.getvalue()
            with open(upload_file.name, "wb") as file:
                file.write(file_bytes)

            st.image(
                upload_file,
                caption="The uploaded image",
                use_column_width=True,
                width=250
            )

            st.markdown("### ğŸ¥— å›¾ç‰‡ä¸­çš„åŸæ–™")
            ingredients = image_to_text(upload_file.name)
            with st.expander("å›¾ç‰‡æè¿° ğŸ‘€"):
                st.write(ingredients.capitalize())

            st.markdown("### ğŸ“‹ é£Ÿè°±")
            recipe = generate_recipe(ingredients=ingredients)
            with st.expander("çƒ¹é¥ªæŒ‡å— ğŸ‘€"):
                st.write(recipe)

    if __name__ == "__main__":
        load_dotenv()
        main()
    ```

<br>

## è§£æ±ºè¨ªå•æ¬Šå•é¡Œ

_å¦‚æœåœ¨åŸ·è¡Œè…³æœ¬æ™‚é‡åˆ° `AccessDeniedException` éŒ¯èª¤ï¼Œæª¢æŸ¥å·²ç¶“æŒ‰ç…§ä¸‹åˆ—æ­¥é©Ÿæ­£ç¢ºè¨­å®šå­˜å–æ¬Šé™ã€‚_

<br>

1. ç¢ºèªæ¨¡å‹å­˜å–æ¬Šé™ï¼šç¢ºä¿ AWS å¸³æˆ¶ä¸­å·²ç‚ºæ‰€éœ€æ¨¡å‹è«‹æ±‚äº†å­˜å–æ¬Šé™ã€‚åœ¨ AWS Bedrock æ§åˆ¶å°ä¸­ï¼Œé¸æ“‡ `Model access`ï¼Œç„¶å¾Œå•Ÿç”¨æ‰€éœ€æ¨¡å‹çš„å­˜å–æ¬Šé™ã€‚

<br>

2. æª¢æŸ¥ IAM æ¬Šé™ï¼šç¢ºä¿ IAM ä½¿ç”¨è€…æˆ–è§’è‰²é™„åŠ äº†æ­£ç¢ºçš„ç­–ç•¥ï¼Œå…è¨±å…¶å­˜å–å’Œå‘¼å« Amazon Bedrock æœå‹™ä¸­çš„æ¨¡å‹ã€‚

<br>

3. ä½¿ç”¨æ­£ç¢ºçš„ AWS å€åŸŸï¼šæŸäº›æ¨¡å‹åƒ…åœ¨ç‰¹å®šå€åŸŸå¯ç”¨ï¼Œç¢ºèªä½¿ç”¨çš„å€åŸŸæ˜¯å¦æ”¯æ´æ‰€éœ€çš„æ¨¡å‹ã€‚

<br>

___

_END_
