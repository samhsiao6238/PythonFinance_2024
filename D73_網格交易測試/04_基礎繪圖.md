# 基礎繪圖

<br>

## 準備工作

1. 安裝套件。

    ```bash
    pip install matplotlib -q
    ```

<br>

2. 查看當前系統支援的字型。

    ```python
    import matplotlib.font_manager
    print([
        f.name for f in matplotlib.font_manager.fontManager.ttflist
    ])
    ```

    ![](images/img_12.png)

<br>

## 腳本

_開啟新的筆記本_

<br>

1. 載入套件與字型，這裡使用 macOS 系統自帶的 `繁體黑體` 字體。

    ```python
    import yfinance as yf
    import pandas as pd
    import matplotlib

    # 更改為可用字型名稱
    matplotlib.rc('font', family='Heiti TC')
    ```

<br>

2. 繪製折線圖。

    ```python
    # 商品名稱
    prod = "2303.TW"
    # 取得全部資料
    data = yf.download(prod, period="max")
    # 繪製折線圖
    data['Close'].plot(label='收盤價',legend=True)
    ```

    ![](images/img_13.png)

<br>

3. 繪製多條線。

    ```python
    import matplotlib.pyplot as plt

    # 建立一個新圖表
    plt.figure(figsize=(10, 6))

    # 使用 plt.plot 繪圖
    plt.plot(
        (data['Close'].pct_change() + 1).cumprod(), 
        label='報酬率', 
        linewidth=2
    )
    # 繪製第二條線
    plt.plot(
        (data['Adj Close'].pct_change() + 1).cumprod(), 
        label='還原除權息後報酬率', 
        linewidth=2
    )

    # 添加標題和標籤
    plt.title("報酬率與還原除權息後報酬率", fontsize=14)
    plt.xlabel("Date", fontsize=12)
    plt.ylabel("累積報酬率", fontsize=12)

    # 添加圖例
    plt.legend(fontsize=12)

    # 添加網格
    plt.grid()

    # 顯示圖表
    plt.show()
    ```

    ![](images/img_14.png)

<br>

## 均線圖

1. 合併。

    ```python
    # 建立圖表
    plt.figure(figsize=(10, 6))

    # 繪製收盤價折線圖
    plt.plot(
        data.loc['2023':'2024', 'Close'], 
        label='收盤價', 
        linewidth=2
    )

    # 繪製20日移動平均線
    plt.plot(
        data.loc['2023':'2024', 'Close'].rolling(20).mean(), 
        label='月均線', 
        linewidth=2
    )

    # 繪製60日移動平均線
    plt.plot(
        data.loc['2023':'2024', 'Close'].rolling(60).mean(), 
        label='季均線', 
        linewidth=2
    )

    # 添加標題和標籤
    plt.title("2023-2024 收盤價與均線", fontsize=14)
    plt.xlabel("Date", fontsize=12)
    plt.ylabel("價格", fontsize=12)

    # 添加圖例
    plt.legend(fontsize=12)

    # 添加網格
    plt.grid()

    # 顯示圖表
    plt.show()
    ```

    ![](images/img_15.png)

<br>

## OHLC 圖

1. 安裝套件。

    ```bash
    pip install mplfinance -q
    ```

<br>

2. 代碼。

    ```python
    import mplfinance as mpf
    # 簡化欄位名稱，移除 MultiIndex 的第二層索引
    data.columns = data.columns.droplevel(1)

    # 清理資料，將 Open 欄位轉換為數值
    data['Open'] = pd.to_numeric(data['Open'], errors='coerce')
    # 移除 NaN 值
    data = data.dropna(subset=['Open'])

    # 繪製線圖，最後 10 筆資料
    mpf.plot(data.iloc[-10:])
    ```

    ![](images/img_16.png)

<br>

# K 線圖

_蠟燭圖_

<br>

1. 基礎圖形。

    ```python
    mpf.plot(data.iloc[-10:], type="candle")
    ```

    ![](images/img_17.png)

<br>

2. 列出 mplfinance 中支持的所有樣式。

    ```python
    print(mpf.available_styles())
    ```

    ![](images/img_18.png)

<br>

3. 調整樣式。

    ```python
    mpf.plot(
        data.iloc[-10:], 
        type="candle", 
        style="yahoo"
    )
    ```

    ![](images/img_19.png)

<br>

4. 轉換 K 線顏色與台灣相同，上漲以紅色表示、下跌以綠色表示。

    ```python
    mcolor = mpf.make_marketcolors(
        up="r", down="g", inherit=True
    )
    mstyle = mpf.make_mpf_style(
        base_mpf_style="yahoo", 
        marketcolors=mcolor
    )
    mpf.plot(
        data.iloc[-10:], 
        type="candle", 
        style=mstyle
    )
    ```

    ![](images/img_20.png)

<br>

## 繪製 K 線圖與移動均線

1. 代碼。

    ```python
    from matplotlib import font_manager as fm

    # 設定字型為 Heiti TC
    font_prop = fm.FontProperties(family='Heiti TC')

    # 取得全部資料
    data = yf.download(prod, period="max")

    # 簡化欄位名稱（將 MultiIndex 轉換為單層索引）
    data.columns = data.columns.droplevel(1)

    # 確保數據欄位為數字，移除非數字值
    data = data.dropna(subset=[
        "Open", "High", "Low", "Close", "Volume"
    ])
    data = data.astype({
        "Open": "float", 
        "High": "float", 
        "Low": "float", 
        "Close": "float", 
        "Volume": "float"
    })

    # 修改 K 線顏色，上漲紅，下跌綠
    mcolor = mpf.make_marketcolors(
        up="r", down="g", inherit=True
    )
    mstyle = mpf.make_mpf_style(
        base_mpf_style="yahoo", 
        marketcolors=mcolor
    )

    # 計算移動平均線
    data["5ma"] = data["Close"].rolling(5).mean()
    data["20ma"] = data["Close"].rolling(20).mean()
    data["60ma"] = data["Close"].rolling(60).mean()

    # 選取最近 200 筆資料
    data = data.iloc[-200:].copy()

    # 添加移動平均線
    addp = [
        mpf.make_addplot(data["5ma"], color="blue", width=1),
        mpf.make_addplot(data["20ma"], color="orange", width=1),
        mpf.make_addplot(data["60ma"], color="green", width=1),
    ]

    # 繪製蠟燭圖
    fig, axlist = mpf.plot(
        data,
        type="candle",
        style=mstyle,
        addplot=addp,
        ylabel="Price",
        volume=True,
        figratio=(12, 6),
        # 返回圖形對象
        returnfig=True
    )

    # 手動設置標題字型
    axlist[0].set_title(
        "2303.TW 蠟燭圖與移動平均線", fontproperties=font_prop
    )
    # 設定 Y 軸標題，並指定字型
    axlist[0].set_ylabel(
        "價格 (Price)", fontproperties=font_prop
    )
    # 第二個軸是成交量
    axlist[2].set_ylabel(
        "成交量 (Volume)", fontproperties=font_prop
    )

    plt.show()
    ```

    ![](images/img_21.png)

<br>

___

_END_