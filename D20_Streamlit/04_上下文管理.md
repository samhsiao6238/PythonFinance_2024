# 上下文管理器

<br>

## 說明

1. 在 Python 中，`with` 語句本身並不是上下文管理器，而是透過 `with` 來實現 `上下文管理協定`（context management protocol），常簡稱 `上下文管理`，它的實現依賴於 Python 的 `__enter__` 和 `__exit__` 等魔法方法。

<br>

2. 透過上下文管理可包裝程式碼的執行，確保了無論如何退出程式碼區塊，包含因為錯誤退出或還正常結束，都可以執行 `清理緩存` 的工作，將資源釋放或還原狀態。

<br>

## 定義

1. 一個 `上下文管理器` 是一個包含了 `__enter__` 和 `__exit__` 方法的物件，當進入 `with` 語句區塊時，會呼叫上下文管理器的 `__enter__` 方法，而當離開 `with` 語句區塊時，無論是異常還是正常結束，都會呼叫 `__exit__` 方法。

<br>

2. 當程式碼執行到 `with` 語句時，會先呼叫上下文管理器的 `__enter__` 方法，`__enter__` 方法的回傳值通常會被賦給 `with` 語句中 `as` 後面的變數，當然前提是建立了該變數。

<br>

3.執行 `with` 語句內部的程式碼區塊時，無論是否拋出了異常，`__exit__` 方法都會在程式碼區塊執行完畢後被呼叫，如果程式碼區塊執行過程中發生異常，則異常類型、值和追蹤資訊會作為參數傳遞給 `__exit__` 方法，`__exit__` 方法可以選擇處理異常，並傳回 `True` 表示異常已處理不需要進一步拋出，或傳回 `None` 或 `False` 讓異常被正常拋出。

<br>

## 範例

1. 假設在 Streamlit 範例中，使用 `st.chat_message("user")` 上下文管理器實例並傳入參數 `user`，這個上下文管理器定義進入和退出該如何進行操作，例如設定聊天氣泡的樣式，並在退出時恢復到先前的狀態。

    ```python
    with st.chat_message("user"):
        st.write("Hello, World!")
    ```

<br>

2. 在這個例子中：

   - `st.chat_message("user")` 實例的 `__enter__` 方法會在進入 `with` 語句時被調用，可能設定了特定的樣式或準備操作。

   - `st.write("Hello, World!")` 在這個設定的上下文中執行。

   - `__exit__` 方法會在 `with` 區塊完成後調用，進行清理工作，例如清除先前設定的樣式。

<br>

___

_END_