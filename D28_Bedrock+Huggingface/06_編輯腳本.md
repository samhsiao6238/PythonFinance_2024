# ç·¨è¼¯è…³æœ¬

<br>

## æ­¥é©Ÿèªªæ˜

1. å®‰è£å¥—ä»¶ã€‚

    ```bash
    pip install boto3 transformers langchain-aws awscli
    ```

<br>

2. ç¨‹å¼ç¢¼ï¼Œé€™æ˜¯å®Œæ•´å¯é‹è¡Œçš„è…³æœ¬ã€‚

    ```python
    import os
    from dotenv import load_dotenv
    # ç”¨æ–¼ç”Ÿæˆæç¤ºæ¨¡æ¿
    from langchain_core.prompts import PromptTemplate
    # è™•ç†å¤§èªè¨€æ¨¡å‹éˆ
    from langchain.chains import LLMChain
    # ç”¨æ–¼ç”Ÿæˆå„ç¨®è‡ªç„¶èªè¨€è™•ç†ç®¡é“
    from transformers import pipeline
    import streamlit as st
    # ç”¨æ–¼é€£æ¥ Amazon Bedrock
    from langchain_aws import BedrockLLM

    # ç’°å¢ƒåƒæ•¸
    load_dotenv()

    PAGE_CONFIG = {
        # é é¢æ¨™é¡Œ
        "page_title": "Image to Recipe",
        # é é¢åœ–æ¨™
        "page_icon": ":chef:",
        # é é¢ä½ˆå±€ç‚ºå±…ä¸­
        "layout": "centered",
    }
    # è¨­å®šé é¢é…ç½®
    st.set_page_config(
        page_title=PAGE_CONFIG["page_title"],
        page_icon=PAGE_CONFIG["page_icon"],
        layout=PAGE_CONFIG["layout"],
    )
    #
    st.markdown(
        """
        <style>
            body {
                /*è¨­å®šé é¢çš„èƒŒæ™¯é¡è‰²*/
                background-color: #fafafa;
                /*è¨­å®šé é¢çš„å­—é«”é¡è‰²*/
                color: #333;
            }
            h1, h2 {
                /*è¨­å®šæ¨™é¡Œçš„å­—é«”é¡è‰²*/
                color: #ff6347;
            }
            .fileUploader .btn {
                /*è¨­å®šä¸Šå‚³æŒ‰éˆ•çš„èƒŒæ™¯é¡è‰²*/
                background-color: #ff6347;
                /*è¨­å®šä¸Šå‚³æŒ‰éˆ•çš„å­—é«”é¡è‰²*/
                color: white;
            }
        </style>
        """,
        unsafe_allow_html=True,
    )


    # å®šç¾©å‡½æ•¸ä»¥å–å¾—å¤§èªè¨€æ¨¡å‹
    def get_llm():
        # ç„¡éœ€ç›´æ¥å‚³éAWSæ†‘è­‰
        bedrock_llm = BedrockLLM(
            # ä½¿ç”¨ Claude v2 æ¨¡å‹
            model_id="anthropic.claude-v2",
            # è¨­å®š AWS å€åŸŸ
            region_name=os.getenv("AWS_REGION"),
            # è¨­å®šæ¨¡å‹åƒæ•¸
            model_kwargs={
                "temperature": 0.7,
                "max_tokens_to_sample": 4096},
        )
        # è¿”å›å¤§èªè¨€æ¨¡å‹å¯¦ä¾‹
        return bedrock_llm


    # å®šç¾©å‡½æ•¸å°‡åœ–åƒè½‰æ›ç‚ºæ–‡å­—
    def image_to_text(url):
        # é¡¯ç¤ºè™•ç†ä¸­çš„æç¤º
        with st.spinner("Processing image..."):
            pipe = pipeline(
                "image-to-text",
                model="Salesforce/blip-image-captioning-large",
                max_new_tokens=1000,
            )
            # å–å¾—åœ–åƒç”Ÿæˆçš„æ–‡å­—
            text = pipe(url)[0]["generated_text"]
        # è¿”å›ç”Ÿæˆçš„æ–‡å­—
        return text


    # å®šç¾©å‡½æ•¸ç”Ÿæˆé£Ÿè­œ
    def generate_recipe(ingredients):
        template = """
        ä½ æ˜¯ä¸€ä½æ¥µç‚ºåšå­¸çš„ç‡Ÿé¤Šå¸«ã€å¥ç¾é‹å‹•å“¡å’Œå»šå¸«ï¼Œç²¾é€šä¸€åˆ‡é—œæ–¼æœ€ä½³å¿«é€Ÿå¥åº·é£Ÿè­œçš„çŸ¥è­˜ã€‚
        ä½ äº†è§£æ‰€æœ‰é—œæ–¼å¥åº·é£Ÿå“ã€ä¿æŒèº«æè‹—æ¢å’Œå¹«åŠ©è‚Œè‚‰ç”Ÿé•·çš„å¥åº·é£Ÿè­œï¼Œä»¥åŠæ¸›å°‘é ‘å›ºè„‚è‚ªçš„ä¸€åˆ‡çŸ¥è­˜ã€‚
        ä½ é‚„è¨“ç·´äº†è¨±å¤šé ‚å°–å¥ç¾é‹å‹•å“¡ï¼Œä»–å€‘æ“æœ‰æ¥µç‚ºå‡ºè‰²çš„é«”æ ¼ã€‚
        ä½ æ˜ç™½å¦‚ä½•å¹«åŠ©é‚£äº›æ™‚é–“å’Œé£Ÿæéƒ½æœ‰é™çš„äººå¿«é€Ÿåšå‡ºé¤é»ã€‚
        ä½ çš„å·¥ä½œæ˜¯å”åŠ©ç”¨æˆ¶æ‰¾åˆ°æœ€ä½³çš„é£Ÿè­œå’Œçƒ¹é£ªæŒ‡å°ï¼Œå–æ±ºæ–¼ä»¥ä¸‹è®Šé‡ï¼š
        {ingredients}

        ç•¶æ‰¾åˆ°æœ€ä½³é£Ÿè­œå’Œçƒ¹é£ªæŒ‡å°æ™‚ï¼Œ
        ä½ æœƒè‡ªä¿¡ä¸”ç›´æˆªäº†ç•¶åœ°å›ç­”ã€‚
        åœ¨åˆ¶å®šé£Ÿè­œå’ŒæŒ‡å°æ™‚ï¼Œè«‹è¨˜ä½5-10åˆ†é˜çš„æ™‚é–“é™åˆ¶ã€‚

        å¦‚æœ {ingredients} å°‘æ–¼3ç¨®ï¼Œå¯ä»¥æ·»åŠ ä¸€äº›èƒ½è£œå……å¥åº·é¤é»çš„é£Ÿæã€‚

        è«‹ç¢ºä¿ä½ çš„å›ç­”æ ¼å¼å¦‚ä¸‹ï¼š

        - ç”¨é¤åç¨±ä½œç‚ºç²—é«”æ¨™é¡Œï¼ˆæ›è¡Œï¼‰

        - æœ€ä½³é£Ÿè­œé¡åˆ¥ï¼ˆç²—é«”ï¼‰

        - æº–å‚™æ™‚é–“ï¼ˆæ¨™é¡Œï¼‰

        - é›£åº¦ï¼ˆç²—é«”ï¼‰ï¼š
            ç°¡å–®

        - é£Ÿæï¼ˆç²—é«”ï¼‰
            åˆ—å‡ºæ‰€æœ‰é£Ÿæ

        - æ‰€éœ€å»šæˆ¿å·¥å…·ï¼ˆç²—é«”ï¼‰
            åˆ—å‡ºæ‰€éœ€çš„å»šæˆ¿å·¥å…·

        - çƒ¹é£ªæŒ‡å°ï¼ˆç²—é«”ï¼‰
            åˆ—å‡ºæ‰€æœ‰è£½ä½œé¤é»çš„æŒ‡å°æ­¥é©Ÿ

        - ç‡Ÿé¤Šæˆåˆ†ï¼ˆç²—é«”ï¼‰ï¼š
            ç¸½å¡è·¯é‡Œ
            åˆ—å‡ºæ¯ç¨®é£Ÿæçš„å¡è·¯é‡Œ
            åˆ—å‡ºæ‰€æœ‰ç‡Ÿé¤Šæˆåˆ†

        è«‹å‹™å¿…ç°¡æ˜æ‰¼è¦ã€‚
        ä½¿æŒ‡å°æ˜“æ–¼ç†è§£ä¸¦é€æ­¥é€²è¡Œã€‚
        """

        # é¡¯ç¤ºè™•ç†ä¸­çš„æç¤º
        with st.spinner("Making the recipe for you..."):
            prompt = PromptTemplate(
                template=template,
                input_variables=["ingredients"]
            )
            llm = get_llm()
            recipe_chain = LLMChain(
                llm=llm,
                prompt=prompt,
                verbose=True
            )
            recipe = recipe_chain.run(ingredients)

        return recipe


    def main():

        st.markdown(
            "<h1 style='text-align: center; color: red;'>"
            "ğŸ² Recipe Generator ğŸ² </h1>",
            unsafe_allow_html=True,
        )

        st.markdown(
            "<h2 style='text-align: center; font-size: 24px;"
            " color: white'>ä½¿ç”¨&nbsp;&nbsp;<span style='color: orange;'>"
            "Amazon Bedrock</span></h2>",
            unsafe_allow_html=True,
        )

        upload_file = st.file_uploader(
            "é¸æ“‡åœ–ç‰‡ï¼š",
            type=["jpg", "png"],
            accept_multiple_files=False
        )

        if upload_file is not None:
            file_bytes = upload_file.getvalue()
            with open(upload_file.name, "wb") as file:
                file.write(file_bytes)

            st.image(
                upload_file,
                caption="The uploaded image",
                use_column_width=True,
                width=250
            )

            st.markdown("### ğŸ¥— ç›¸ç‰‡ä¸­çš„åŸæ–™")
            ingredients = image_to_text(upload_file.name)
            with st.expander("åŸæ–™ ğŸ‘€"):
                st.write(ingredients.capitalize())

            st.markdown("### ğŸ“‹ é£Ÿè­œ")
            recipe = generate_recipe(ingredients=ingredients)
            with st.expander("çƒ¹é£ªèªªæ˜ ğŸ‘€"):
                st.write(recipe)

            os.remove(upload_file.name)


    if __name__ == "__main__":
        load_dotenv()
        main()

    ```

<br>

## èªªæ˜äº‹é …

_é‡å°å®˜ç¶²ç¯„ä¾‹çš„ä¿®æ­£_

<br>

1. PromptTemplate æ‡‰å¾ langchain_core.prompts å¼•å…¥ã€‚

2. LLMChain æ‡‰å¾ langchain.chains å¼•å…¥ã€‚

3. Bedrock æ‡‰å¾ langchain_community.llms å¼•å…¥ã€‚

4. st.set_page_config éœ€è¦ä½¿ç”¨é—œéµå­—åƒæ•¸ï¼Œè€Œä¸æ˜¯å°‡å­—å…¸ç›´æ¥å‚³éçµ¦å®ƒã€‚

5. æ›´æ–° Bedrock å°å…¥ï¼Œæ‡‰è©²å¾ langchain_aws æ¨¡çµ„è€Œä¸æ˜¯ langchain_community æ¨¡çµ„å°å…¥ BedrockLLMã€‚ 

<br>

## é‹è¡Œè…³æœ¬

1. Streamlit å°ˆæ¡ˆé€éçµ‚ç«¯æ©Ÿé‹è¡Œã€‚

    ```bash
    streamlit run app.py
    ```

<br>

2. æœƒå•Ÿå‹•å¦‚ä¸‹ç¶²é ã€‚

    ![](images/img_09.png)

<br>

3. ä¸Šå‚³åœ–ç‰‡å¾Œï¼Œçµ‚ç«¯æ©Ÿæœƒé¡¯ç¤ºè³‡è¨Šã€‚

    ![](images/img_46.png)

<br>

4. å®Œæˆå¾Œå¯ä»¥åœ¨ç¶²é ä¸­é€éä¸‹æ‹‰é¸å–®æŸ¥çœ‹çµæœã€‚

    ![](images/img_47.png)

<br>

## é—œæ–¼è­¦å‘Šè¨Šæ¯

1. é‹è¡Œæ™‚æœƒå‡ºç¾ä»¥ä¸‹è­¦å‘Šã€‚

    ```bash
    /Users/samhsiao/Documents/PythonVenv/envllmChatBot/lib/python3.11/site-packages/langchain_core/_api/deprecation.py:119: LangChainDeprecationWarning: The class `LLMChain` was deprecated in LangChain 0.1.17 and will be removed in 0.3.0. Use RunnableSequence, e.g., `prompt | llm` instead.
    warn_deprecated(
    /Users/samhsiao/Documents/PythonVenv/envllmChatBot/lib/python3.11/site-packages/langchain_core/_api/deprecation.py:119: LangChainDeprecationWarning: The method `Chain.run` was deprecated in langchain 0.1.0 and will be removed in 0.3.0. Use invoke instead.
    warn_deprecated(
    ```

<br>

2. `LLMChain` é¡åœ¨ LangChain ç‰ˆæœ¬ 0.1.17 ä¸­å·²è¢«æ£„ç”¨ï¼Œä¸¦å°‡åœ¨ 0.3.0 ç‰ˆæœ¬ä¸­ç§»é™¤ï¼Œå»ºè­°æ›¿ä»£ä½¿ç”¨ `RunnableSequence`ï¼Œä¾‹å¦‚ `prompt | llm`ã€‚

<br>

3. `Chain.run` æ–¹æ³•åœ¨ LangChain ç‰ˆæœ¬ 0.1.0 ä¸­å·²è¢«æ£„ç”¨ï¼Œä¸¦å°‡åœ¨ 0.3.0 ç‰ˆæœ¬ä¸­ç§»é™¤ï¼Œå»ºè­°ä½¿ç”¨ `invoke` æ–¹æ³•ã€‚

<br>

## é‡å°è­¦å‘Šé€²è¡Œæ›´æ–°

1. æ›¿æ› `LLMChain`ã€‚

    ```python
    # ç”¨æ–¼ç”Ÿæˆæç¤ºæ¨¡æ¿
    # from langchain_core.prompts import PromptTemplate
    # è™•ç†å¤§èªè¨€æ¨¡å‹éˆ
    # from langchain.chains import LLMChain
    
    # ä¿®æ”¹ç‚º
    # ç”¨æ–¼ç”Ÿæˆæç¤ºæ¨¡æ¿
    from langchain_core.prompts import PromptTemplate
    ```

<br>

2. æ›¿æ› `Chain.run`ã€‚

    ```python
    # èˆŠæ–¹æ³•
    # recipe_chain = LLMChain(
    #     llm=llm,
    #     prompt=prompt,
    #     verbose=True
    # )
    # recipe = recipe_chain.run(ingredients)

    # ä¿®æ”¹ç‚º
    recipe_chain = prompt | llm
    recipe = recipe_chain.invoke({"ingredients": ingredients})
    ```

<br>

3. æ›´æ–°å¥—ä»¶ã€‚

    ```bash
    pip install --upgrade transformers
    ```

<br>

4. ä¿®æ”¹å¾Œçš„å®Œæ•´ç¨‹å¼ç¢¼ã€‚

    ```python
    import os
    from dotenv import load_dotenv
    # ç”¨æ–¼ç”Ÿæˆæç¤ºæ¨¡æ¿
    from langchain_core.prompts import PromptTemplate
    # ç”¨æ–¼ç”Ÿæˆå„ç¨®è‡ªç„¶èªè¨€è™•ç†ç®¡é“
    from transformers import pipeline
    import streamlit as st
    # ç”¨æ–¼é€£æ¥ Amazon Bedrock
    from langchain_aws import BedrockLLM

    # ç’°å¢ƒåƒæ•¸
    load_dotenv()


    # å®šç¾©å‡½æ•¸ä»¥å–å¾—å¤§èªè¨€æ¨¡å‹
    def get_llm():
        bedrock_llm = BedrockLLM(
            model_id="anthropic.claude-v2",
            region_name=os.getenv("AWS_REGION"),
            model_kwargs={"temperature": 0.7, "max_tokens_to_sample": 4096},
        )
        return bedrock_llm


    # å®šç¾©å‡½æ•¸å°‡åœ–åƒè½‰æ›ç‚ºæ–‡å­—
    def image_to_text(url):
        # é¡¯ç¤ºè™•ç†ä¸­çš„æç¤º
        with st.spinner("Processing image..."):
            pipe = pipeline(
                "image-to-text",
                model="Salesforce/blip-image-captioning-large",
                max_new_tokens=1000,
            )
            # å–å¾—åœ–åƒç”Ÿæˆçš„æ–‡å­—
            text = pipe(url)[0]["generated_text"]
        # è¿”å›ç”Ÿæˆçš„æ–‡å­—
        return text


    # å®šç¾©å‡½æ•¸ç”Ÿæˆé£Ÿè­œ
    def generate_recipe(ingredients):
        template = """
        ä½ æ˜¯ä¸€ä½æ¥µç‚ºåšå­¸çš„ç‡Ÿé¤Šå¸«ã€å¥ç¾é‹å‹•å“¡å’Œå»šå¸«ï¼Œç²¾é€šä¸€åˆ‡é—œæ–¼æœ€ä½³å¿«é€Ÿå¥åº·é£Ÿè­œçš„çŸ¥è­˜ã€‚
        ä½ äº†è§£æ‰€æœ‰é—œæ–¼å¥åº·é£Ÿå“ã€ä¿æŒèº«æè‹—æ¢å’Œå¹«åŠ©è‚Œè‚‰ç”Ÿé•·çš„å¥åº·é£Ÿè­œï¼Œä»¥åŠæ¸›å°‘é ‘å›ºè„‚è‚ªçš„ä¸€åˆ‡çŸ¥è­˜ã€‚
        ä½ é‚„è¨“ç·´äº†è¨±å¤šé ‚å°–å¥ç¾é‹å‹•å“¡ï¼Œä»–å€‘æ“æœ‰æ¥µç‚ºå‡ºè‰²çš„é«”æ ¼ã€‚
        ä½ æ˜ç™½å¦‚ä½•å¹«åŠ©é‚£äº›æ™‚é–“å’Œé£Ÿæéƒ½æœ‰é™çš„äººå¿«é€Ÿåšå‡ºé¤é»ã€‚
        ä½ çš„å·¥ä½œæ˜¯å”åŠ©ç”¨æˆ¶æ‰¾åˆ°æœ€ä½³çš„é£Ÿè­œå’Œçƒ¹é£ªæŒ‡å°ï¼Œå–æ±ºæ–¼ä»¥ä¸‹è®Šé‡ï¼š
        {ingredients}

        ç•¶æ‰¾åˆ°æœ€ä½³é£Ÿè­œå’Œçƒ¹é£ªæŒ‡å°æ™‚ï¼Œ
        ä½ æœƒè‡ªä¿¡ä¸”ç›´æˆªäº†ç•¶åœ°å›ç­”ã€‚
        åœ¨åˆ¶å®šé£Ÿè­œå’ŒæŒ‡å°æ™‚ï¼Œè«‹è¨˜ä½5-10åˆ†é˜çš„æ™‚é–“é™åˆ¶ã€‚

        å¦‚æœ {ingredients} å°‘æ–¼3ç¨®ï¼Œå¯ä»¥æ·»åŠ ä¸€äº›èƒ½è£œå……å¥åº·é¤é»çš„é£Ÿæã€‚

        è«‹ç¢ºä¿ä½ çš„å›ç­”æ ¼å¼å¦‚ä¸‹ï¼š

        - ç”¨é¤åç¨±ä½œç‚ºç²—é«”æ¨™é¡Œï¼ˆæ›è¡Œï¼‰

        - æœ€ä½³é£Ÿè­œé¡åˆ¥ï¼ˆç²—é«”ï¼‰

        - æº–å‚™æ™‚é–“ï¼ˆæ¨™é¡Œï¼‰

        - é›£åº¦ï¼ˆç²—é«”ï¼‰ï¼š
            ç°¡å–®

        - é£Ÿæï¼ˆç²—é«”ï¼‰
            åˆ—å‡ºæ‰€æœ‰é£Ÿæ

        - æ‰€éœ€å»šæˆ¿å·¥å…·ï¼ˆç²—é«”ï¼‰
            åˆ—å‡ºæ‰€éœ€çš„å»šæˆ¿å·¥å…·

        - çƒ¹é£ªæŒ‡å°ï¼ˆç²—é«”ï¼‰
            åˆ—å‡ºæ‰€æœ‰è£½ä½œé¤é»çš„æŒ‡å°æ­¥é©Ÿ

        - ç‡Ÿé¤Šæˆåˆ†ï¼ˆç²—é«”ï¼‰ï¼š
            ç¸½å¡è·¯é‡Œ
            åˆ—å‡ºæ¯ç¨®é£Ÿæçš„å¡è·¯é‡Œ
            åˆ—å‡ºæ‰€æœ‰ç‡Ÿé¤Šæˆåˆ†

        è«‹å‹™å¿…ç°¡æ˜æ‰¼è¦ã€‚
        ä½¿æŒ‡å°æ˜“æ–¼ç†è§£ä¸¦é€æ­¥é€²è¡Œã€‚
        """

        with st.spinner("Making the recipe for you..."):
            prompt = PromptTemplate(
                template=template, input_variables=["ingredients"]
            )
            llm = get_llm()
            recipe_chain = prompt | llm
            recipe = recipe_chain.invoke({"ingredients": ingredients})

        return recipe


    def main():

        st.markdown(
            "<h1 style='text-align: center; color: red;'>"
            "ğŸ² Recipe Generator ğŸ² </h1>",
            unsafe_allow_html=True,
        )

        st.markdown(
            "<h2 style='text-align: center; font-size: 24px;"
            " color: white'>ä½¿ç”¨&nbsp;&nbsp;<span style='color: orange;'>"
            "Amazon Bedrock</span></h2>",
            unsafe_allow_html=True,
        )

        upload_file = st.file_uploader(
            "é¸æ“‡åœ–ç‰‡ï¼š",
            type=["jpg", "png"],
            accept_multiple_files=False
        )

        if upload_file is not None:
            file_bytes = upload_file.getvalue()
            with open(upload_file.name, "wb") as file:
                file.write(file_bytes)

            st.image(
                upload_file,
                caption="The uploaded image",
                use_column_width=True,
                width=250
            )

            st.markdown("### ğŸ¥— ç›¸ç‰‡ä¸­çš„åŸæ–™")
            ingredients = image_to_text(upload_file.name)
            with st.expander("åŸæ–™ ğŸ‘€"):
                st.write(ingredients.capitalize())

            st.markdown("### ğŸ“‹ é£Ÿè­œ")
            recipe = generate_recipe(ingredients=ingredients)
            with st.expander("çƒ¹é£ªèªªæ˜ ğŸ‘€"):
                st.write(recipe)

            os.remove(upload_file.name)


    if __name__ == "__main__":
        load_dotenv()
        main()

    ```

<br>

5. é‹è¡Œå¾Œä¸å†å‡ºç¾è­¦å‘Šã€‚

    ![](images/img_48.png)

<br>

___

_END_
