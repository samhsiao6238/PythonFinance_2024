# `snapshot`

## 補充說明

1. `snapshot` 是用於快速取得即時行情資訊的結構，與 `ticks` 不同之處在於 `snapshot` 是該刻的整體狀態，而 `ticks` 是逐筆成交紀錄。
2. 若對於多個商品同時取得 snapshot，請將多個合約物件放入一個 list，再傳入 `api.snapshots`。
3. 在實務應用中，取得 snapshot 後通常會即時顯示於報價系統、進行策略判斷或轉為 DataFrame 以利後續統計與分析。
4. 若 `snapshots` 回傳的結果中某商品不存在(例如非交易時間或代碼錯誤)，可能會出現相關錯誤或返回空集合，需在程式中做相對應的檢查。

## 簡介

1. `Snapshot` 是一組描述股票、期貨、選擇權等交易商品當前狀態的資料結構，包含該商品目前的開盤價(open)、最高價(high)、最低價(low)、收盤價(close)、漲跌幅資訊(change_price、change_rate、change_type)、加權平均價格(average_price)、當前成交量(volume)、累計成交量(total_volume)、當前委買價(buy_price)及委買量(buy_volume)、當前委賣價(sell_price)及委賣量(sell_volume)、昨日總量(yesterday_volume)等資訊。

2. 透過 `snapshot` 可快速取得商品當前的最新行情狀態，一次查詢可以取得最多 `500` 個合約(contract)的資訊。

3. 參數說明，回傳值為一個 `List[Snapshot]`，其中每個元素都是該商品的當前 snapshot 資料。

```python
api.snapshots(
    # 要查詢的商品合約列表，可同時包含股票、期貨、選擇權、指數等合約
    contracts: List[
        Union[
            shioaji.contracts.Option, 
            shioaji.contracts.Future, 
            shioaji.contracts.Stock, 
            shioaji.contracts.Index
        ]
    ],
    # 設定此請求的逾時時間(毫秒)
    timeout: int = 30000,
    # 可選的 callback 函式，若指定則在取得每個 snapshot 後呼叫該函式
    cb: Callable[[shioaji.data.Snapshot], NoneType] = None,
) -> List[shioaji.data.Snapshot]
```

## 範例

1. 簡單的 snapshots。

```python
# 要取得 snapshot 的合約清單
contracts = [
    api.Contracts.Stocks['2330'],
    api.Contracts.Stocks['2317']
]

# 取得合約清單的當前 snapshot 資料
snapshots = api.snapshots(contracts)

# 查看 snapshots 結果
snapshots
```

_輸出_

```python
[
    Snapshot(
        ts=1673620200000000000, 
        code='2330', 
        exchange='TSE', 
        open=507.0, 
        high=509.0, 
        low=499.0, 
        close=500.0, 
        tick_type=<TickType.Sell: 'Sell'>, 
        change_price=13.5, 
        change_rate=2.77,
        change_type=<ChangeType.Up: 'Up'>, 
        average_price=502.42, 
        volume=48, 
        total_volume=77606, 
        amount=24000000, 
        total_amount=38990557755, 
        yesterday_volume=20963.0, 
        buy_price=500.0,
        buy_volume=122.0, 
        sell_price=501.0, 
        sell_volume=1067, 
        volume_ratio=3.7
    ),
    Snapshot(
        ts=1673620200000000000, 
        code='2317', 
        exchange='TSE', 
        open=99.0, 
        high=99.5, 
        low=98.6, 
        close=98.6, 
        tick_type=<TickType.Sell: 'Sell'>, 
        change_price=0.0, 
        change_rate=0.0, 
        change_type=<ChangeType.Unchanged: 'Unchanged'>, 
        average_price=98.96, 
        volume=63, 
        total_volume=17809, 
        amount=6211800, 
        total_amount=1762344817, 
        yesterday_volume=18537.0, 
        buy_price=98.6, 
        buy_volume=607.0, 
        sell_price=98.7, 
        sell_volume=4, 
        volume_ratio=0.96
    )
]
```

2. 轉換為 DataFrame；因為 `snapshots` 是一個列表 List，所以遍歷將每個 snapshot 物件的屬性，再透過 `s.__dict__` 轉為字典，並以此建立 `DataFrame`
```python
import pandas as pd

# 將 snapshot 物件的資料轉為 DataFrame
# 每個 snapshot 的屬性以字典方式展開
df = pd.DataFrame(s.__dict__ for s in snapshots)
# 將時間欄位 ts 轉為 datetime 格式
df.ts = pd.to_datetime(df.ts)
df
```

## Snapshot 屬性說明

1. ts (int)：時間戳記 (Timestamp)，通常為奈秒(nanosecond)級別的 Unix time，可轉為可讀日期時間。

2. code (str)：商品代碼 (Contract id)，如「2330」代表台積電。

3. exchange (Exchange)：交易所代碼，如 TSE (臺灣證交所)。

4. open (float)：開盤價。

5. high (float)：最高價。

6. low (float)：最低價。

7. close (float)：最後成交價 (收盤價)。

8. tick_type (TickType)：最後一筆成交是買方主動還是賣方主動。可能值包括：None, Buy, Sell。

9. change_price (float)：與前日收盤價相比的漲跌金額。

10. change_rate (float)：與前日收盤價相比的漲跌百分比。

11. change_type (ChangeType)：漲跌型態，可為 LimitUp, Up, Unchanged, Down, LimitDown。

12. average_price (float)：加權平均成交價。

13. volume (int)：最後一筆成交量（單位股數或口數，視商品而定）。

14. total_volume (int)：當日累計成交量。

15. amount (int)：最後一筆成交金額。

16. total_amount (int)：當日累計成交金額。

17. yesterday_volume (float)：昨日累計成交量。

18. buy_price (float)：當前買方掛單價格。

19. buy_volume (float)：當前買方掛單數量。

20. sell_price (float)：當前賣方掛單價格。

21. sell_volume (int)：當前賣方掛單數量。

22. volume_ratio (float)：`total_volume / yesterday_volume`，即當日累計成交量與昨日累計成交量比例。

