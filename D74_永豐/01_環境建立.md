# 建立環境

_開啟新的終端機_

<br>

## 準備工作

1. 假如在其他虛擬環境中，先退出當前虛擬環境，若無則跳過。

    ```bash
    deactivate
    ```

<br>

2. 透過自動化指令安裝 `uv`，在任意路徑安裝即可。

    ```bash
    curl -LsSf https://astral.sh/uv/install.sh | sh
    ```

    ![](images/img_04.png)

<br>

3. 透過驗證版本確認安裝已完成。

    ```bash
    uv --version
    ```

    ![](images/img_05.png)

<br>

## 簡介 `uv`

_適合需要輕量級依賴管理的 Python 開發_

<br>

1. uv 是一個現代化的 Python 依賴管理工具，提供了簡單的方式來管理 Python 的依賴項目和虛擬環境，類似於 poetry 或 pipenv。

<br>

2. 支援 pyproject.toml 作為依賴描述文件，符合 PEP 517/518 標準。

<br>

3. 以上自動化指令會下載 install.sh 腳本，執行後會檢查系統環境並安裝最新的 uv 工具，同時也會添加到系統的 PATH 中。

<br>

## 查看腳本

_若想查看這個安裝腳本內容，可下載查看_

<br>

1. 下載腳本到桌面。

    ```bash
    cd ~/Desktop && curl -LsSf https://astral.sh/uv/install.sh -o install.sh
    ```

<br>

2. 查看。

    ```bash
    cat install.sh
    ```

<br>

## 解除安裝

_先提供操作說明，有需要時可按步驟操作_

<br>

1. 檢查安裝路徑。

    ```bash
    which uv
    ```

    ![](images/img_09.png)

<br>

2. 查看安裝資料夾與文件。

    ```bash
    ls ~/.local/bin/uv
    ls ~/.local/bin/uvx
    ls ~/.config/uv
    ```

    ![](images/img_20.png)

<br>

3. 刪除安裝資料夾。

    ```bash
    rm -rf ~/.local/bin/uv
    rm -rf ~/.local/bin/uvx
    ```

<br>

4. 刪除配置文件。

    ```bash
    rm -rf ~/.config/uv
    ```

<br>

## 建立專案

1. 透過 `uv` 工具初始化專案環境，並隨即在資料夾中啟動 VSCode；這裡示範建立在桌面。

    ```bash
    cd ~/Desktop
    uv init sj-trading --package --app --vcs git
    cd sj-trading
    code .
    ```

    ![](images/img_06.png)

<br>

2. 在終端機運行令查看專案結構。

    ```bash
    tree
    ```

    ![](images/img_07.png)

<br>

3. 在專案資料夾中手動建立設置文件 `.uv/config.json`。

    ```bash
    mkdir -p .uv && touch .uv/config.json
    ```

<br>

4. 編輯 `.uv/config.json` 貼上以下內容，用以指定 Python 解釋器路徑；這是用來簡化後續可能產生的種種環境衝突。

    ```json
    {
        "python": "/Users/samhsiao/Documents/PythonVenv/envShioaji/bin/python"
    }
    ```

<br>

5. 在專案根目錄運行指令，這會安裝 shioaji 套件，與直接使用 `pip install shioaji` 不同，`uv add` 會結合專案的依賴管理機制，將套件與專案緊密關聯，方便版本控制與環境重現。

    ```bash
    uv add shioaji
    ```

    ![](images/img_08.png)

<br>

6. 前面的步驟會自動建立虛擬環境 `.venv`。

    ![](images/img_10.png)

<br>

7. 在 VSCode 中若出現彈窗，直接關閉即可。

    ![](images/img_21.png)

<br>

## 環境變數

1. 在當前專案資料夾的 `.venv/bin` 開啟終端機，運行指令查詢路徑。

    ```bash
    pwd
    ```

    ![](images/img_22.png)

<br>

2. 將路徑寫入設定文件，路徑尾綴加上 `activate`。

    ```bash
    code ~/.zshrc
    ```

    ![](images/img_23.png)

<br>

3. 立即套用。

    ```bash
    source ~/.zshrc
    ```

    ![](images/img_24.png)

<br>

## 編輯腳本

1. 編輯 `src/sj_trading/__init__.py`，完全覆蓋預設內容即可。

    ```python
    import shioaji as sj

    def main() -> None:
        print("Hello from sj-trading!")

    def hello():
        get_shioaji_client()

    def get_shioaji_client() -> sj.Shioaji:
        api = sj.Shioaji()
        print("Shioaji API created")
        return api
    ```

<br>

2. 查看腳本 `pyproject.toml`，這時應該會類似以下內容。

    ```toml
    [project]
    name = "sj-trading"
    version = "0.1.0"
    description = "Add your description here"
    readme = "README.md"
    authors = [
        { name = "samhsiao6238", email = "samhsiao6238@gmail.com" }
    ]
    requires-python = ">=3.10"
    dependencies = [
        "shioaji>=1.2.5",
    ]

    [project.scripts]
    sj-trading = "sj_trading:main"

    [build-system]
    requires = ["hatchling"]
    build-backend = "hatchling.build"
    ```

<br>

3. 編輯 `[project.scripts]` 部分，添加以下代碼，其餘不變。

    ```toml
    [project.scripts]
    hello = "sj_trading:hello"
    sj-trading = "sj_trading:main"
    ```

<br>

4. 運行以下測試代碼。

    ```bash
    uv run hello
    ```

    ![](images/img_03.png)

<br>

## 安裝套件

1. 手動安裝 pip。

    ```bash
    python -m ensurepip --upgrade
    ```

<br>

2. 確認。

    ```bash
    python -m pip --version
    ```

<br>

3. 升級。

    ```bash
    python -m pip install --upgrade pip
    ```

<br>

4. 套件。

    ```bash
    python -m pip install shioaji python-dotenv
    ```

<br>

## 測試

1. 在專案根目錄中運行指令。

    ```bash
    uv run hello
    ```

    ![](images/img_11.png)

<br>

## 證卷

1. 新增 API Key。

    ![](images/img_01.png)

<br>

2. 確定。

    ![](images/img_02.png)

<br>

## 編輯專案

1. 在專案根目錄添加文件 `.env`，並編輯 `.gitignore`，加入 `.env`。

    ```json
    .env
    ```

<br>

2. 編輯 `.env` 文件，貼上以下內容；其中 `CA_PASSWORD` 就是用戶的身分證字號，第一碼大寫；如有必要可參考 [官網影片](https://www.youtube.com/watch?v=0tPCZiRsz-U&t=84s)。

    ```bash
    API_KEY=<輸入-API_Key>
    SECRET_KEY=<輸入-Secret_Key>
    CA_CERT_PATH=Sinopac.pfx
    CA_PASSWORD=<輸入用戶密碼>
    ```

<br>

## 編輯腳本

1. 導入套件。

    ```python
    import os
    from dotenv import load_dotenv
    ```

<br>

2. 載入環境變數。

    ```python
    load_dotenv()
    ```

<br>

3. 編輯既有的 `main()` 函數，覆蓋原本內容即可。

    ```python
    def main():
        api = sj.Shioaji(simulation=True)
        api.login(
            api_key=os.environ["API_KEY"],
            secret_key=os.environ["SECRET_KEY"],
            fetch_contract=False
        )
        api.activate_ca(
            ca_path=os.environ["CA_CERT_PATH"],
            ca_passwd=os.environ["CA_PASSWORD"],
        )
        print("login and activate ca success")
    ```

<br>

4. 編輯 `pyproject.toml`，在 `[project.scripts]` 區塊加入指令。

    ```toml
    [project.scripts]
    main = "sj_trading:main"
    hello = "sj_trading:hello"
    ```

<br>

5. 測試登入。

    ```bash
    uv run main
    ```

    ![](images/img_12.png)

<br>

___

_END_