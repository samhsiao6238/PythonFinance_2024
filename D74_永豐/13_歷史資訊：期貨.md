# 歷史數據

_期貨_

<br>

## 連續期貨合約

_Continuous Futures，當期貨合約過期後，原合約無法再查詢數據，但可以使用 `TXFR1` 和 `TXFR2` 來取得近月和次月的連續合約數據。_

<br>

1. 先載入自訂模組並登入帳號；特別注意，這裡是使用模擬模式，在某些狀況下，使用不同模式可能會無法取得數據，可切換嘗試。

    ```python
    # 導入庫
    import MyShioaji as msj

    # 登入，使用模擬模式
    api = msj.login_Shioaji(simulation=True)
    ```

<br>

2. 逐筆資料 (Ticks)。

    ```python
    # 逐筆資料
    ticks = api.ticks(
        contract=api.Contracts.Futures.TXF.TXFR1, 
        date="2020-03-22"
    )
    ticks
    ```

<br>

3. 可先透過 `dir()` 查看屬性，這個方法回傳的是一個列表 `List`。

    ```python
    # 查看物件的屬性
    dir(ticks)
    ```

<br>

4. 可透過 `vars()` 查看物件屬性，會回傳一個字典，包含屬性及其值。

    ```python
    vars(ticks)
    ```

<br>

5. 可透過 `keys()` 取得字典的鍵。

    ```python
    # 查看 ticks 的屬性及其對應值
    vars(ticks).keys()
    ```

<br>

6. 也可透過屬性 `__dict__` 取回字典，然後再透過 `keys()` 取得字典的鍵。

    ```python
    # 查看 ticks 的鍵
    ticks.__dict__.keys()
    ```

<br>

7. 根據 ticks 的屬性將其轉為 DataFrame。

    ```python
    import pandas as pd

    # 將 ticks 的有效屬性轉換為 DataFrame
    df = pd.DataFrame({
        'ts': ticks.ts,
        'volume': ticks.volume,
        'close': ticks.close,
        'bid_price': ticks.bid_price,
        'ask_price': ticks.ask_price,
        'bid_volume': ticks.bid_volume,
        'ask_volume': ticks.ask_volume
    })

    # 將 ts 欄位轉換為時間格式，並格式化為秒級
    df['ts'] = pd.to_datetime(df['ts']).dt.floor('s')

    # 查看數據
    print(df)
    ```

    ![](images/img_104.png)

<br>

## K 線數據 (Kbars)

1. 取回數據。

    ```python
    # K 線數據
    kbars = api.kbars(
        contract=api.Contracts.Futures.TXF.TXFR1,
        start="2024-12-15", 
        end="2024-12-16", 
    )
    kbars
    ```

<br>

2. 查看 kbars 的數據欄位。

    ```python
    # 查看 kbars 的數據欄位
    vars(kbars).keys()
    ```

<br>

3. 根據欄位轉換為 DataFrame。

    ```python
    import pandas as pd

    # 將 ticks 的有效屬性轉換為 DataFrame
    df = pd.DataFrame({
        'ts': kbars.ts,
        'volume': kbars.Open,
        'close': kbars.High,
        'bid_price': kbars.Low,
        'ask_price': kbars.Close,
        'bid_volume': kbars.Volume,
        'ask_volume': kbars.Amount
    })

    # 將 ts 欄位轉換為時間格式，並格式化為秒級
    df['ts'] = pd.to_datetime(df['ts']).dt.floor('s')

    # 查看數據
    print(df)
    ```

<br>

___

_END_