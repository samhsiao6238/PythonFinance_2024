# 登入流程

_永豐金 Shioaji API 的登入流程_

<br>

## 初始化 API

1. 新增 `.ipynb` 文件，任意命名如 `ex01.ipynb`。

    ```bash
    touch ex01.ipynb
    ```

<br>

2. 選取正確核心 `.venv`。

    ![](images/img_32.png)

<br>

3. 初始化後進行登入，相關密鑰會讀取 `.env` 文件中的設定。

    ```python
    import shioaji as sj
    import os
    from dotenv import load_dotenv
    load_dotenv()

    api_key = os.environ["API_KEY"]
    secret_key = os.environ["SECRET_KEY"]

    # 初始化 Shioaji API
    # 預設為模擬模式（simulation=True）
    # api = sj.Shioaji()
    # 顯示設置為正式模式
    api = sj.Shioaji(simulation=False)

    # 使用 API 金鑰與密鑰登入
    accounts = api.login(
        api_key=api_key,
        secret_key=secret_key
    )

    # 帳號資訊
    print(accounts)
    ```

    ![](images/img_33.png)

<br>

4. 可自訂更詳細的參數；以下代碼供參考，可不用實作。

    ```python
    accounts = api.login(
        api_key=api_key,
        secret_key=secret_key,
        # 是否從伺服器下載商品檔（預設為 True）
        fetch_contract=True,
        # 是否訂閱委託/成交回報（預設為 True）
        subscribe_trade=True,
        # 調整有效執行時間為 60 秒
        receive_window=60000
    )
    # 帳號資訊
    print(accounts)
    ```

<br>

## 檢查簽署

1. 列出所有帳號，輸出中會註明該帳號是否已經通過簽署，完成者會顯示 `signed=True`。

    ```python
    accounts = api.list_accounts()
    print(accounts)
    ```

    ![](images/img_34.png)

<br>

2. 檢查未簽署的帳號。

    ```python
    # 檢查未簽署的帳號
    unsigned_accounts = [
        account 
        for account in accounts 
        if not getattr(account, 'signed', False)
    ]

    if unsigned_accounts:
        print("未完成簽署的帳號:")
        for account in unsigned_accounts:
            print(
                f"person_id='{account.person_id}' "
                f"broker_id='{account.broker_id}' "
                f"account_id='{account.account_id}' "
                f"username='{account.username}'"
            )

        # 嘗試執行其他方式
        for account in unsigned_accounts:
            print(
                f"請手動簽署帳號 {account.account_id} "
                "或檢查 API 文件。"
            )
    else:
        print("所有帳號已完成簽署。")
    ```

    ![](images/img_18.png)

<br>

3. 查詢是否通過 API 測試。

    ```python
    import shioaji as sj
    from dotenv import load_dotenv
    import os

    # 載入 .env 檔案
    load_dotenv()

    # 讀取環境變數
    API_KEY = os.getenv("API_KEY")
    SECRET_KEY = os.getenv("SECRET_KEY")

    if not API_KEY or not SECRET_KEY:
        raise ValueError("找不到密鑰資料。")

    # 初始化 Shioaji API
    # 正式模式，也就是非模擬模式
    api = sj.Shioaji(simulation=False)
    accounts = api.login(
        api_key=API_KEY, 
        secret_key=SECRET_KEY
    )

    print(accounts)
    ```

    _結果顯示_

    ```bash
    Response Code: 0 | 
    Event Code: 0 | 
    Info: host '210.59.255.161:80', 
    hostname '210.59.255.161:80' 
    IP 210.59.255.161:80 
    (host 1 of 1) 
    (host connection attempt 1 of 1) 
    (total connection attempt 1 of 1) | 
    Event: Session up
    [
        StockAccount(
            person_id='Y120269041', 
            broker_id='9A95', 
            account_id='3453495', 
            username='蕭中柱'
        )
    ]
    ```

<br>

___

_接續以下單元_