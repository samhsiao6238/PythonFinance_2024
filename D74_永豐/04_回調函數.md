# 回調函數

_Callback functions，用於在特定事件發生時自動觸發自定義的邏輯；在 `Shioaji API` 中，官方模組內建了兩種回調類型，分別是登入階段使用 `contracts_cb` 設定的 `合約下載回調`，以及下單時使用 `set_order_callback` 設定的 `委託、成交回報回調`。_

<br>

## 合約下載回調 `contracts_cb`

_登入階段設定_

<br>

1. 在 API 登入階段，可透過 `api.login()` 的參數設定合約下載完成後的回調通知，當指定的合約下載完成時，該回調函數會被觸發，用於監控不同類型的合約下載狀態；登入後，若下載了指定類型的合約資料如股票、期貨、選擇權等，會觸發 `contracts_cb` 回調函數處理合約資料（contracts）的下載完成事件，以下代碼是使用匿名函數 `Lambda` 的範例，下載後會輸出該合約類型下載完成的消息；特別注意，前面已經說過，下載是預設為 `True`，所以這裡並未設定參數 `fetch_contract`。

    ```python
    api.login(
        api_key=api_key,
        secret_key=secret_key,
        # 自訂回調函數
        contracts_cb=lambda security_type: print(f"{repr(security_type)} fetch done.")
    )
    ```

<br>

2. 若下載完成後要處理較為複雜的任務，可以自訂回調函數，直接將函數以參數形式傳入；這種方法適合在程式初始化或物件建立時以函數參數指定對應的回調函式，優點是清楚、直接，但在大型程式或多個事件回呼同時使用時，程式碼可讀性可能較差。

    ```python
    # 自訂回調函數
    def on_contracts_fetch(security_type):
        print(f"合約類型 {security_type} 下載完成。")
        # 可添加其他邏輯

    api.login(
        api_key=api_key,
        secret_key=secret_key,
        contracts_cb=on_contracts_fetch
    )
    ```

<br>

## 委託與成交回報回調 `set_order_callback`

_下單階段使用的回調，這在後續說明下單時會再詳細說明，屆時可參考 `訂閱通知` 中的解說。_

<br>

1. 登入成功後，可調用 `set_order_callback` 設置回調，用於接收 `委託回報` 和 `成交回報` 的通知，可透過 `api.set_order_callback()` 來設定，當交易事件發生時回調函數會被觸發，包含如下單成功、成交、取消等。

    ```python
    # 定義回調函數
    def order_callback(topic, msg):
        if topic == "Order":
            print(f"【委託回報】\n{msg}")
        elif topic == "Trade":
            print(f"【成交回報】\n{msg}")
        else:
            print(f"【未知回報】類型: {topic}, 訊息: {msg}")
    ```

<br>

2. 註冊回調。

    ```python
    # 設置委託/成交回報回調函數
    api.set_order_callback(order_callback)
    ```

<br>

3. 觸發。

    ```python
    # 測試：模擬委託下單
    contract = api.Contracts.Stocks.TSE["2330"]
    order = api.Order(
        price=550,
        quantity=1,
        action=sj.constant.Action.Buy,
        price_type=sj.constant.StockPriceType.LMT,
        order_type=sj.constant.OrderType.ROD,
        account=api.stock_account
    )
    api.place_order(contract, order)
    ```

    _輸出_

    ```bash
    【委託回報】
    {'id': '000112', 'status': 'PendingSubmit', 'price': 550, 'quantity': 1}

    【成交回報】
    {'trade_price': 550, 'trade_quantity': 1, 'trade_time': '15:30:00'}
    ```

<br>

## 市場報價回調 `quote.subscribe`

_用於訂閱盤中報價、成交資訊、委買委賣資訊的回調_

<br>

1. 使用 `api.quote.subscribe()` 訂閱並設定回調；當 Shioaji API 收到報價資訊時，會自動觸發回調函數 `quote_callback`，並將 Tick 資訊傳入。

    ```python
    import shioaji as sj
    from shioaji import TickSTKv1, Exchange
    from threading import Event, Thread
    import time

    # 定義回調函數
    @api.on_tick_stk_v1()
    def quote_callback(exchange: Exchange, tick: TickSTKv1):
        print(f"【Tick 資訊】\nExchange: {exchange}\nTick: {tick}")

    # 訂閱的觸發機制
    def subscribe_tick():
        print("開始訂閱 Tick 資訊...")
        # 是訂閱報價資訊的 API 方法
        api.quote.subscribe(
            contract=api.Contracts.Stocks["2330"],
            quote_type=sj.constant.QuoteType.Tick,
            version=sj.constant.QuoteVersion.v1
        )
        # 等待回調觸發
        Event().wait()  

    # 取消訂閱的函數
    def cancel_subscription():
        print("等待 5 秒後取消訂閱...")
        # 模擬等待
        time.sleep(5)
        api.quote.unsubscribe(
            contract=api.Contracts.Stocks["2330"],
            quote_type=sj.constant.QuoteType.Tick,
            version=sj.constant.QuoteVersion.v1
        )
        print("已取消訂閱 Tick 資訊。")
    ```

<br>

2. 啟動訂閱執行緒。 

    ```python
    # 啟動訂閱執行緒
    subscribe_thread = Thread(target=subscribe_tick)
    subscribe_thread.start()
    ```

    _輸出_

    ```bash
    開始訂閱 Tick 資訊...
    # 回調事件執行成功，這是標準的 HTTP 狀態碼
    Response Code: 200 | 
    # 16 是事件代碼，代表訂閱相關操作成功完成
    Event Code: 16 | 
    # 成功訂閱了 `2330` 的 Tick 報價資訊
    Info: TIC/v1/STK/*/TSE/2330 | 
    # 這次的動作是 `訂閱或取消訂閱` 且操作成功
    Event: Subscribe or Unsubscribe ok
    ```

<br>

3. 取消訂閱。

    ```python
    # 取消訂閱
    cancel_subscription()
    ```

    _輸出_

    ```bash
    等待 5 秒後取消訂閱...
    已取消訂閱 Tick 資訊。
    Response Code: 200 | 
    Event Code: 16 | 
    Info: TIC/v1/STK/*/TSE/2330 | 
    Event: Subscribe or Unsubscribe ok
    ```

<br>

___

_接續下一個單元_