# GAN

_Generative Adversarial Networkï¼ŒGAN æ˜¯ä¸€ç¨®æ·±åº¦å­¸ç¿’æ¨¡å‹ï¼Œç”¨æ–¼ç”Ÿæˆé€¼çœŸçš„æ•¸æ“šï¼›æ ¸å¿ƒæ¦‚å¿µæ˜¯é€šéä¸€å€‹ `ç”Ÿæˆå™¨ï¼ˆGeneratorï¼‰` å’Œä¸€å€‹ `è¾¨åˆ¥å™¨ï¼ˆDiscriminatorï¼‰` ä¹‹é–“çš„å°æŠ—æ€§è¨“ç·´ï¼Œä½¿ç”Ÿæˆå™¨èƒ½å¤ å»ºç«‹é›£ä»¥å€åˆ†æ–¼çœŸå¯¦æ•¸æ“šçš„å‡æ•¸æ“šã€‚_

<br>

## GAN çš„æ‡‰ç”¨é ˜åŸŸ

1. åœ–åƒç”Ÿæˆå’Œé¢¨æ ¼è½‰æ›ï¼šç”Ÿæˆé€¼çœŸçš„åœ–åƒæˆ–å°‡ä¸€ç¨®åœ–åƒé¢¨æ ¼è½‰æ›ç‚ºå¦ä¸€ç¨®é¢¨æ ¼ï¼Œå¦‚å°‡ç´ æè½‰æ›ç‚ºæ²¹ç•«é¢¨æ ¼ã€‚

<br>

2. åœ–åƒè¶…åˆ†è¾¨ç‡ï¼šæé«˜åœ–åƒçš„è§£æåº¦ï¼Œä½¿ä½åˆ†è¾¨ç‡åœ–åƒè®Šå¾—æ¸…æ™°ã€‚

<br>

3. æ–‡æœ¬åˆ°åœ–åƒåˆæˆï¼šæ ¹æ“šæè¿°æ€§çš„æ–‡æœ¬ç”Ÿæˆå°æ‡‰çš„åœ–åƒã€‚

<br>

4. æ•¸æ“šå¢å¼·ï¼šåœ¨é†«å­¸å½±åƒã€èªéŸ³æ•¸æ“šç­‰é ˜åŸŸï¼Œç”¨æ–¼ç”Ÿæˆæ›´å¤šæ¨£æœ¬ä¾†å¢å¼·æ•¸æ“šé›†ã€‚

<br>

5. è™›æ“¬çŸ³å¾‘å’ŒéŠæˆ²é–‹ç™¼ï¼šå»ºç«‹è™›æ“¬ç’°å¢ƒä¸­é€¼çœŸçš„ç‰©é«”æˆ–å ´æ™¯ã€‚

<br>

6. éŸ³é »ç”Ÿæˆï¼šç”ŸæˆéŸ³æ¨‚ã€èªéŸ³ç­‰éŸ³é »æ•¸æ“šï¼Œç”¨æ–¼éŸ³æ¨‚å‰µä½œå’ŒèªéŸ³åˆæˆã€‚

<br>

## GAN çš„åŸºæœ¬æ¦‚å¿µ

1. GAN ç”±å…©å€‹ç›¸äº’ç«¶çˆ­çš„ç¥ç¶“ç¶²çµ¡çµ„æˆï¼Œåˆ†åˆ¥æ˜¯ `ç”Ÿæˆå™¨` å’Œ `è¾¨åˆ¥å™¨`ï¼Œé€™å…©å€‹ç¶²çµ¡å½¼æ­¤ç«¶çˆ­ï¼Œç”Ÿæˆå™¨è©¦åœ–ç”Ÿæˆèˆ‡çœŸå¯¦æ•¸æ“šç›¸ä¼¼çš„æ•¸æ“šï¼Œè€Œè¾¨åˆ¥å™¨è©¦åœ–å€åˆ†ç”Ÿæˆçš„æ•¸æ“šå’ŒçœŸå¯¦æ•¸æ“šã€‚

<br>

2. åœ¨ GAN ä¸­ï¼Œç”Ÿæˆå™¨æ¨¡å‹å¾éš¨æ©Ÿå™ªè²ä¸­ç”Ÿæˆå‡æ•¸æ“šï¼Œä¾‹å¦‚åœ¨æ­¤ç¯„ä¾‹ä¸­ï¼Œç”Ÿæˆå™¨æ¥æ”¶ä¸€å€‹æ½›åœ¨å‘é‡ ğ‘§ ä¸¦å°‡å…¶è½‰æ›ç‚ºé¡ä¼¼æ–¼ MNIST æ‰‹å¯«æ•¸å­—çš„åœ–åƒæ•¸æ“šï¼›è€Œè¾¨åˆ¥å™¨æ¨¡å‹å‰‡ç”¨ä¾†å€åˆ†çœŸå¯¦æ•¸æ“šå’Œç”Ÿæˆå™¨ç”Ÿæˆçš„å‡æ•¸æ“šï¼Œè¾¨åˆ¥å™¨é€šéè¼¸å‡ºä¸€å€‹æ¦‚ç‡ä¾†åˆ¤æ–·è¼¸å…¥æ•¸æ“šæ˜¯çœŸå¯¦çš„é‚„æ˜¯ç”Ÿæˆçš„ï¼Œå…¶ç›®æ¨™æ˜¯æœ€å¤§åŒ–æ­£ç¢ºå€åˆ†çœŸå¯¦æ•¸æ“šå’Œå‡æ•¸æ“šçš„æ¦‚ç‡ã€‚

<br>

## èªªæ˜

1. ä»¥ä¸‹ä½¿ç”¨ `PyTorch` å’Œ `MNIST è³‡æ–™é›†` ä¾†å¯¦ä½œè¨“ç·´ä¸€å€‹ç°¡å–®çš„ GANï¼Œä¸¦ç”Ÿæˆé¡ä¼¼æ‰‹å¯«æ•¸å­—çš„åœ–åƒã€‚

<br>

2. ç¨‹å¼ç¢¼ã€‚

    ```python
    # å¼•å…¥ PyTorch åº«
    import torch
    # å¼•å…¥ç¥ç¶“ç¶²çµ¡æ¨¡å¡Š
    import torch.nn as nn
    # å¼•å…¥å„ªåŒ–å™¨æ¨¡å¡Š
    import torch.optim as optim
    # å¼•å…¥æ•¸æ“šé›†å’Œæ•¸æ“šè®Šæ›æ¨¡å¡Š
    from torchvision import datasets, transforms
    # å¼•å…¥ç”¨æ–¼åœ–åƒä¿å­˜çš„å·¥å…·
    from torchvision.utils import save_image
    import matplotlib.pyplot as plt
    import numpy as np

    # è¨­å®šè¨­å‚™ç‚º GPU æˆ– CPU
    device = torch.device(
        "cuda" if torch.cuda.is_available() else "cpu"
    )


    # å®šç¾©ç”Ÿæˆå™¨æ¨¡å‹
    class Generator(nn.Module):
        def __init__(self, latent_dim):
            # ç¹¼æ‰¿çˆ¶é¡çš„åˆå§‹åŒ–æ–¹æ³•
            super(Generator, self).__init__()
            self.model = nn.Sequential(
                # å…¨é€£æ¥å±¤ï¼šå°‡æ½›åœ¨ç©ºé–“ä¸­çš„é»æ˜ å°„åˆ°ä¸€å€‹æ›´å¤§çš„ç©ºé–“
                nn.Linear(latent_dim, 128),
                nn.ReLU(True),
                # å…¨é€£æ¥å±¤ï¼šé€²ä¸€æ­¥æ˜ å°„åˆ°åœ–åƒå°ºå¯¸
                nn.Linear(128, 784),
                # ä½¿ç”¨ Tanh æ¿€æ´»å‡½æ•¸å°‡è¼¸å‡ºå€¼ç¯„åœé™åˆ¶åœ¨ [-1, 1]
                nn.Tanh(),
            )

        def forward(self, z):
            # å‰å‘å‚³æ’­è¨ˆç®—ç”Ÿæˆå™¨çš„è¼¸å‡º
            return self.model(z)


    # å®šç¾©è¾¨åˆ¥å™¨æ¨¡å‹
    class Discriminator(nn.Module):
        def __init__(self):
            # ç¹¼æ‰¿çˆ¶é¡çš„åˆå§‹åŒ–æ–¹æ³•
            super(Discriminator, self).__init__()
            self.model = nn.Sequential(
                # å…¨é€£æ¥å±¤ï¼šå°‡åœ–åƒæ•¸æ“šå£“ç¸®åˆ°ä¸€å€‹å°ç©ºé–“
                nn.Linear(784, 128),
                nn.LeakyReLU(0.2, inplace=True),
                # å…¨é€£æ¥å±¤ï¼šé€²ä¸€æ­¥å£“ç¸®åˆ°å–®ä¸€çš„çœŸå¯¦æ€§æ¨™èªŒ
                nn.Linear(128, 1),
                # ä½¿ç”¨ Sigmoid æ¿€æ´»å‡½æ•¸å°‡è¼¸å‡ºå€¼ç¯„åœé™åˆ¶åœ¨ [0, 1]
                nn.Sigmoid(),
            )

        def forward(self, img):
            # å‰å‘å‚³æ’­è¨ˆç®—è¾¨åˆ¥å™¨çš„è¼¸å‡º
            return self.model(img)


    # è¨­å®šè¶…åƒæ•¸
    # æ½›åœ¨ç©ºé–“çš„ç¶­åº¦å¤§å°
    latent_dim = 100
    # å­¸ç¿’ç‡
    lr = 0.0002
    # æ‰¹æ¬¡å¤§å°
    batch_size = 64
    # è¨“ç·´çš„å›åˆæ•¸
    epochs = 100

    # è¼‰å…¥ MNIST æ•¸æ“šé›†
    transform = transforms.Compose(
        [
            # å°‡åœ–åƒè½‰æ›ç‚ºå¼µé‡
            transforms.ToTensor(),
            # å°‡åœ–åƒçš„åƒç´ å€¼æ¨™æº–åŒ–åˆ° [-1, 1]
            transforms.Normalize([0.5], [0.5]),
        ]
    )

    # å‰µå»ºæ•¸æ“šé›†å’Œæ•¸æ“šåŠ è¼‰å™¨
    dataset = datasets.MNIST(
        root="./data",
        train=True,
        transform=transform,
        download=True
    )
    dataloader = torch.utils.data.DataLoader(
        dataset,
        batch_size=batch_size,
        shuffle=True
    )

    # åˆå§‹åŒ–ç”Ÿæˆå™¨å’Œè¾¨åˆ¥å™¨
    generator = Generator(latent_dim).to(device)
    discriminator = Discriminator().to(device)

    # å®šç¾©æå¤±å‡½æ•¸ï¼ˆäºŒå…ƒäº¤å‰ç†µæå¤±ï¼‰
    adversarial_loss = nn.BCELoss()

    # å®šç¾©ç”Ÿæˆå™¨å’Œè¾¨åˆ¥å™¨çš„å„ªåŒ–å™¨
    optimizer_G = optim.Adam(
        generator.parameters(), lr=lr
    )
    optimizer_D = optim.Adam(
        discriminator.parameters(), lr=lr
    )

    # è¨“ç·´ GAN
    for epoch in range(epochs):
        for i, (imgs, _) in enumerate(dataloader):
            # å°‡çœŸå¯¦åœ–åƒæ¨™ç±¤è¨­ç½®ç‚º 1ï¼Œå‡åœ–åƒæ¨™ç±¤è¨­ç½®ç‚º 0
            real_labels = torch.ones(imgs.size(0), 1).to(device)
            fake_labels = torch.zeros(imgs.size(0), 1).to(device)

            # è½‰æ›çœŸå¯¦åœ–åƒå¼µé‡çš„å½¢ç‹€
            real_imgs = imgs.view(imgs.size(0), -1).to(device)

            # ------------------
            # è¨“ç·´è¾¨åˆ¥å™¨
            # ------------------
            optimizer_D.zero_grad()  # æ¢¯åº¦æ¸…é›¶

            # è¾¨åˆ¥çœŸå¯¦åœ–åƒ
            real_loss = adversarial_loss(
                discriminator(real_imgs),
                real_labels
            )

            # éš¨æ©Ÿç”Ÿæˆæ½›åœ¨å‘é‡ä¸¦ç”Ÿæˆå‡åœ–åƒ
            z = torch.randn(imgs.size(0), latent_dim).to(device)
            fake_imgs = generator(z)

            # è¾¨åˆ¥å‡åœ–åƒ
            fake_loss = adversarial_loss(
                discriminator(fake_imgs.detach()),
                fake_labels
            )

            # è¨ˆç®—è¾¨åˆ¥å™¨çš„ç¸½æå¤±
            d_loss = real_loss + fake_loss
            # åå‘å‚³æ’­
            d_loss.backward()
            # æ›´æ–°è¾¨åˆ¥å™¨æ¬Šé‡
            optimizer_D.step()

            # -----------------
            # è¨“ç·´ç”Ÿæˆå™¨
            # -----------------
            # æ¢¯åº¦æ¸…é›¶
            optimizer_G.zero_grad()

            # ç”Ÿæˆå‡åœ–åƒä¸¦è¨ˆç®—ç”Ÿæˆå™¨çš„æå¤±
            g_loss = adversarial_loss(
                discriminator(fake_imgs),
                real_labels
            )
            # åå‘å‚³æ’­
            g_loss.backward()
            # æ›´æ–°ç”Ÿæˆå™¨æ¬Šé‡
            optimizer_G.step()

            # æ¯ 100 æ¬¡æ‰¹æ¬¡é¡¯ç¤ºè¨“ç·´é€²åº¦
            if i % 100 == 0:
                print(
                    f"Epoch [{epoch}/{epochs}]"
                    f" Batch {i}/{len(dataloader)}"
                    f" Loss D: {d_loss.item():.4f},"
                    f" loss G: {g_loss.item():.4f}"
                )

        # æ¯å€‹ epoch ä¿å­˜ä¸€äº›ç”Ÿæˆçš„åœ–åƒ
        if epoch % 10 == 0:
            save_image(
                fake_imgs.view(
                    fake_imgs.size(0), 1, 28, 28
                ),
                f"images/{epoch}.png",
                normalize=True,
            )

    # è¨“ç·´çµæŸå¾Œï¼Œå¯è¦–åŒ–ç”Ÿæˆçš„åœ–åƒ
    # éš¨æ©Ÿç”Ÿæˆ 64 å€‹æ½›åœ¨å‘é‡
    z = torch.randn(64, latent_dim).to(device)
    # ç”Ÿæˆå‡åœ–åƒ
    gen_imgs = generator(z)

    # å°‡ç”Ÿæˆçš„åœ–åƒå¯è¦–åŒ–
    plt.figure(figsize=(8, 8))
    for i in range(64):
        plt.subplot(8, 8, i + 1)
        plt.imshow(
            gen_imgs[i].view(28, 28).cpu().detach().numpy(),
            cmap="gray"
        )
        plt.axis("off")
    plt.show()
    ```

<br>

2. é‹è¡Œä¸­æœƒè¼¸å‡ºè¨“ç·´éç¨‹ã€‚

    ![](images/img_43.png)

<br>

3. åœ–å½¢é¡¯ç¤ºã€‚

    ![](images/img_44.png)

<br>

## ä»£ç¢¼èªªæ˜

1. ä½¿ç”¨ `torchvision` è¼‰å…¥ MNIST æ•¸æ“šé›†ä¸¦é€²è¡Œæ¨™æº–åŒ–è™•ç†ï¼Œå°‡åœ–åƒåƒç´ å€¼æ¨™æº–åŒ–åˆ° `[-1, 1]` ç¯„åœå…§ï¼Œé€™æœ‰åŠ©æ–¼è¨“ç·´çš„ç©©å®šæ€§ã€‚

<br>

2. å®šç¾©ç”Ÿæˆå™¨ï¼ˆ`Generator`ï¼‰æ˜¯å°‡éš¨æ©Ÿç”Ÿæˆçš„æ½›åœ¨å‘é‡è½‰æ›ç‚ºå‡åœ–åƒçš„æ¨¡å‹ã€‚

<br>

3. å®šç¾©è¾¨åˆ¥å™¨ï¼ˆ`Discriminator`ï¼‰æ˜¯å€åˆ†çœŸå¯¦åœ–åƒå’Œç”Ÿæˆçš„å‡åœ–åƒçš„æ¨¡å‹ã€‚

<br>

4. æå¤±å‡½æ•¸ä½¿ç”¨äºŒå…ƒäº¤å‰ç†µæå¤±å‡½æ•¸ä¾†è©•ä¼°è¾¨åˆ¥å™¨å’Œç”Ÿæˆå™¨çš„æ€§èƒ½ã€‚

<br>

5. å„ªåŒ–å™¨ä½¿ç”¨ Adam å„ªåŒ–å™¨ä¾†æ›´æ–°ç”Ÿæˆå™¨å’Œè¾¨åˆ¥å™¨çš„æ¬Šé‡ã€‚

<br>

6. åœ¨è¨“ç·´è¿­ä»£ä¸­ï¼Œé¦–å…ˆæ›´æ–°è¾¨åˆ¥å™¨ï¼Œç„¶å¾Œæ›´æ–°ç”Ÿæˆå™¨ã€‚å°æ–¼è¾¨åˆ¥å™¨ï¼Œè¨ˆç®—è¾¨åˆ¥çœŸå¯¦åœ–åƒå’Œå‡åœ–åƒçš„æå¤±ï¼Œä¸¦é€²è¡Œæ¢¯åº¦æ›´æ–°ã€‚å°æ–¼ç”Ÿæˆå™¨ï¼Œç”Ÿæˆå‡åœ–åƒä¸¦è¨ˆç®—è¾¨åˆ¥å™¨å°å‡åœ–åƒçš„æå¤±ï¼Œç›®çš„æ˜¯é¨™éè¾¨åˆ¥å™¨ï¼Œä½¿å…¶èªç‚ºå‡åœ–åƒç‚ºçœŸå¯¦ã€‚

<br>

___

_END_