# Gemini API 官方範例

_[官方範例](https://ai.google.dev/gemini-api/docs/get-started/tutorial?lang=python&hl=zh-tw)_

![](images/img_60.png)

<br>

## 開始使用

1. 設定開發環境和 API 存取權。

2. 根據文字輸入產生文字回應。

3. 透過多模態輸入（文字和圖片）產生文字回應。

4. 使用 Gemini 進行多輪對話（即時通訊）。

5. 針對大型語言模型使用嵌入功能。

<br>

## 開始

1. 安裝 Gemini API 的 Python SDK。

    ```bash
    pip install -q -U google-generativeai dotenv-python Pillow
    ```

<br>

2. 匯入必要的套件。

    ```python
    import pathlib
    import textwrap
    import google.generativeai as genai
    from IPython.display import display
    from IPython.display import Markdown
    ```

<br>

3. 將 Gemini API 新增至環境變數中。

    ```python
    import os
    from dotenv import load_dotenv

    load_dotenv()
    GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
    genai.configure(api_key=GOOGLE_API_KEY)
    ```

<br>

4. 自訂函數，用於顯示格式化的 `Markdown` 文字，使用時調用 `to_markdown` 並傳入 `response.text` 即可，若在筆記本中要直接顯示，可透過筆記本的 `display` 函數。

    ```python
    def to_markdown(text):
        text = text.replace('•', '  *')
        return Markdown(textwrap.indent(text, '> ', predicate=lambda _: True))
    ```

<br>

5. 使用 `list_models` 方法列出並查看可用的 `Gemini` 模型。

    ```python
    for m in genai.list_models():
        if 'generateContent' in m.supported_generation_methods:
            print(m.name)
    ```

<br>

6. 可用模型有很多，列舉兩個如下。

    ```bash
    gemini-1.5-flash 最快的多模態模型
    gemini-1.5-pro 功能最強大的多模態模型
    ```

<br>

6. 如果只有文字提示，官方建議使用 `Gemini 1.5` 或 `Gemini 1.0 Pro` 模型。

    ```python
    _text = "人生的意義是什麼？"
    model = genai.GenerativeModel('gemini-1.5-flash')
    # generate_content 方法可處理各種用途，包括多輪聊天和多模態輸入
    # 視基礎模型支援的類型而定
    response = model.generate_content(_text)
    # 可簡單輸出
    print(response.text)
    # 或是顯示格式化的 Markdwon 文字
    to_markdown(response.text)
    ```

<br>

8. 如果 API 無法傳回結果，可以使用 `GenerateContentResponse.prompt_feedback` 查看原因。

    ```python
    print(response.prompt_feedback)
    ```

<br>

9. `Gemini` 可對單一提示產生多個可能的回應，這些可回應統稱為 `candidates`，可透過 `.candidates` 屬性進行查看。

    ```bash
    response.candidates
    ```

<br>

## 根據圖片和文字輸入產生文字

_`Gemini 1.5` 和 `Gemini 1.0 Pro Vision` 支援文字和圖片的多模態輸入_

<br>

1. 根據輸入的 `圖片` 以及 `文字描述` 生成 `文字回覆`；假如想要產生 `流式輸出`，在生成的函數 `generate_content` 中加入參數 `stream=True`。

    ```python
    import PIL.Image
    img = PIL.Image.open('image.png')

    model = genai.GenerativeModel('gemini-1.5-flash')
    response = model.generate_content([
        "基於這張圖片寫一篇簡短且引人入勝的博客。",
        img
    ], stream=True)

    for chunk in response:
        print(chunk.text)
    ```

<br>

2. 可透過屬性 `prompt_feedback` 觀察輸出。

    ```python
    response.prompt_feedback
    ```

<br>

## 即時通訊對話

1. `Gemini` 支援多輪對話，使用 `ChatSession` 管理對話狀態。

    ```python
    model = genai.GenerativeModel('gemini-1.5-flash')
    chat = model.start_chat(history=[])

    response = chat.send_message("請用一句話解釋電腦是怎麼運作的，給小孩聽。")
    print(response.text)

    for chunk in chat.send_message("那麼給高中生的詳細解釋呢？", stream=True):
        print(chunk.text)
    ```

<br>

## 使用嵌入

1. Gemini 支援嵌入功能，將文本轉換為向量。

    ```python
    result = genai.embed_content(
        model="models/embedding-001",
        content="什麼是人生的意義？",
        task_type="retrieval_document",
        title="單一字串的嵌入"
    )
    print(result['embedding'][:50], '... TRIMMED]')
    ```

<br>

## 安全性設定

1. 設定模型安全性參數。

    ```python
    response = model.generate_content(
        '[疑似有問題的提示]',
        safety_settings={'HARASSMENT':'block_none'}
    )
    print(response.text)
    ```

<br>

2. 使用 `genai.protos.Content` 類型進行訊息編碼。

    ```python
    response = model.generate_content(
        genai.protos.Content(
            parts=[
                genai.protos.Part(
                    text="請基於這張圖片，使用繁體中文寫一篇有趣的博客。"
                ),
                genai.protos.Part(
                    inline_data=genai.protos.Blob(
                        mime_type='image/jpeg',
                        data=pathlib.Path('image.png').read_bytes()
                    )
                ),
            ]
        ), 
        stream=True
    )

    response.resolve()
    # 之後才可以訪問 response 的屬性
    print(response.text[:100], "... [TRIMMED] ...")
    ```

<br>

## 多轉折對話

1. 使用 `ChatSession` 管理對話：`Gemini` 支援多輪對話，使用 `ChatSession` 可以輕鬆管理對話狀態，這段代碼展示了如何初始化一個聊天會話，並發送一個簡單的訊息，讓模型用一句話解釋電腦的運作方式。

    ```python
    model = genai.GenerativeModel('gemini-1.5-flash')
    chat = model.start_chat(history=[])

    response = chat.send_message("請使用繁體中文，用一段話簡單介紹 Gemini 是怎麼運作的給大學生理解。")
    print(response.text)
    ```

<br>

2. 延續對話並使用流式輸出：如要延續對話，可以新增回覆內容和其他訊息。使用 `stream=True` 引數來串流聊天內容。

    ```python
    _message = "如果是要解釋給研究生及博士生理解呢？"
    for chunk in chat.send_message(_message, stream=True):
        print(chunk.text)
    ```

<br>

3. 繼續對話：這段代碼展示了如何在進行多輪對話時，實時取得生成的回覆內容，並以流的方式顯示。

    ```python
    _message = "如果是要小學生理解呢？"
    for chunk in chat.send_message(_message, stream=True):
        print(chunk.text)
    ```

<br>

4. 延續對話。

    ```python
    # 初始訊息
    messages = [{
        'role': 'user',
        'parts': ["請簡短解釋電腦是如何運作的給小學三年級學生聽。"]
    }]
    # 使用模型生成內容
    response = model.generate_content(messages)
    # 回覆
    print(response.text)

    # 添加模型回覆到對話記錄
    messages.append({
        'role': 'model',
        'parts': [response.text]
    })

    # 繼續對話
    messages.append({
        'role': 'user',
        'parts': ["接著進一步詳細解釋給大學生聽。"]
    })
    # 使用模型生成新的內容
    response = model.generate_content(messages)
    # 回覆
    print(response.text)
    ```

<br>

## 產生設定

_`generation_config` 參數可以用來修改生成參數，例如控制模型生成回覆的方式和長度。_

<br>

1. 展示如何使用生成配置來調整回覆的長度和內容，這樣可以確保生成的故事在特定長度內完成。

    ```python
    model = genai.GenerativeModel('gemini-1.5-flash')
    response = model.generate_content(
        '講一個關於神奇背包的故事。',
        generation_config=genai.types.GenerationConfig(
            candidate_count=1,
            stop_sequences=['x'],
            max_output_tokens=20,
            temperature=1.0
        )
    )

    text = response.text

    if response.candidates[0].finish_reason.name == "MAX_TOKENS":
        text += '...'

    print(text)
    ```

<br>

## 嵌入功能

1. 嵌入是將文本轉換為數值向量的技術，這樣可以方便對文本進行比較和分類。以下範例使用嵌入功能將文本轉換為向量，這在文本相似性檢測和信息檢索中非常有用。

    ```python
    result = genai.embed_content(
        model="models/embedding-001",
        content="什麼是人生的意義？",
        task_type="retrieval_document",
        title="單一字串的嵌入"
    )
    print(result['embedding'][:50], '... TRIMMED]')
    ```

<br>

2. 這段代碼展示如何批量處理多個字串的嵌入，這對於需要對大量文本進行分析和比較的應用非常有幫助。

    ```python
    result = genai.embed_content(
        model="models/embedding-001",
        content=[
            '什麼是人生的意義？',
            '一隻木頭做的狗能吃多少木頭？',
            '大腦是如何運作的？'
        ],
        task_type="retrieval_document",
        title="字串清單的嵌入"
    )

    for v in result['embedding']:
        print(str(v)[:50], '... TRIMMED ...')
    ```

<br>

## 安全性設定

1. 設定模型的安全性參數：可以使用 `safety_settings` 來控制模型生成回覆的安全性，這樣可以避免生成不當內容，從而控制模型是否會生成潛在的不當內容。

    ```python
    response = model.generate_content(
        '[疑似有問題的提示]',
        safety_settings={'HARASSMENT': 'block_none'}
    )
    print(response.text)
    ```

<br>

## 後續步驟

1. 提示設計：撰寫結構周全的提示是確保語言模型提供準確優質回覆的關鍵。

2. 模型變化：`Gemini` 提供多種模型變化版本，以滿足不同用途的需求。

3. 頻率限制：提高頻率限制的選項可以提升 API 的使用效率，特別是在需要大量生成內容的應用場景中。

<br>

___

_END_