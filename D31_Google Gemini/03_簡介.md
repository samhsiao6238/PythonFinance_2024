# Gemini Chat Bot

_基於 `Google Cloud Function`，進一步結合 `LINE Bot` 與 `Google Gemini Pro API` 製作可記憶的聊天機器人，另外並使用 `Firebase` 作為資料儲存。_

<br>

## 使用

1. Python Cloud Function。

2. LINE Bot。

3. Google Gemini Pro。

4. Firebase Database。

<br>

## 建立本地專案

_先建立本地專案，如此若有敏感資訊也可以先寫入 .env 文件中做紀錄_

<br>

1. 建立專案資料夾 `_exGeminiBot_`，接著開啟 VSCode。

<br>

2. 建立四個文件 `requirements.txt`、`main.py`、`.env`、`.gitignore`。

    ```bash
    touch requirements.txt main.py .env .gitignore
    ```

<br>

3. 首先在 `.gitignore` 中將 `.env` 寫入，姑且不論之後是否進行本地部署或同步，這都是一個良好的習慣。

<br>

4. 編輯 `requirements.txt`。

    ```bash
    line-bot-sdk
    requests
    git+https://github.com/ozgur/python-firebase
    google.generativeai
    ```

<br>

## 主腳本

1. 編輯主腳本 `main.py`。

    ```python
    from linebot import LineBotApi, WebhookHandler
    from linebot.models import TextSendMessage
    import json
    import os
    from firebase import firebase
    import google.generativeai as genai

    # 使用環境變量讀取憑證
    token = os.getenv('LINE_BOT_TOKEN')
    secret = os.getenv('LINE_BOT_SECRET')
    firebase_url = os.getenv('FIREBASE_URL')
    gemini_key = os.getenv('GEMINI_API_KEY')

    # Initialize the Gemini Pro API
    genai.configure(api_key=gemini_key)

    def linebot(request):
        body = request.get_data(as_text=True)
        json_data = json.loads(body)
        try:
            line_bot_api = LineBotApi(token)
            handler = WebhookHandler(secret)
            signature = request.headers['X-Line-Signature']
            handler.handle(body, signature)
            event = json_data['events'][0]
            tk = event['replyToken']
            user_id = event['source']['userId']
            msg_type = event['message']['type']

            fdb = firebase.FirebaseApplication(firebase_url, None)
            user_chat_path = f'chat/{user_id}'
            chat_state_path = f'state/{user_id}'
            chatgpt = fdb.get(user_chat_path, None)

            if msg_type == 'text':
                msg = event['message']['text']

                if chatgpt is None:
                    messages = []
                else:
                    messages = chatgpt

                if msg == '!清空':
                    reply_msg = TextSendMessage(
                        text='對話歷史紀錄已經清空！'
                    )
                    fdb.delete(user_chat_path, None)
                else:
                    model = genai.GenerativeModel(
                        'gemini-pro'
                    )
                    messages.append({
                        'role':'user',
                        'parts': [msg]
                    })
                    response = model.generate_content(messages)
                    messages.append({
                        'role':'model',
                        'parts': [response.text]
                    })
                    reply_msg = TextSendMessage(text=response.text)
                    # 更新firebase中的對話紀錄
                    fdb.put_async(
                        user_chat_path,
                        None,
                        messages
                    )

                line_bot_api.reply_message(tk, reply_msg)

            else:
                reply_msg = TextSendMessage(
                    text='你傳的不是文字訊息呦'
                )
                line_bot_api.reply_message(
                    tk,
                    reply_msg
                )

        except Exception as e:
            detail = e.args[0]
            print(detail)
        return 'OK'
    ```

<br>

## 建立 LINE Bot 帳號

1. 前往 [LINE Developer Console](https://developers.line.biz/console/)。

<br>

2. 建立一個新的 Messaging API Channel：取得 `Channel secret`、`Channel access token`。

<br>

## 設置 Firebase

1. 前往 [Google Cloud Console](https://console.cloud.google.com/)。

<br>

2. 建立一個新的 `Firebase 專案`，選擇 `Realtime Database`，建立新的資料庫並設定安全規則為 `允許任何人存取和修改資料` 以便測試。

<br>

3. 取得資料庫的 URL，例如：`https://<your-project-id>.firebaseio.com/`。

<br>

## 設置 Google Cloud Functions

1. 前往 [Google Cloud Console](https://console.cloud.google.com/)。

<br>

2. 建立一個 Cloud Function，選擇 Gen1 或 Gen2 均可。設定為 HTTP 觸發器，選擇`允許未經驗證的叫用` 以簡化測試。

<br>

## Google Cloud 環境變數

1. `GEMINI_API_KEY`：`Google AI Studio` 的 `API Key`。

2. `LINE_BOT_TOKEN`：`LINE Developers` 的 `Channel access token`。

3. `LINE_BOT_SECRET`：`LINE Developers` 的 `Channel secret`。

4. `FIREBASE_URL`：`Firebase 的 URL`。

<br>

## 部署程式碼

1. 進入 `Google Cloud Console` 中設定 `Cloud Function` 的進入點為 `linebot`，並記錄下 `Cloud Function` 的 `URL`，例如 `https://<your-region>-<your-project-id>.cloudfunctions.net/function-name`。

<br>

4. 回到 [LINE Developer Console](https://developers.line.biz/console/)，在 Messaging API Tab 中，將 `Webhook URL` 設為剛剛記錄的 `Cloud Function URL`。

<br>

## 測試並優化

1. 發送訊息到您的 `LINE Bot`，測試其回應是否正確。

<br>

2. 根據需求調整程式碼，並優化安全性，例如：重新設定 Firebase 的安全規則。

<br>

___

_END_