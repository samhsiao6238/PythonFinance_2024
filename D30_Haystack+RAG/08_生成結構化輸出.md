# ç”Ÿæˆçµæ§‹åŒ–è¼¸å‡º

_ä½¿ç”¨å¾ªç’°è‡ªå‹•æ ¡æ­£ç”Ÿæˆçµæ§‹åŒ–è¼¸å‡º_

![](images/img_26.png)

_Generating Structured Output with Loop-Based Auto-Correction_

<br>

## èªªæ˜ 

1. åƒè€ƒ `2024/04/25` çš„ [å®˜æ–¹æ•™ç¨‹](https://haystack.deepset.ai/tutorials/28_structured_output_with_loop)ï¼Œç›®æ¨™æ˜¯çµåˆ `LLM` å»ºç«‹ä¸€å€‹ `å¾ªç’°ç®¡é“` ä¾†é€²è¡Œå‹•æ…‹çš„æ•¸æ“šè™•ç†ï¼Œé€é `LLM` å¾ `éçµæ§‹åŒ–æ•¸æ“š` ä¸­æå– `çµæ§‹åŒ–æ•¸æ“š`ï¼Œä¸¦é©—è­‰ç”Ÿæˆçš„è¼¸å‡ºæ˜¯å¦ç¬¦åˆé å®šç¾©çš„çµæ§‹ã€‚

<br>

2. ä½¿ç”¨ `GPT æ¨¡å‹` å°‡ `éçµæ§‹åŒ–` æ®µè½è½‰æ›ç‚ºç¬¦åˆ `Pydantic` çµæ§‹çš„ `JSON è¼¸å‡º`ï¼Œä¸¦ä½¿ç”¨è‡ªå®šç¾©çš„çµ„ä»¶ `OutputValidator` é€²è¡Œé©—è­‰èˆ‡æ ¡æ­£ã€‚

<br>

3. é€™é¡çš„ `é å®šç¾©æ ¼å¼` çš„ `çµæ§‹åŒ–æ•¸æ“š` å¯æä¾›è·¨ç³»çµ±ã€è·¨å¹³å°çš„æ•¸æ“šäº¤æ›å’Œåˆ†æä½¿ç”¨ã€‚

<br>

## ä½¿ç”¨çµ„ä»¶

1. `PromptBuilder`ï¼šç”¨æ–¼æ§‹å»ºå’Œçµ„åˆç”Ÿæˆæ¨¡å‹æ‰€éœ€çš„æç¤ºï¼Œæ ¹æ“šæŒ‡å®šæ¨¡æ¿ç”Ÿæˆè¼¸å…¥ã€‚

<br>

2. `OpenAIGenerator`ï¼šä½¿ç”¨ OpenAI API é€²è¡Œæ–‡æœ¬ç”Ÿæˆï¼Œæ ¹æ“šæç¤ºç”Ÿæˆè‡ªç„¶èªè¨€å›ç­”æˆ–æ–‡æœ¬ã€‚

<br>

3. `OutputValidator`ï¼šé©—è­‰ç”Ÿæˆæ¨¡å‹çš„è¼¸å‡ºæ˜¯å¦ç¬¦åˆé æœŸï¼Œç¢ºä¿çµæœçš„æº–ç¢ºæ€§å’Œæœ‰æ•ˆæ€§ã€‚

<br>

## é–‹å§‹é–‹ç™¼

1. å®‰è£ `Haystack 2.0` å’Œ `colorama`ï¼Œé€™å€‹æŒ‡ä»¤æ˜¯é€é Github ä¾†å®‰è£æœ€æ–°ç‰ˆæœ¬åˆ†æ”¯ä¸Šçš„ä»£ç¢¼ï¼Œè‹¥è¦å¾ `PyPI` å®‰è£å·²ç¶“ç™¼ä½ˆçš„ç©©å®šç‰ˆå‰‡ä½¿ç”¨ `pip install haystack`ã€‚

    ```bash
    pip install git+https://github.com/deepset-ai/haystack.git@main
    pip install colorama
    ```

<br>

2. é€™å®‰è£çš„æ˜¯ `2.3.0rc0`ï¼Œå·²ç™¼ä½ˆçš„æœ€æ–°ç‰ˆå‰‡æ˜¯ `2.2.1`ã€‚

    ![](images/img_27.png)

<br>

3. å»ºç«‹ç’°å¢ƒè®Šæ•¸ï¼Œç´°ç¯€ä¸å†è´…è¿°ã€‚

    ```python
    from getpass import getpass
    import os
    from dotenv import load_dotenv

    # ç’°å¢ƒè®Šæ•¸
    load_dotenv()
    os.environ["OPENAI_API_KEY"] = os.getenv("OPENAI_API_KEY")

    if "OPENAI_API_KEY" not in os.environ:
        os.environ["OPENAI_API_KEY"] = getpass("Enter OpenAI API key:")
    ```

<br>

## å®šç¾©è§£æ JSON å°è±¡çš„çµæ§‹

1. å®šç¾©ä¸€å€‹ç°¡å–®çš„ JSON çµæ§‹ï¼Œç”¨æ–¼å¾æ–‡æœ¬æ®µè½ä¸­ä½¿ç”¨ `LLM` æå–æ•¸æ“šï¼Œåœ¨ä¸‹æ–¹çš„ä»£ç¢¼ä¸­æœƒå®šç¾©å…©å€‹ `Pydantic æ¨¡å‹`ï¼Œåˆ†åˆ¥æ˜¯ `City` å’Œ `CitiesData`ï¼Œä¸¦è¨­ç½®åˆé©çš„æ¬„ä½å’Œé¡å‹ã€‚

    ```python
    from typing import List
    from pydantic import BaseModel

    class City(BaseModel):
        # åŸå¸‚åç¨±
        name: str
        # åœ‹å®¶
        country: str
        # äººå£
        population: int

    class CitiesData(BaseModel):
        # åŸå¸‚åˆ—è¡¨
        cities: List[City]
    ```

<br>

2. å¯ä»¥æ ¹æ“šéœ€è¦å¾æ–‡æœ¬ä¸­æå–çš„æ ¼å¼æ›´æ”¹é€™äº›æ¨¡å‹ï¼Œç„¶å¾Œä½¿ç”¨ `schema_json()` å¾ `Pydantic æ¨¡å‹` ç”Ÿæˆ JSON çµæ§‹ï¼Œä¸¦åœ¨å¾ŒçºŒæ­¥é©Ÿä¸­åœ¨æç¤ºå…§ä½¿ç”¨é€™å€‹çµæ§‹ä¾†æŒ‡å° `LLM`ã€‚

    ```python
    json_schema = CitiesData.schema_json(indent=2)
    json_schema
    ```

<br>

3. å¾—åˆ°ä¸€å€‹ JSON å­—ä¸²ï¼Œå®šç¾©äº†ç”¨æ–¼å¼•ç”¨çš„å…§éƒ¨æ¨¡å¼ã€‚

    ```python
    {
    "$defs": {
        "City": {
        "properties": {
            "name": {
            "title": "Name",
            "type": "string"
            },
            "country": {
            "title": "Country",
            "type": "string"
            },
            "population": {
            "title": "Population",
            "type": "integer"
            }
        },
        "required": [
            "name",
            "country",
            "population"
        ],
        "title": "City",
        "type": "object"
        }
    },
    "properties": {
        "cities": {
        "items": {
            "$ref": "#/$defs/City"
        },
        "title": "Cities",
        "type": "array"
        }
    },
    "required": [
        "cities"
    ],
    "title": "CitiesData",
    "type": "object"
    }
    ```

<br>

## å»ºç«‹è‡ªå®šç¾©çµ„ä»¶ OutputValidator

1. `OutputValidator` æ˜¯ä¸€å€‹è‡ªå®šç¾©çµ„ä»¶ï¼Œç”¨æ–¼é©—è­‰ `LLM` ç”Ÿæˆçš„ `JSON` å°è±¡æ˜¯å¦ç¬¦åˆæä¾›çš„ `Pydantic` æ¨¡å‹ï¼Œå¦‚æœä¸ç¬¦åˆï¼Œ`OutputValidator` æœƒè¿”å›éŒ¯èª¤æ¶ˆæ¯ä»¥åŠä¸æ­£ç¢ºçš„ JSON å°è±¡ï¼Œä¸¦åœ¨ä¸‹ä¸€å€‹å¾ªç’°ä¸­é€²è¡Œä¿®æ­£ã€‚å¯åƒè€ƒå®˜æ–¹å°æ–¼ [å»ºç«‹è‡ªå®šç¾©çµ„ä»¶](https://docs.haystack.deepset.ai/docs/custom-components) çš„èªªæ˜ã€‚

    ```python
    import json
    import random
    import pydantic
    from pydantic import ValidationError
    from typing import Optional, List
    from colorama import Fore
    from haystack import component

    # å®šç¾©çµ„ä»¶çš„è¼¸å…¥åƒæ•¸
    @component
    class OutputValidator:
        def __init__(self, pydantic_model: pydantic.BaseModel):
            self.pydantic_model = pydantic_model  # ä¿å­˜ Pydantic æ¨¡å‹
            self.iteration_counter = 0  # åˆå§‹åŒ–å¾ªç’°è¨ˆæ•¸å™¨

        # å®šç¾©çµ„ä»¶çš„è¼¸å‡º
        @component.output_types(valid_replies=List[str], invalid_replies=Optional[List[str]], error_message=Optional[str])
        def run(self, replies: List[str]):
            self.iteration_counter += 1  # å¢åŠ å¾ªç’°è¨ˆæ•¸å™¨

            ## å˜—è©¦è§£æ LLM çš„å›è¦† ##
            # å¦‚æœ LLM çš„å›è¦†æ˜¯ä¸€å€‹æœ‰æ•ˆçš„å°è±¡ï¼Œè¿”å› `"valid_replies"`
            try:
                output_dict = json.loads(replies[0])  # è§£æå›è¦†ç‚ºå­—å…¸
                self.pydantic_model.parse_obj(output_dict)  # ä½¿ç”¨ Pydantic æ¨¡å‹é€²è¡Œé©—è­‰
                print(
                    Fore.GREEN
                    + f"OutputValidator at Iteration {self.iteration_counter}: Valid JSON from LLM - No need for looping: {replies[0]}"
                )
                return {"valid_replies": replies}

            # å¦‚æœ LLM çš„å›è¦†æå£æˆ–ç„¡æ•ˆï¼Œè¿”å› "invalid_replies" å’Œ "error_message" ä»¥ä¾¿ LLM é‡è©¦
            except (ValueError, ValidationError) as e:
                print(
                    Fore.RED
                    + f"OutputValidator at Iteration {self.iteration_counter}: Invalid JSON from LLM - Let's try again.\n"
                    f"Output from LLM:\n {replies[0]} \n"
                    f"Error from OutputValidator: {e}"
                )
                return {"invalid_replies": replies, "error_message": str(e)}
    ```

<br>

2. æ¥è‘—ï¼Œä½¿ç”¨ä¹‹å‰å»ºç«‹çš„ `CitiesData` å»ºç«‹ä¸€å€‹ `OutputValidator` å¯¦ä¾‹ã€‚

    ```python
    output_validator = OutputValidator(pydantic_model=CitiesData)
    print(output_validator)
    ```

<br>

3. è¼¸å‡ºçµæœï¼Œé€™æ®µè¼¸å‡ºæ˜¯å° `OutputValidator` é¡çš„ä¸€å€‹å¯¦ä¾‹çš„æè¿°ï¼Œä»¥åŠè©²é¡çš„è¼¸å…¥è¼¸å‡ºè¦ç¯„ã€‚

    ```python
    <__main__.OutputValidator object at 0x1453c1ba0>
    Inputs:
        - replies: List[str]
    Outputs:
        - valid_replies: List[str]
        - invalid_replies: Optional[List[str]]
        - error_message: Optional[str]
    ```

<br>

## å»ºç«‹æ¨¡æ¿

1. å»ºç«‹ä¸€å€‹æ¨¡æ¿ï¼Œå¼•å° `LLM` ç·¨å¯«å°‡æ®µè½è½‰æ›ç‚º `JSON` æ ¼å¼çš„æŒ‡ä»¤ï¼Œä¸¦æ˜ç¢ºæŒ‡ç¤ºå¦‚æœ JSON ä¸ç¬¦åˆè¦æ±‚çš„çµæ§‹ï¼Œå¿…é ˆé€²è¡Œè­˜åˆ¥å’Œä¿®æ­£éŒ¯èª¤ã€‚

    ```python
    prompt_template = """
        æ ¹æ“šæ­¤æ®µè½ä¸­å­˜åœ¨çš„è³‡è¨Šå»ºç«‹ä¸€å€‹ JSON å°è±¡ï¼š
        {{passage}}.
        åƒ…ä½¿ç”¨æ®µè½ä¸­å­˜åœ¨çš„è³‡è¨Šã€‚
        éµå¾ªæ­¤ JSON æ¶æ§‹ï¼Œä½†åƒ…å‚³å›å¯¦éš›å¯¦ä¾‹ï¼Œç„¡éœ€ä»»ä½•å…¶ä»–æ¶æ§‹å®šç¾©ï¼š
        {{schema}}
        ç¢ºä¿æ‚¨çš„ç­”æ¡ˆæ˜¯å­—å…¸è€Œä¸æ˜¯åˆ—è¡¨ã€‚
        {% if invalid_replies and error_message %}
        æ‚¨åœ¨å…ˆå‰çš„å˜—è©¦ä¸­å·²ç¶“å»ºç«‹äº†ä»¥ä¸‹è¼¸å‡ºï¼š
        {{invalid_replies}}
        ä½†æ˜¯ï¼Œé€™ä¸ç¬¦åˆä¸Šé¢çš„æ ¼å¼è¦æ±‚ä¸¦è§¸ç™¼äº†æ­¤ Python ç•°å¸¸ï¼š
        {{error_message}}
        æ›´æ­£è¼¸å‡ºä¸¦é‡è©¦ã€‚åªéœ€è¿”å›æ­£ç¢ºçš„è¼¸å‡ºï¼Œç„¡éœ€ä»»ä½•é¡å¤–çš„è§£é‡‹ã€‚
        {% endif %}
    """
    ```

<br>

2. å»ºç«‹æç¤ºç”Ÿæˆå™¨ï¼Œä¸¦å°‡å‰ä¸€æ­¥é©Ÿå»ºç«‹çš„æ¨¡æ¿ä½œç‚ºåƒæ•¸å‚³å…¥ã€‚

    ```python
    from haystack.components.builders import PromptBuilder

    prompt_builder = PromptBuilder(template=prompt_template)
    ```

<br>

## åˆå§‹åŒ–ç”Ÿæˆå™¨

1. å»ºç«‹èªè¨€æ¨¡å‹ç”Ÿæˆå™¨å°è±¡ `OpenAIGenerator`ï¼Œä¸¦ä½¿ç”¨æŒ‡å®šçš„ OpenAI æ¨¡å‹ä¾†ç”Ÿæˆæ–‡æœ¬ã€‚

    ```python
    from haystack.components.generators import OpenAIGenerator

    # åˆå§‹åŒ– OpenAI ç”Ÿæˆå™¨
    generator = OpenAIGenerator(model="gpt-4-turbo")
    ```

<br>

## å»ºç«‹ç®¡é“

1. å»ºç«‹ç®¡é“ï¼Œè¨­ç½®æœ€å¤§è¿´åœˆæ¬¡æ•¸åƒæ•¸ `max_loops_allowed` ç‚º `5` ä»¥é¿å…ç„¡é™å¾ªç’°ã€‚

    ```python
    from haystack import Pipeline

    pipeline = Pipeline(max_loops_allowed=5)
    ```

<br>

2. æ·»åŠ çµ„ä»¶ã€‚

    ```python
    # æ·»åŠ çµ„ä»¶åˆ°ç®¡é“
    pipeline.add_component(
        instance=prompt_builder, name="prompt_builder"
    )
    pipeline.add_component(
        instance=generator, name="llm"
    )
    pipeline.add_component(
        instance=output_validator, name="output_validator"
    )
    ```

<br>

3. é€£æ¥çµ„ä»¶ï¼Œå°‡ `output_validator` çš„è¼¸å‡ºé€£æ¥å› `prompt_builder`ï¼Œä»¥ä¾¿åœ¨ç”Ÿæˆçš„ JSON ä¸ç¬¦åˆ JSON çµæ§‹æ™‚é€²è¡Œæ ¡æ­£ã€‚

    ```python
    # ç¾åœ¨ï¼Œå°‡çµ„ä»¶ä¹‹é–“é€²è¡Œé€£æ¥
    pipeline.connect(
        "prompt_builder", "llm"
    )
    pipeline.connect(
        "llm", "output_validator"
    )
    # å¦‚æœä¸€å€‹çµ„ä»¶æœ‰å¤šå€‹è¼¸å‡ºæˆ–è¼¸å…¥ï¼Œè«‹æ˜ç¢ºæŒ‡å®šé€£æ¥ï¼š
    pipeline.connect(
        "output_validator.invalid_replies",
        "prompt_builder.invalid_replies"
    )
    pipeline.connect(
        "output_validator.error_message",
        "prompt_builder.error_message"
    )
    ```

<br>

4. è¼¸å‡ºã€‚

    ```bash
    <haystack.core.pipeline.pipeline.Pipeline object at 0x3003632e0>

    ğŸš… Components
        - prompt_builder: PromptBuilder
        - llm: OpenAIGenerator
        - output_validator: OutputValidator

    ğŸ›¤ï¸ Connections
        - prompt_builder.prompt -> llm.prompt (str)
        - llm.replies -> output_validator.replies (List[str])
        - output_validator.invalid_replies -> prompt_builder.invalid_replies (Optional[List[str]])
        - output_validator.error_message -> prompt_builder.error_message (Optional[str])
    ```

<br>

5. ä½¿ç”¨æ‹“å±•çš„å‡½æ•¸è§€å¯Ÿç®¡é“åœ–ã€‚

    ```python
    pipeline.draw("auto-correct-pipeline.png")
    from utils.draw_pipeline import draw_and_display

    draw_and_display(pipeline, "ex08_1_pipe.png")
    ```

    ![](images/img_28.png)

<br>

## æ¸¬è©¦ç®¡é“

1. ä½¿ç”¨ä¸€å€‹ç¯„ä¾‹æ–‡æœ¬ä¾†é‹è¡Œç®¡é“ï¼Œå°‡å…¶è½‰æ›ç‚º JSON æ ¼å¼ä»¥åŠ `CitiesData` çš„ `json_schema`ã€‚

    ```python
    # passage = "Berlin is the capital of Germany. It has a population of 3,850,809. Paris, France's capital, has 2.161 million residents. Lisbon is the capital and the largest city of Portugal with the population of 504,718."
    passage = "æŸæ—æ˜¯å¾·åœ‹çš„é¦–éƒ½ã€‚äººå£3,850,809ã€‚æ³•åœ‹é¦–éƒ½å·´é»ï¼Œå±…æ°‘216.1è¬ã€‚é‡Œæ–¯æœ¬æ˜¯è‘¡è„ç‰™é¦–éƒ½å’Œæœ€å¤§åŸå¸‚ï¼Œäººå£ 504,718 äººã€‚"
    ```

<br>

2. å°‡æ¸¬è©¦è¼¸å…¥å‚³éçµ¦ç®¡é“é€²è¡Œè™•ç†ï¼Œä¸¦ä¸”æŒ‡å®šéœ€è¦éµå¾ªçš„ JSON çµæ§‹ `json_schema`ã€‚

    ```python
    result = pipeline.run({
        "prompt_builder": {
            "passage": passage,
            "schema": json_schema
        }
    })
    ```

<br>

3. çµæœè¼¸å‡ºå¦‚ä¸‹ï¼Œç¢ºèªé€™å€‹æ­¥é©Ÿæœƒè®“ç®¡é“ä¸­çš„å„å€‹çµ„ä»¶æŒ‰è¨­è¨ˆçš„æµç¨‹è™•ç†è¼¸å…¥æ•¸æ“šï¼Œä¸¦ç”Ÿæˆç¬¦åˆæŒ‡å®šæ ¼å¼çš„ JSONã€‚

    ```json
    OutputValidator at Iteration 1: Valid JSON from LLM - No need for looping: {
        "cities": [
            {
            "name": "æŸæ—",
            "country": "å¾·åœ‹",
            "population": 3850809
            },
            {
            "name": "å·´é»",
            "country": "æ³•åœ‹",
            "population": 2161000
            },
            {
            "name": "é‡Œæ–¯æœ¬",
            "country": "è‘¡è„ç‰™",
            "population": 504718
            }
        ]
    }
    ```

<br>

4. åœ¨æŸäº›æƒ…æ³ä¸‹ï¼Œç®¡é“å¯èƒ½æœƒå¤šæ¬¡å˜—è©¦ç”Ÿæˆæ­£ç¢ºçš„è¼¸å‡ºï¼Œå¦‚æœå˜—è©¦æ¬¡æ•¸è¶…éåƒæ•¸ä¸­è¨­ç½®çš„æœ€å¤§å¾ªç’°æ¬¡æ•¸å‰‡æœƒå ±éŒ¯ï¼Œæ­¤æ™‚å¯ä»¥è€ƒæ…®èª¿æ•´åƒæ•¸ä¸Šé™ï¼Œæˆ–é€²ä¸€æ­¥åˆ†æä¸¦ä¿®æ­£ç®¡é“ä¸­çš„éŒ¯èª¤ã€‚ 

    ```bash
    `PipelineMaxLoops: Maximum loops count (5) exceeded for component 'prompt_builder'.
    ```

<br>

5. å¦‚æœæ²’æœ‰é‡åˆ°éŒ¯èª¤ï¼Œå¯ä»¥æ‰“å°å·²æ ¡æ­£çš„ JSONã€‚

    ```python
    valid_reply = result["output_validator"]["valid_replies"][0]
    valid_json = json.loads(valid_reply)
    print(valid_json)
    ```

<br>

6. çµæœåŒä¸Šã€‚

    ```json
    {
        'cities': [
            {
                'name': 'æŸæ—',
                'country': 'å¾·åœ‹',
                'population': 3850809
            },
            {
                'name': 'å·´é»',
                'country': 'æ³•åœ‹', 
                population': 2161000
            },
            {
                'name': 'é‡Œæ–¯æœ¬',
                'country': 'è‘¡è„ç‰™',
                'population': 504718
            }
        ]
    }
    ```

<br>

##  è¤‡é›œçš„æ–‡æœ¬

1. ä»¥ç¶­åŸºç™¾ç§‘å° `å°ç£` çš„ä»‹ç´¹æ–‡æœ¬ä¾†æ¼”ç¹¹ã€‚

    ```python
    introduction_tw = "è‡ºç£ï¼ˆä¿—å­—å¯«ä½œå°ç£ï¼‰ï¼Œè¥¿æ–¹åœ‹å®¶äº¦ç¨±ç¦çˆ¾æ‘©æ²™ï¼ˆè‘¡è„ç‰™èªï¼šFormosaï¼‰ï¼Œæ˜¯ä½æ–¼æ±äºã€å¤ªå¹³æ´‹è¥¿åŒ—å´çš„å³¶å¶¼ï¼Œåœ°è™•ç‰çƒç¾¤å³¶èˆ‡è²å¾‹è³“ç¾¤å³¶ä¹‹é–“ï¼Œè¥¿éš”è‡ºç£æµ·å³½èˆ‡ä¸­åœ‹å¤§é™¸ç›¸æœ›ï¼Œæµ·å³½è·é›¢ç´„130å…¬é‡Œï¼Œå‘¨åœæµ·åŸŸå¾3é»é˜æ–¹å‘ä»¥é †æ™‚é˜æ’åºåˆ†åˆ¥ç‚ºå¤ªå¹³æ´‹ï¼ˆè²å¾‹è³“æµ·ï¼‰ã€å·´å£«æµ·å³½ã€å—æµ·ã€è‡ºç£æµ·å³½ã€æ±æµ·ã€‚é¢ç©ç´„3.6è¬å¹³æ–¹å…¬é‡Œï¼Œåœ¨ç•¶å‰å…¨çƒå„å³¶å¶¼é¢ç©æ’åä¸­ä½å±…ç¬¬38ï¼ˆæˆ–39ï¼‰ï¼Œå³¶ä¸Šç´„ä¸ƒæˆé¢ç©ä¹‹åœ°å½¢ç‚ºå±±åœ°èˆ‡ä¸˜é™µï¼Œå¹³åŸä¸»è¦é›†ä¸­æ–¼è¥¿éƒ¨æ²¿æµ·ï¼Œåœ°å½¢æµ·æ‹”è®ŠåŒ–å¤§ï¼Œæœ€é«˜é»3952å…¬å°ºã€‚å…¨å³¶è¢«åŒ—å›æ­¸ç·šè²«ç©¿ï¼Œæ°£å€™ç‚ç†±ï¼Œå¤å­£åé•·ï¼Œä»‹æ–¼ç†±å¸¶èˆ‡äºç†±å¸¶åœ°å¸¶ä¹‹é–“ï¼ŒåŒ—å›æ­¸ç·šä»¥åŒ—ç‚ºå‰¯ç†±å¸¶å­£é¢¨æ°£å€™ã€ä»¥å—ç‚ºç†±å¸¶å­£é¢¨æ°£å€™[6][7]ï¼Œè‡ªç„¶æ™¯è§€èˆ‡ç”Ÿæ…‹ç³»è³‡æºè±å¯Œå¤šå…ƒ[8]ã€‚è‡ºç£é¢ç©ç´„3.6è¬å¹³æ–¹å…¬é‡Œï¼Œåœ¨ç•¶å‰å…¨çƒå„å³¶å¶¼é¢ç©æ’åä¸­ä½å±…ç¬¬38ï¼ˆæˆ–39ï¼‰ï¼Œç‚ºæ¿å¡Šç¢°æ’éš†èµ·å½¢æˆçš„å¤§é™¸å³¶ï¼Œæ˜¯æ±äºå³¶å¼§ä¹‹ä¸€éƒ¨åˆ†ï¼ˆç”±è²å¾‹è³“æ¿å¡Šæ½›å…¥æ­äºæ¿å¡Šå½¢æˆï¼‰ã€‚å³¶ä¸Šç´„ä¸ƒæˆé¢ç©ä¹‹åœ°å½¢ç‚ºå±±åœ°èˆ‡ä¸˜é™µï¼Œå¹³åŸä¸»è¦é›†ä¸­æ–¼è¥¿éƒ¨æ²¿æµ·ï¼Œåœ°å½¢æµ·æ‹”è®ŠåŒ–å¤§ï¼Œæœ€é«˜é»3952å…¬å°ºã€‚å…¨å³¶è¢«åŒ—å›æ­¸ç·šè²«ç©¿ï¼Œæ°£å€™ç‚ç†±ï¼Œå¤å­£åé•·ï¼Œä»‹æ–¼ç†±å¸¶èˆ‡äºç†±å¸¶åœ°å¸¶ä¹‹é–“ï¼ŒåŒ—å›æ­¸ç·šä»¥åŒ—ç‚ºå‰¯ç†±å¸¶å­£é¢¨æ°£å€™ã€ä»¥å—ç‚ºç†±å¸¶å­£é¢¨æ°£å€™[9][10]ï¼Œè‡ªç„¶æ™¯è§€èˆ‡ç”Ÿæ…‹ç³»è³‡æºè±å¯Œå¤šå…ƒ[8]ã€‚äººå£ç´„2300è¬äººï¼Œè¶…éä¸ƒæˆé›†ä¸­æ–¼è¥¿éƒ¨çš„äº”å¤§éƒ½æœƒå€ï¼Œå…¶ä¸­ä»¥è¡Œæ”¿ä¸­å¿ƒè‡ºåŒ—ç‚ºæ ¸å¿ƒçš„è‡ºåŒ—éƒ½æœƒå€æœ€å¤§ï¼Œç´„700è¬äººã€‚æ—ç¾¤æ§‹æˆä»¥æ¼¢æ—ã€åŸä½æ°‘æ—ç‚ºä¸»ï¼šåŸä½æ°‘æ—ç”±å¤šå€‹å±¬æ–¼å—å³¶æ°‘æ—çš„éƒ¨æ—çµ„æˆï¼Œæ¼¢æ—å‰‡ä¾æ°‘ç³»åŠç§»æ°‘å¹´ä»£çš„ä¸åŒè€Œåˆ†ç‚ºé–©å—ï¼ˆæ²³æ´›ï¼‰ã€å®¢å®¶èˆ‡å¤–çœæ—ç¾¤ï¼Œå…¶ä¸­é–©å—è£”ç‚ºè‡ºç£æœ€å¤§æ—ç¾¤ã€‚ç´„ä¸‰è¬å¹´å‰å†°æ²³æ™‚æœŸé–‹å§‹æœ‰äººé¡é·ç§»è‡³å°ç£æ´»å‹•ï¼Œè‡ªå¤ç‚ºåŸä½æ°‘æ—ä¸–å±…ä¹‹åœ°[11]ï¼ŒåŸä½æ°‘æ—åœ¨17ä¸–ç´€ä¸­è‘‰ä»¥å‰ä¸€ç›´å±…æ–¼ä¸»é«”æ°‘æ—åœ°ä½ï¼›éš¨è‘—æ¼¢æ—ä¸æ–·å¾ä¸­åœ‹å¤§é™¸ç§»å…¥èˆ‡å¢¾æ®–ï¼Œæ¼¢æ—é‚å–ä»£åŸä½æ°‘æ—æˆç‚ºè‡ºç£çš„æœ€å¤§æ°‘æ—ã€‚è‡ªæœ‰ä¿¡å²è¨˜éŒ„ä»¥ä¾†ï¼Œè‡ºç£æ­·å²ä¸Šæ›¾ç¶“æ­·å¤šå€‹åŸä½æ°‘è¯ç›Ÿå’Œæ”¿æ¬Šã€è·è¥¿æ™‚æœŸã€æ˜é„­æ™‚æœŸã€æ¸…æ²»æ™‚æœŸã€æ—¥æ²»æ™‚æœŸç­‰å¤šæ¬¡æ”¿æ¬Šéå¬—ï¼Œæœ€è¿‘ä¸€æ¬¡ç‚º1945å¹´é€²å…¥æˆ°å¾Œæ™‚æœŸç”±ä¸­è¯æ°‘åœ‹çµ±æ²»ã€‚1949å¹´ä¸­è¯æ°‘åœ‹æ”¿åºœæ’­é·è‡ºç£é€ æˆå…©å²¸åˆ†æ²»çš„å±€é¢å¾Œï¼Œè‡ºç£æˆç‚ºä¸­è¯æ°‘åœ‹æœ‰æ•ˆçµ±æ²»é ˜åœŸçš„ä¸»è¦éƒ¨åˆ†[d]ã€‚éš¨è‘—1987å¹´æˆ’åš´æ™‚ä»£çµæŸï¼Œè‡ºç£é€æ¼¸æ·¡åŒ–éå¾€æˆ’åš´æ™‚ä»£å½¢å¡‘çš„ä¸­åœ‹å²è§€ï¼Œæ”¿æ²»ä¸Šèµ°å‘è‡ªç”±åŒ–èˆ‡æ°‘ä¸»åŒ–ï¼Œä»¥ä¸­åœ‹åœ‹æ°‘é»¨åŠæ°‘ä¸»é€²æ­¥é»¨å…©é»¨ç‚ºé¦–çš„æ”¿é»¨æ”¿æ²»ã€çµ±ç¨è­°é¡Œã€ä»¥åŠå…¬æ°‘ç¤¾æœƒçš„å½¢æˆï¼ŒåŠ ä¹‹ä»¥æ±å—äºæ–°ä½æ°‘çš„å®šå±…ï¼Œç”¢ç”Ÿå‡ºå¤šå…ƒæ–‡åŒ–ä¸»ç¾©[12][13]ï¼Œä½¿å¾—è‡ºç£æ–‡åŒ–å‘ˆç¾å¤šå…ƒä¸¦ç«‹çš„é¢è²Œã€‚è€Œç”±æ­¤åŸå› å†åŠ ä¸Šä¸€ä¸­åŸå‰‡ï¼Œä½¿å¾—ç¾ä»Šã€Œè‡ºç£ã€æˆç‚ºä¸­è¯æ°‘åœ‹çš„é€šç¨±ã€‚æ­·ç¶“1860å¹´è‡ºç£é–‹æ¸¯ä»¥ä¾†è‡³æ—¥æ²»æ™‚æœŸæ‰€æ‰“ä¸‹çš„ç¾ä»£åŒ–åŸºç¤[14]ï¼Œä»¥åŠä¸­è¯æ°‘åœ‹æ”¿åºœé·è‡ºå¾Œé‹ç”¨ç¾æ´æ‰€é€²è¡Œçš„ä¸€ç³»åˆ—çš„ç¶“æ¿Ÿå»ºè¨­ï¼ŒåŠ ä¸Šåœ‹éš›ä¸Šå†·æˆ°å°å³™çš„æ ¼å±€ï¼Œè‡ºç£è‡ª1960å¹´ä»£èµ·åœ¨ç¶“æ¿Ÿèˆ‡ç¤¾æœƒç™¼å±•ä¸Šçªé£›çŒ›é€²ï¼Œç· é€ ã€Œè‡ºç£å¥‡è¹Ÿã€ï¼Œååˆ—äºæ´²å››å°é¾ä¹‹ä¸€ï¼›ä¹‹å¾Œåœ¨1990å¹´ä»£èº‹èº«å·²é–‹ç™¼åœ‹å®¶ä¹‹åˆ—ï¼Œç›®å‰ç„¡è«–äººå‡æ‰€å¾—æˆ–äººé¡ç™¼å±•æŒ‡æ•¸å‡å…·ä¸–ç•Œå…ˆé€²åœ‹å®¶æ°´æº–[15]ã€‚è‡ºç£æ“æœ‰è“¬å‹ƒçš„è£½é€ æ¥­åŠå°–ç«¯ç§‘æŠ€ï¼Œåœ¨åŠå°é«”ã€è³‡è¨Šç§‘æŠ€ã€é€šè¨Šã€é›»å­ç²¾å¯†è£½é€ ç­‰é ˜åŸŸåŸ·ç‰›è€³ã€‚è²¿æ˜“æ–¹é¢ä¸»è¦é€éé«˜ç§‘æŠ€ç”¢æ¥­è³ºå–å¤–åŒ¯ï¼Œç¶“æ¿Ÿç™¼å±•ä¸Šä»¥é«˜ç§‘æŠ€ç”¢æ¥­èˆ‡æœå‹™æ¥­ç‚ºä¸­å¿ƒï¼Œäº¦æœå‘æ–‡åŒ–ç”¢æ¥­åŠè§€å…‰æ¥­ç™¼å±•[16]ã€‚å°ç£ä»¥ç§»æ°‘ç‚ºä¸»çš„äººæ–‡çµæ§‹ï¼Œäº¦å¸¶ä¾†å¤šå…ƒçš„æ”¿æ²»è§€é»ã€‚è‡ªå¤§èˆªæµ·æ™‚ä»£ä»¥ä¾†ï¼Œå°ç£æ–‡åŒ–å°±åœ¨æ˜é„­ã€æ¸…æœçš„çµ±æ²»èˆ‡è¥¿æ–¹åˆ—å¼·çš„è¡æ“Šä¸­ç¶“æ­·å¤šæ¬¡å¤§è®Šå‹•ï¼Œä¸¦åœ¨è¿‘ä»£é–‹å§‹ç”¢ç”Ÿè‡ºç£ä¸»é«”æ„è­˜æ€æƒ³ã€‚"
    ```

<br>

2. é€éåŸæœ¬çš„ç®¡é“ä¾†é‹è¡Œã€‚

    ```python
    result_tw = pipeline.run({
        "prompt_builder": {
            "passage": introduction_tw,
            "schema": json_schema
        }
    })
    ```

    _çµæœï¼š_

    ```bash
    OutputValidator at Iteration 2: Valid JSON from LLM - No need for looping: {
    "cities": [
        {
        "name": "è‡ºåŒ—",
        "country": "ä¸­è¯æ°‘åœ‹",
        "population": 7000000
        }
    ]
    }
    ```

<br>

3. æ ¼å¼åŒ–è¼¸å‡ºã€‚

    ```python
    valid_reply_tw = result_tw["output_validator"]["valid_replies"][0]
    valid_json_tw = json.loads(valid_reply_tw)
    print(valid_json_tw)
    ```

    _çµæœï¼š_

    ```json
    {
        'cities': [{
            'name': 'è‡ºåŒ—',
            'country': 'ä¸­è¯æ°‘åœ‹',
            'population': 7000000
        }]
    }
    ```

<br>

___

_END_