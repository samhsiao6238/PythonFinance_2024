# ç”Ÿæˆçµæ§‹åŒ–è¼¸å‡º

_ä½¿ç”¨å¾ªç’°è‡ªå‹•æ ¡æ­£ç”Ÿæˆçµæ§‹åŒ–è¼¸å‡º_

![](images/img_26.png)

## èªªæ˜ 
1. åƒè€ƒ `2024/04/25` çš„ [å®˜æ–¹æ•™ç¨‹](https://haystack.deepset.ai/tutorials/28_structured_output_with_loop)ï¼Œç›®æ¨™æ˜¯æ§‹å»ºä¸€å€‹ç³»çµ±ï¼Œå¯ä½¿ç”¨ `Haystack 2.0` çš„ `å¾ªç’°ç®¡é“` å’Œ `å¤§å‹èªè¨€æ¨¡å‹ï¼ˆLLMï¼‰` ä¾†é€²è¡Œå‹•æ…‹çš„æ•¸æ“šè™•ç†ï¼Œé€éä½¿ç”¨äº† `LLM` å¾ `éçµæ§‹åŒ–æ•¸æ“š` ä¸­æå– `çµæ§‹åŒ–æ•¸æ“š`ï¼Œä¸¦é©—è­‰ç”Ÿæˆçš„è¼¸å‡ºæ˜¯å¦ç¬¦åˆé å®šç¾©çš„çµæ§‹ã€‚

2. æœƒä½¿ç”¨åˆ° OpenAI å¸³æˆ¶ä»¥åŠ `Hystack` çµ„ä»¶ï¼šPromptBuilderã€OpenAIGeneratorã€OutputValidatorã€‚å…¶ä¸­ä½¿ç”¨ GPT æ¨¡å‹å°‡éçµæ§‹åŒ–æ®µè½è½‰æ›ç‚ºç¬¦åˆ `Pydantic` çµæ§‹çš„ JSON è¼¸å‡ºï¼Œä¸¦ä½¿ç”¨è‡ªå®šç¾©çš„ `OutputValidator` çµ„ä»¶ä¾†é©—è­‰ JSON ä¸¦åœ¨å¿…è¦æ™‚é€²è¡Œæ ¡æ­£ã€‚

## å®‰è£ä¾è³´

1. å®‰è£ `Haystack 2.0` å’Œ `colorama`ï¼Œé€™å€‹æŒ‡ä»¤æ˜¯é€é Github ä¾†å®‰è£æœ€æ–°ç‰ˆæœ¬åˆ†æ”¯ä¸Šçš„ä»£ç¢¼ï¼Œè‹¥è¦å¾ `PyPI` å®‰è£å·²ç¶“ç™¼ä½ˆçš„ç©©å®šç‰ˆå‰‡ä½¿ç”¨ `pip install haystack`ã€‚

```bash
pip install git+https://github.com/deepset-ai/haystack.git@main
pip install colorama
```

2. é€™å®‰è£çš„æ˜¯ `2.3.0rc0`ï¼Œå·²ç™¼ä½ˆçš„æœ€æ–°ç‰ˆå‰‡æ˜¯ `2.2.1`ã€‚

    ![](images/img_27.png)

## å®šç¾©è§£æ JSON å°è±¡çš„çµæ§‹

1. å®šç¾©ä¸€å€‹ç°¡å–®çš„ JSON çµæ§‹ï¼Œç”¨æ–¼å¾æ–‡æœ¬æ®µè½ä¸­ä½¿ç”¨ LLM æå–æ•¸æ“šï¼Œåœ¨ä¸‹æ–¹çš„ä»£ç¢¼ä¸­æœƒå®šç¾©å…©å€‹ `Pydantic æ¨¡å‹`ï¼Œåˆ†åˆ¥æ˜¯ `City` å’Œ `CitiesData`ï¼Œä¸¦è¨­ç½®åˆé©çš„å­—æ®µå’Œé¡å‹ã€‚

```python
from typing import List
from pydantic import BaseModel

class City(BaseModel):
    name: str  # åŸå¸‚åç¨±
    country: str  # åœ‹å®¶
    population: int  # äººå£

class CitiesData(BaseModel):
    cities: List[City]  # åŸå¸‚åˆ—è¡¨
```

2. å¯ä»¥æ ¹æ“šéœ€è¦å¾æ–‡æœ¬ä¸­æå–çš„æ ¼å¼æ›´æ”¹é€™äº›æ¨¡å‹ã€‚ç„¶å¾Œï¼Œä½¿ç”¨ `schema_json()` å¾ Pydantic æ¨¡å‹ç”Ÿæˆ JSON çµæ§‹ã€‚åœ¨å¾ŒçºŒæ­¥é©Ÿä¸­å°‡åœ¨æç¤ºä¸­ä½¿ç”¨é€™å€‹çµæ§‹ä¾†æŒ‡å° LLMã€‚

```python
json_schema = CitiesData.schema_json(indent=2)
```

## å‰µå»ºè‡ªå®šç¾©çµ„ä»¶ OutputValidator

1. `OutputValidator` æ˜¯ä¸€å€‹è‡ªå®šç¾©çµ„ä»¶ï¼Œç”¨æ–¼é©—è­‰ `LLM` ç”Ÿæˆçš„ `JSON` å°è±¡æ˜¯å¦ç¬¦åˆæä¾›çš„ `Pydantic` æ¨¡å‹ï¼Œå¦‚æœä¸ç¬¦åˆï¼Œ`OutputValidator` æœƒè¿”å›éŒ¯èª¤æ¶ˆæ¯ä»¥åŠä¸æ­£ç¢ºçš„ JSON å°è±¡ï¼Œä¸¦åœ¨ä¸‹ä¸€å€‹å¾ªç’°ä¸­é€²è¡Œä¿®æ­£ã€‚å¯åƒè€ƒå®˜æ–¹å°æ–¼ [å‰µå»ºè‡ªå®šç¾©çµ„ä»¶](https://docs.haystack.deepset.ai/docs/custom-components) çš„èªªæ˜ã€‚

```python
import json
import random
import pydantic
from pydantic import ValidationError
from typing import Optional, List
from colorama import Fore
from haystack import component

# å®šç¾©çµ„ä»¶çš„è¼¸å…¥åƒæ•¸
@component
class OutputValidator:
    def __init__(self, pydantic_model: pydantic.BaseModel):
        self.pydantic_model = pydantic_model  # ä¿å­˜ Pydantic æ¨¡å‹
        self.iteration_counter = 0  # åˆå§‹åŒ–å¾ªç’°è¨ˆæ•¸å™¨

    # å®šç¾©çµ„ä»¶çš„è¼¸å‡º
    @component.output_types(valid_replies=List[str], invalid_replies=Optional[List[str]], error_message=Optional[str])
    def run(self, replies: List[str]):
        self.iteration_counter += 1  # å¢åŠ å¾ªç’°è¨ˆæ•¸å™¨

        ## å˜—è©¦è§£æ LLM çš„å›è¦† ##
        # å¦‚æœ LLM çš„å›è¦†æ˜¯ä¸€å€‹æœ‰æ•ˆçš„å°è±¡ï¼Œè¿”å› `"valid_replies"`
        try:
            output_dict = json.loads(replies[0])  # è§£æå›è¦†ç‚ºå­—å…¸
            self.pydantic_model.parse_obj(output_dict)  # ä½¿ç”¨ Pydantic æ¨¡å‹é€²è¡Œé©—è­‰
            print(
                Fore.GREEN
                + f"OutputValidator at Iteration {self.iteration_counter}: Valid JSON from LLM - No need for looping: {replies[0]}"
            )
            return {"valid_replies": replies}

        # å¦‚æœ LLM çš„å›è¦†æå£æˆ–ç„¡æ•ˆï¼Œè¿”å› "invalid_replies" å’Œ "error_message" ä»¥ä¾¿ LLM é‡è©¦
        except (ValueError, ValidationError) as e:
            print(
                Fore.RED
                + f"OutputValidator at Iteration {self.iteration_counter}: Invalid JSON from LLM - Let's try again.\n"
                f"Output from LLM:\n {replies[0]} \n"
                f"Error from OutputValidator: {e}"
            )
            return {"invalid_replies": replies, "error_message": str(e)}
```

2. æ¥è‘—ï¼Œä½¿ç”¨ä¹‹å‰å‰µå»ºçš„ `CitiesData` å‰µå»ºä¸€å€‹ `OutputValidator` å¯¦ä¾‹ã€‚

```python
output_validator = OutputValidator(pydantic_model=CitiesData)
```

## å‰µå»ºæç¤º

1. ç‚º `LLM` ç·¨å¯«å°‡æ®µè½è½‰æ›ç‚º `JSON` æ ¼å¼çš„æŒ‡ä»¤ã€‚ç¢ºä¿æŒ‡ä»¤èªªæ˜å¦‚ä½•è­˜åˆ¥å’Œä¿®æ­£éŒ¯èª¤ï¼Œå¦‚æœ JSON ä¸ç¬¦åˆè¦æ±‚çš„çµæ§‹ã€‚ä¸€æ—¦å‰µå»ºäº†æç¤ºï¼Œåˆå§‹åŒ– `PromptBuilder` ä»¥ä½¿ç”¨å®ƒã€‚é—œæ–¼ Jinja2 æ¨¡æ¿å’Œ `PromptBuilder` å¯åƒè€ƒ [å®˜æ–¹ PromptBuilder èªªæ˜](https://docs.haystack.deepset.ai/docs/promptbuilder)ã€‚

```python
from haystack.components.builders import PromptBuilder

prompt_template = """
    Create a JSON object from the information present in this passage: {{passage}}.
    Only use information that is present in the passage. Follow this JSON schema, but only return the actual instances without any additional schema definition:
    {{schema}}
    Make sure your response is a dict and not a list.
    {% if invalid_replies and error_message %}
    You already created the following output in a previous attempt: {{invalid_replies}}
    However, this doesn't comply with the format requirements from above and triggered this Python exception: {{error_message}}
    Correct the output and try again. Just return the corrected output without any extra explanations.
    {% endif %}
"""
prompt_builder = PromptBuilder(template=prompt_template)
```

## åˆå§‹åŒ–ç”Ÿæˆå™¨

1. `OpenAIGenerator` ä½¿ç”¨æŒ‡å®šçš„ OpenAI æ¨¡å‹ä¾†ç”Ÿæˆæ–‡æœ¬ï¼Œå¯åœ¨ `.env` ä¸­è¨­ç½® `OPENAI_API_KEY`ã€‚
```json
OPENAI_API_KEY=<æ›¿æ›è‡ªå·±çš„ API KEI>
```

2. ç¨‹å¼ç¢¼ã€‚
```python
from haystack.components.generators import OpenAIGenerator
import os
from getpass import getpass
from dotenv import load_dotenv

# ç’°å¢ƒè®Šæ•¸
load_dotenv()
os.environ["OPENAI_API_KEY"] = os.getenv("OPENAI_API_KEY")

if "OPENAI_API_KEY" not in os.environ:
    os.environ["OPENAI_API_KEY"] = getpass("Enter OpenAI API key:")
generator = OpenAIGenerator()
```

## æ§‹å»ºç®¡é“

1. å°‡æ‰€æœ‰çµ„ä»¶æ·»åŠ åˆ°ç®¡é“ä¸¦é€£æ¥å®ƒå€‘ï¼Œå°‡ `output_validator` çš„è¼¸å‡ºé€£æ¥å› `prompt_builder`ï¼Œä»¥ä¾¿åœ¨ç”Ÿæˆçš„ JSON ä¸ç¬¦åˆ JSON çµæ§‹æ™‚é€²è¡Œæ ¡æ­£ï¼Œä¸¦ä¸”è¨­ç½® `max_loops_allowed` ä»¥é¿å…ç„¡é™å¾ªç’°ã€‚

```python
from haystack import Pipeline

pipeline = Pipeline(max_loops_allowed=5)

# æ·»åŠ çµ„ä»¶åˆ°ç®¡é“
pipeline.add_component(
    instance=prompt_builder, name="prompt_builder"
)
pipeline.add_component(
    instance=generator, name="llm"
)
pipeline.add_component(
    instance=output_validator, name="output_validator"
)

# ç¾åœ¨ï¼Œå°‡çµ„ä»¶ä¹‹é–“é€²è¡Œé€£æ¥
pipeline.connect(
    "prompt_builder", "llm"
)
pipeline.connect(
    "llm", "output_validator"
)
# å¦‚æœä¸€å€‹çµ„ä»¶æœ‰å¤šå€‹è¼¸å‡ºæˆ–è¼¸å…¥ï¼Œè«‹æ˜ç¢ºæŒ‡å®šé€£æ¥ï¼š
pipeline.connect(
    "output_validator.invalid_replies", "prompt_builder.invalid_replies"
)
pipeline.connect(
    "output_validator.error_message", "prompt_builder.error_message"
)
```

2. è¼¸å‡ºã€‚

```bash
<haystack.core.pipeline.pipeline.Pipeline object at 0x3003632e0>

ğŸš… Components
    - prompt_builder: PromptBuilder
    - llm: OpenAIGenerator
    - output_validator: OutputValidator

ğŸ›¤ï¸ Connections
    - prompt_builder.prompt -> llm.prompt (str)
    - llm.replies -> output_validator.replies (List[str])
    - output_validator.invalid_replies -> prompt_builder.invalid_replies (Optional[List[str]])
    - output_validator.error_message -> prompt_builder.error_message (Optional[str])
```

## å¯è¦–åŒ–ç®¡é“

1. ä½¿ç”¨ `draw()` æ–¹æ³•ç¹ªè£½ç®¡é“ï¼Œç¢ºèªé€£æ¥æ˜¯å¦æ­£ç¢ºã€‚

```python
pipeline.draw("auto-correct-pipeline.png")
```
![](images/img_28.png)

## æ¸¬è©¦ç®¡é“

1. ä½¿ç”¨ä¸€å€‹ç¯„ä¾‹æ®µè½ä¾†é‹è¡Œç®¡é“ï¼Œå°‡å…¶è½‰æ›ç‚º JSON æ ¼å¼ä»¥åŠ`CitiesData` çš„ `json_schema`ã€‚
```bash
passage = "Berlin is the capital of Germany. It has a population of 3,850,809. Paris, France's capital, has 2.161 million residents. Lisbon is the capital and the largest city of Portugal with the population of 504,718."
```

2. å°‡æ¸¬è©¦è¼¸å…¥å‚³éçµ¦ç®¡é“é€²è¡Œè™•ç†ï¼Œä¸¦ä¸”æŒ‡å®šéœ€è¦éµå¾ªçš„ JSON çµæ§‹ï¼ˆjson_schemaï¼‰ã€‚
```python
result = pipeline.run({
    "prompt_builder": {
        "passage": passage,
        "schema": json_schema
    }
})
```

3. çµæœè¼¸å‡ºå¦‚ä¸‹ï¼Œç¢ºèªé€™å€‹æ­¥é©Ÿæœƒè®“ç®¡é“ä¸­çš„å„å€‹çµ„ä»¶æŒ‰è¨­è¨ˆçš„æµç¨‹è™•ç†è¼¸å…¥æ•¸æ“šï¼Œä¸¦ç”Ÿæˆç¬¦åˆæŒ‡å®šæ ¼å¼çš„ JSONã€‚

```json
{
  "cities": [
    {
        "name": "Berlin",
        "country": "Germany",
        "population": 3850809
    },
    {
        "name": "Paris",
        "country": "France",
        "population": 2161000
    },
    {
        "name": "Lisbon",
        "country": "Portugal",
        "population": 504718
    }
  ]
}
```

1. åœ¨æŸäº›æƒ…æ³ä¸‹ï¼Œç®¡é“å¯èƒ½æœƒå¤šæ¬¡å˜—è©¦ç”Ÿæˆæ­£ç¢ºçš„è¼¸å‡ºã€‚å¦‚æœå˜—è©¦è¶…éäº†è¨­ç½®çš„æœ€å¤§å¾ªç’°æ¬¡æ•¸ï¼ˆæ¯”å¦‚æ•™ç¨‹ä¸­æåˆ°çš„ 5 æ¬¡ï¼‰å‰‡æœƒå ±éŒ¯ï¼Œæ­¤æ™‚å¯ä»¥è€ƒæ…® `å¢åŠ å…è¨±çš„æœ€å¤§å¾ªç’°æ¬¡æ•¸`ï¼Œæˆ–è€…åˆ†æä¸¦ä¿®æ­£ç®¡é“ä¸­çš„éŒ¯èª¤ã€‚ 
```bash
`PipelineMaxLoops: Maximum loops count (5) exceeded for component 'prompt_builder'.
```

1. å¦‚æœæ²’æœ‰é‡åˆ°éŒ¯èª¤ï¼Œå¯ä»¥æ‰“å°å·²æ ¡æ­£çš„ JSONã€‚

```python
valid_reply = result["output_validator"]["valid_replies"][0]
valid_json = json.loads(valid_reply)
print(valid_json)
```

6. çµæœåŒä¸Šã€‚
```json
{
    'cities': [
        {
            'name': 'Berlin',
            'country': 'Germany',
            'population': 3850809
        },
        {
            'name': 'Paris',
            'country': 'France',
            'population': 2161000
        }, 
        {
            'name': 'Lisbon',
            'country': 'Portugal',
            'population': 504718
        }
    ]
}
```

### ä¸‹ä¸€æ­¥

ğŸ‰ æ­å–œï¼ä½ å·²ç¶“æ§‹å»ºäº†ä¸€å€‹ç³»çµ±ï¼Œèƒ½å¤ å¾éçµæ§‹åŒ–æ–‡æœ¬æ®µè½ä¸­ç”Ÿæˆçµæ§‹åŒ–çš„ JSONï¼Œä¸¦ä½¿ç”¨ Haystack ç®¡é“çš„å¾ªç’°åŠŸèƒ½é€²è¡Œè‡ªå‹•æ ¡æ­£ã€‚

ç‚ºäº†ä¿æŒå° Haystack æœ€æ–°é–‹ç™¼çš„äº†è§£ï¼Œä½ å¯ä»¥è¨‚é–±æˆ‘å€‘çš„æ–°èç°¡å ±ï¼Œä¸¦åŠ å…¥ Haystack Discord ç¤¾å€ã€‚

æ„Ÿè¬ä½ çš„é–±è®€ï¼

---

å¸Œæœ›é€™å€‹æ•™å­¸èƒ½å¤ å¹«åŠ©ä½ ç†è§£å¦‚ä½•ä½¿ç”¨ Haystack å’Œ OpenAI é€²è¡Œçµæ§‹åŒ–æ•¸æ“šçš„è‡ªå‹•ç”Ÿæˆèˆ‡æ ¡æ­£ã€‚å¦‚æœä½ æœ‰ä»»ä½•ç–‘å•ï¼Œæ­¡è¿éš¨æ™‚å‘æˆ‘è©¢å•ã€‚