# åˆ†é¡ç®¡é“

![](images/img_56.png)

<br>

## èªªæ˜

1. é€™æ˜¯å®˜æ–¹åœ¨ `2024/04/25` ç™¼ä½ˆçš„ [å®˜æ–¹æ•™ç¨‹](https://haystack.deepset.ai/tutorials/32_classifying_documents_and_queries_by_language)ã€‚

<br>

2. è™•ç†å¤šèªè¨€è¼¸å…¥æ˜¯ NLP æ‡‰ç”¨ä¸­çš„å¸¸è¦‹éœ€æ±‚ï¼Œ`Haystack` å…§å»ºçµ„ä»¶ `DocumentLanguageClassifier` å¯ç”¨æ–¼æª¢æ¸¬æ–‡ä»¶çš„èªè¨€ï¼Œé€éé€™ä¾¿å¯åœ¨ `Haystack ç®¡é“` ä¸­å‰µå»ºä¸åŒèªè¨€çš„è™•ç†åˆ†æ”¯ï¼Œä¸¦ç‚ºæ¯ç¨®èªè¨€æ·»åŠ ä¸åŒçš„è™•ç†æ­¥é©Ÿã€‚

<br>

3. æœ¬ç¯„ä¾‹å°‡ä½¿ç”¨äººå·¥ç·¨è¼¯ `ä¸åŒèªè¨€` çš„ `é…’åº—è©•è«–` ä½œç‚º `æ–‡æœ¬æ¨£æœ¬`ï¼Œå°‡å…¶ `è½‰æ›ç‚º Haystack æ–‡ä»¶` å¾Œé€²è¡Œ `èªè¨€åˆ†é¡`ï¼Œç„¶å¾Œæ¯å€‹æ–‡ä»¶å°‡è¢«å¯«å…¥èªè¨€å°ˆç”¨çš„ `DocumentStore` ä¸­ï¼Œæœ€å¾Œå°‡æ§‹å»ºä¸€å€‹å¤šèªè¨€çš„ RAG ç®¡é“æª¢æ¸¬å•é¡Œä½¿ç”¨çš„èªè¨€ï¼Œé‡å°è©²å•é¡Œåƒ…ä½¿ç”¨æå•èªè¨€çš„æ–‡ä»¶ä¾†ç”Ÿæˆç­”æ¡ˆã€‚

<br>

4. æœ¬ç¯„ä¾‹æœ€çµ‚ç›®æ¨™æ˜¯æ§‹å»ºä¸€å€‹ `Haystack ç®¡é“` ä¾†æ ¹æ“š `æ–‡ä»¶çš„èªè¨€` é€²è¡Œåˆ†é¡ï¼Œé‚„å¯ä»¥å°‡ `èªè¨€åˆ†é¡` å’Œ `æŸ¥è©¢è·¯ç”±` é›†æˆåˆ° `RAG ç®¡é“`ä¸­ï¼Œå¦‚æ­¤ä¾¿èƒ½æ ¹æ“š `æŸ¥è©¢çš„èªè¨€` é€²è¡Œæ–‡æª”æª¢ç´¢ï¼Œä¸¦ä½¿ç”¨ç›¸æ‡‰èªè¨€çš„æ–‡æª”ä¾†è¼”åŠ©ç”Ÿæˆç­”æ¡ˆã€‚

<br>

## ä½¿ç”¨çµ„ä»¶

1. `InMemoryDocumentStore`ï¼šæ–‡æª”å­˜å„²ï¼Œé€™æ˜¯ä¸€å€‹å…§å­˜ä¸­çš„æ•¸æ“šå­˜å„²çµ„ä»¶ï¼Œç”¨æ–¼è‡¨æ™‚å­˜å„²å’Œç®¡ç†æ–‡æª”ã€‚

<br>

2. `DocumentLanguageClassifier`ï¼šèªè¨€åˆ†é¡å™¨ï¼Œç”¨æ–¼æª¢æ¸¬æ–‡æª”çš„èªè¨€ã€‚é€™å€‹çµ„ä»¶å¯ä»¥è‡ªå‹•è­˜åˆ¥æ–‡æœ¬å…§å®¹æ‰€ä½¿ç”¨çš„è‡ªç„¶èªè¨€ï¼Œä¸¦æ¨™è¨˜æ–‡æª”çš„èªè¨€å…ƒæ•¸æ“šã€‚

<br>

3. `MetadataRouter`ï¼šå…ƒæ•¸æ“šè·¯ç”±å™¨ï¼ŒMetadataRouter åŸºæ–¼æ–‡æª”çš„å…ƒæ•¸æ“šï¼ˆå¦‚èªè¨€ã€é¡åˆ¥ç­‰ï¼‰ä¾†è·¯ç”±æ–‡æª”ã€‚å®ƒä½¿ç”¨é å®šç¾©çš„è¦å‰‡ä¾†å°‡æ–‡æª”åˆ†é…åˆ°ä¸åŒçš„è™•ç†è·¯å¾‘ä¸Šã€‚

<br>

4. `DocumentWriter`ï¼šæ–‡æª”å¯«å…¥å™¨ï¼Œç”¨æ–¼å°‡æ–‡æª”å¯«å…¥åˆ°æŒ‡å®šçš„æ–‡æª”å­˜å„²ä¸­ã€‚é€™å€‹çµ„ä»¶å¯ä»¥å°‡è™•ç†å¾Œçš„æ–‡æª”ï¼ˆä¾‹å¦‚ç¶“éåµŒå…¥å‘é‡åŒ–çš„æ–‡æª”ï¼‰ä¿å­˜åˆ°å…§å­˜ã€æ•¸æ“šåº«æˆ–å…¶ä»–æŒä¹…åŒ–å­˜å„²ä¸­ï¼Œä»¥ä¾¿å¾ŒçºŒæª¢ç´¢å’ŒæŸ¥è©¢ã€‚

<br>

5. `TextLanguageRouter`ï¼šæ–‡æœ¬èªè¨€è·¯ç”±å™¨ï¼Œé€™æœƒæ ¹æ“šè¼¸å…¥æŸ¥è©¢æ–‡æœ¬çš„èªè¨€ï¼Œå°‡æŸ¥è©¢è·¯ç”±åˆ°ä¸åŒçš„è™•ç†ç®¡é“ã€‚

<br>

6. `DocumentJoiner`ï¼šæ–‡æª”åˆä½µå™¨ï¼Œç”¨æ–¼å°‡å¤šå€‹æ–‡æª”åˆä½µæˆä¸€å€‹è¼¸å‡ºã€‚

<br>

7. `InMemoryBM25Retriever`ï¼šBM25æª¢ç´¢å™¨ï¼Œæ˜¯ä¸€ç¨®åŸºæ–¼ BM25 æ¼”ç®—æ³•çš„æ–‡æœ¬æª¢ç´¢å™¨ï¼Œé©ç”¨æ–¼å…§å­˜ä¸­çš„æ–‡æª”å­˜å„²ã€‚

<br>

8. `PromptBuilder`ï¼šæç¤ºç”Ÿæˆå™¨ï¼Œç”¨æ–¼æ§‹å»ºæç¤ºæ–‡æœ¬ï¼Œå°‡ç”¨æˆ¶çš„æŸ¥è©¢å’Œæ–‡æª”å…§å®¹çµåˆæˆä¸€å€‹çµ±ä¸€çš„æç¤ºï¼Œä¾›ç”Ÿæˆæ¨¡å‹ä½¿ç”¨ã€‚

<br>

9. `OpenAIGenerator`ï¼šæ–‡æœ¬ç”Ÿæˆå™¨ï¼Œé€™æ˜¯ä¸€å€‹ä½¿ç”¨ OpenAI æä¾›çš„æ¨¡å‹ä¾†ç”Ÿæˆæ–‡æœ¬çš„çµ„ä»¶ã€‚

<br>

## é–‹å§‹

1. å®‰è£å¥—ä»¶ã€‚

    ```bash
    pip install haystack-ai langdetect
    ```

<br>

2. å°å…¥å¥—ä»¶ã€‚

    ```python
    # å°å…¥æ‰€éœ€çš„æ¨¡å¡Š
    # ç”¨æ–¼å‰µå»ºå’Œç®¡ç† Haystack ç®¡é“
    from haystack import Document, Pipeline
    # è©²é¡ç”¨æ–¼å‰µå»ºå…§å­˜ä¸­çš„æ–‡æª”å­˜å„²ï¼Œæ–¹ä¾¿å¿«é€Ÿè®€å–å’Œå¯«å…¥æ•¸æ“š
    from haystack.document_stores.in_memory import InMemoryDocumentStore
    # é€™æ˜¯ä¸€å€‹æ–‡æª”èªè¨€åˆ†é¡å™¨ï¼Œç”¨æ–¼æª¢æ¸¬æ–‡æª”çš„èªè¨€
    from haystack.components.classifiers import DocumentLanguageClassifier
    # ç”¨æ–¼æ ¹æ“šæ–‡æª”çš„å…ƒæ•¸æ“šï¼ˆä¾‹å¦‚èªè¨€ï¼‰å°‡æ–‡æª”è·¯ç”±åˆ°ä¸åŒçš„è™•ç†ç¯€é»
    from haystack.components.routers import MetadataRouter
    # ç”¨æ–¼å°‡æ–‡æª”å¯«å…¥æŒ‡å®šçš„æ–‡æª”å­˜å„²ä¸­
    from haystack.components.writers import DocumentWriter
    ```

<br>

3. æº–å‚™æ•¸æ“šã€‚

    ```python
    # æº–å‚™å„ç¨®èªè¨€çš„é…’åº—è©•è«–æ¨£æœ¬
    documents = [
        Document(content="Super appartement. Juste au dessus de plusieurs bars qui ferment trÃ¨s tard. A savoir Ã  l'avance. (Bouchons d'oreilles fournis !)"),
        Document(content="El apartamento estaba genial y muy cÃ©ntrico, todo a mano. Al lado de la librerÃ­a Lello y De la Torre de los clÃ©rigos. EstÃ¡ situado en una zona de marcha, asÃ­ que si vais en fin de semana , habrÃ¡ ruido, aunque a nosotros no nos molestaba para dormir"),
        Document(content="The keypad with a code is convenient and the location is convenient. Basically everything else, very noisy, wi-fi didn't work, check-in person didn't explain anything about facilities, shower head was broken, there's no cleaning and everything else one may need is charged."),
        Document(content="It is very central and appartement has a nice appearance (even though a lot IKEA stuff), *W A R N I N G the appartement presents itself as a elegant and as a place to relax, very wrong place to relax - you cannot sleep in this appartement, even the beds are vibrating from the bass of the clubs in the same building - you get ear plugs from the hotel -> now I understand why -> I missed a trip as it was so loud and I could not hear the alarm next day due to the ear plugs.- there is a green light indicating 'emergency exit' just above the bed, which shines very bright at night - during the arrival process, you felt the urge of the agent to leave as soon as possible. - try to go to 'RVA clerigos appartements' -> same price, super quiet, beautiful, city center and very nice staff (not an agency)- you are basically sleeping next to the fridge, which makes a lot of noise, when the compressor is running -> had to switch it off - but then had no cool food and drinks. - the bed was somehow broken down - the wooden part behind the bed was almost falling appart and some hooks were broken before- when the neighbour room is cooking you hear the fan very loud. I initially thought that I somehow activated the kitchen fan"),
        Document(content="Un peu salÃ© surtout le sol. Manque de service et de souplesse"),
        Document(content="Nous avons passÃ© un sÃ©jour formidable. Merci aux personnes , le bonjours Ã  Ricardo notre taxi man, trÃ¨s sympathique. Je pense refaire un sÃ©jour parmi vous, aprÃ¨s le confinement, tout Ã©tait parfait, surtout leur gentillesse, aucune chaude nÃ©gative. Je n'ai rien Ã  redire de nÃ©gative, Ils Ã©taient a notre Ã©coute, un gentil message tout les matins, pour nous demander si nous avions besoins de renseignement et savoir si tout allait bien pendant notre sÃ©jour."),
        Document(content="CÃ©ntrico. Muy cÃ³modo para moverse y ver Oporto. Edificio con terraza propia en la Ãºltima planta. Todo reformado y nuevo. Te traen un estupendo desayuno todas las maÃ±anas al apartamento. Solo que se puede escuchar algo de ruido de la calle a primeras horas de la noche. Es un zona de ocio nocturno. Pero respetan los horarios.")
    ]
    ```

<br>

## å¯«å…¥æ–‡ä»¶

1. å»ºç«‹ `å…§å­˜æ–‡ä»¶å„²å­˜` èˆ‡ `èªè¨€åˆ†é¡å™¨`ï¼Œä¸¦å°‡ä¸åŒèªè¨€çš„æ–‡ä»¶å¯«å…¥å°æ‡‰çš„ `InMemoryDocumentStore`ã€‚

    ```python
    # å‰µå»ºå„èªè¨€çš„å…§å­˜æ–‡ä»¶å­˜å„²ï¼šè‹±èªã€æ³•èªã€è¥¿ç­ç‰™èª
    en_document_store = InMemoryDocumentStore()
    fr_document_store = InMemoryDocumentStore()
    es_document_store = InMemoryDocumentStore()

    # å‰µå»ºèªè¨€åˆ†é¡å™¨
    language_classifier = DocumentLanguageClassifier(
        languages=["en", "fr", "es"]
    )

    # å‰µå»ºå…ƒæ•¸æ“šè·¯ç”±å™¨ï¼Œæ ¹æ“šèªè¨€å°‡æ–‡ä»¶è·¯ç”±åˆ°å°æ‡‰çš„å¯«å…¥å™¨
    router_rules = {
        "en": {"language": {"$eq": "en"}},
        "fr": {"language": {"$eq": "fr"}},
        "es": {"language": {"$eq": "es"}}
    }
    router = MetadataRouter(rules=router_rules)
    # è¼¸å‡ºçœ‹ä¸€ä¸‹
    print(router)
    ```

    ![](images/img_57.png)

<br>

2. å»ºç«‹å¯«å…¥å™¨ã€‚    

    ```python
    # å‰µå»ºèªè¨€å°ˆç”¨çš„å¯«å…¥å™¨
    en_writer = DocumentWriter(document_store=en_document_store)
    fr_writer = DocumentWriter(document_store=fr_document_store)
    es_writer = DocumentWriter(document_store=es_document_store)
    ```

<br>

3. å»ºç«‹ `ç´¢å¼•ç®¡é“`ï¼Œä¸¦å°‡ `è‹±èª`ã€`æ³•èª` å’Œ `è¥¿ç­ç‰™èª` æ–‡ä»¶åˆ†åˆ¥å¯«å…¥å„è‡ªçš„ `InMemoryDocumentStores`ã€‚

    ```python
    # å‰µå»ºç®¡é“
    indexing_pipeline = Pipeline()
    # æ·»åŠ çµ„ä»¶
    indexing_pipeline.add_component(
        instance=language_classifier, name="language_classifier"
    )
    indexing_pipeline.add_component(
        instance=router, name="router"
    )
    indexing_pipeline.add_component(
        instance=en_writer, name="en_writer"
    )
    indexing_pipeline.add_component(
        instance=fr_writer, name="fr_writer"
    )
    indexing_pipeline.add_component(
        instance=es_writer, name="es_writer"
    )

    # é€£æ¥çµ„ä»¶
    indexing_pipeline.connect("language_classifier", "router")
    indexing_pipeline.connect("router.en", "en_writer")
    indexing_pipeline.connect("router.fr", "fr_writer")
    indexing_pipeline.connect("router.es", "es_writer")
    ```

<br>

4. å¾—åˆ°ä»¥ä¸‹çµæœã€‚

    ```python
    <haystack.core.pipeline.pipeline.Pipeline object at 0x15a08f640>
    
    ğŸš… Components
        - language_classifier: DocumentLanguageClassifier
        - router: MetadataRouter
        - en_writer: DocumentWriter
        - fr_writer: DocumentWriter
        - es_writer: DocumentWriter
    
    ğŸ›¤ï¸ Connections
        - language_classifier.documents -> router.documents (List[Document])
        - router.en -> en_writer.documents (List[Document])
        - router.fr -> fr_writer.documents (List[Document])
        - router.es -> es_writer.documents (List[Document])
    ```

<br>

## æŸ¥çœ‹ç®¡é“ä¸¦é‹è¡Œ

1. ç¹ªè£½ç®¡é“åœ–é€²è¡Œè§€å¯Ÿã€‚

    ```python
    # ç¹ªè£½ç®¡é“åœ–
    indexing_pipeline.draw("indexing_pipeline.png")
    ```

    ![](images/img_58.png)

<br>

2. é‹è¡Œç®¡é“ã€‚

    ```python
    # é‹è¡Œç®¡é“ï¼Œé¡¯ç¤ºå¯«å…¥æ¯å€‹èªè¨€çš„æ–‡ä»¶æ•¸
    indexing_pipeline.run(
        data={"language_classifier": {"documents": documents}}
    )
    ```

<br>

3. å¾—åˆ°ä»¥ä¸‹çµæœã€‚

    ```python
    {
        'router': {'unmatched': []},
        'en_writer': {'documents_written': 2},
        'fr_writer': {'documents_written': 3},
        'es_writer': {'documents_written': 2}
    }
    ```

## æª¢æŸ¥æ–‡ä»¶å­˜å„²çš„å…§å®¹

1. æª¢æŸ¥æ–‡ä»¶å­˜å„²çš„å…§å®¹ï¼Œæ¯å€‹å­˜å„²æ‡‰è©²åªåŒ…å«è©²èªè¨€çš„æ–‡ä»¶ã€‚

    ```python
    print(
        "English documents: ",
        en_document_store.filter_documents()
    )
    print(
        "French documents: ",
        fr_document_store.filter_documents()
    )
    print(
        "Spanish documents: ",
        es_document_store.filter_documents()
    )
    ```

<br>

2. è¼¸å‡ºçµæœã€‚

    ![](images/img_59.png)

<br>

## (å¯é¸) å‰µå»ºå¤šèªè¨€ RAG ç®¡é“

1. æ·»åŠ ç’°å¢ƒè®Šæ•¸ã€‚

    ```python
    from getpass import getpass
    import os
    from dotenv import load_dotenv

    # å°å…¥ç’°å¢ƒè®Šæ•¸
    load_dotenv()
    os.environ["OPENAI_API_KEY"] = os.getenv("OPENAI_API_KEY")
    # åˆ¤æ–·æ˜¯å¦å¯«å…¥ï¼Œè‹¥ç„¡å‰‡æ‰‹å‹•æä¾›
    if "OPENAI_API_KEY" not in os.environ:
        os.environ["OPENAI_API_KEY"] = getpass("Enter OpenAI API key:")
    ```

<br>

2. å°å…¥å¿…è¦åº«ã€‚

    ```python
    # å°å…¥ RAG ç®¡é“æ‰€éœ€çš„çµ„ä»¶
    from haystack.components.retrievers.in_memory import InMemoryBM25Retriever
    from haystack.components.joiners import DocumentJoiner
    from haystack.components.builders import PromptBuilder
    from haystack.components.generators import OpenAIGenerator
    from haystack.components.routers import TextLanguageRouter
    ```

<br>

3. å»ºç«‹æ¨¡æ¿ã€‚

    ```python
    # å®šç¾©æç¤ºæ¨¡æ¿
    prompt_template = """
    æ‚¨å°‡æ”¶åˆ°æœ‰é—œä½å®¿çš„è©•è«–ã€‚
    åƒ…æ ¹æ“šçµ¦å®šçš„è©•è«–ç°¡æ½”åœ°å›ç­”å•é¡Œã€‚
    è©•è«–ï¼š
    {% for doc in documents %}
        {{ doc.content }}
    {% endfor %}
    å•é¡Œï¼š{{ query}}
    ç­”æ¡ˆï¼š
    """
    ```

<br>

## å»ºç«‹ RAG ç®¡é“èˆ‡çµ„ä»¶

1. ç‚ºäº†æ§‹å»º `å¤šèªè¨€ RAG ç®¡é“`ï¼Œå°‡ä½¿ç”¨ `TextLanguageRouter` ä¾†æª¢æ¸¬æŸ¥è©¢çš„èªè¨€ï¼Œç„¶å¾Œå¾ç›¸æ‡‰çš„æ–‡ä»¶å­˜å„²ä¸­ç²å–è©²èªè¨€çš„æ–‡ä»¶ã€‚å¦å¤–ï¼Œå‡è¨­ä¹‹å‰æ”¾å…¥ `æ–‡ä»¶å­˜å„²` ä¸­çš„è©•è«–éƒ½æ˜¯é‡å°åŒä¸€å€‹ä½å®¿çš„ï¼Œä½¿ç”¨ `RAG ç®¡é“`ï¼Œå¯ä»¥æ ¹æ“šé¸æ“‡çš„èªè¨€æŸ¥è©¢æœ‰é—œè©²å…¬å¯“çš„ä¿¡æ¯ã€‚

    ```python
    # å‰µå»º RAG ç®¡é“
    rag_pipeline = Pipeline()
    rag_pipeline.add_component(
        instance=TextLanguageRouter(["en", "fr", "es"]),
        name="router"
    )
    rag_pipeline.add_component(
        instance=InMemoryBM25Retriever(document_store=en_document_store),
        name="en_retriever"
    )
    rag_pipeline.add_component(
        instance=InMemoryBM25Retriever(document_store=fr_document_store),
        name="fr_retriever"
    )
    rag_pipeline.add_component(
        instance=InMemoryBM25Retriever(document_store=es_document_store),
        name="es_retriever"
    )
    rag_pipeline.add_component(
        instance=DocumentJoiner(),
        name="joiner"
    )
    rag_pipeline.add_component(
        instance=PromptBuilder(template=prompt_template),
        name="prompt_builder"
    )
    rag_pipeline.add_component(
        instance=OpenAIGenerator(),
        name="llm"
    )
    ```

<br>

2. é€£æ¥çµ„ä»¶ã€‚

    ```python
    # é€£æ¥çµ„ä»¶
    rag_pipeline.connect("router.en", "en_retriever.query")
    rag_pipeline.connect("router.fr", "fr_retriever.query")
    rag_pipeline.connect("router.es", "es_retriever.query")
    rag_pipeline.connect("en_retriever", "joiner")
    rag_pipeline.connect("fr_retriever", "joiner")
    rag_pipeline.connect("es_retriever", "joiner")
    rag_pipeline.connect("joiner.documents", "prompt_builder.documents")
    rag_pipeline.connect("prompt_builder", "llm")
    ```

<br>

3. å®Œæˆæ™‚æœƒé¡¯ç¤ºã€‚

    ```bash
    <haystack.core.pipeline.pipeline.Pipeline object at 0x319c7f9d0>
    ğŸš… Components
        - language_classifier: DocumentLanguageClassifier
        - router: MetadataRouter
        - en_writer: DocumentWriter
        - fr_writer: DocumentWriter
        - es_writer: DocumentWriter
    ğŸ›¤ï¸ Connections
        - language_classifier.documents -> router.documents (List[Document])
        - router.en -> en_writer.documents (List[Document])
        - router.fr -> fr_writer.documents (List[Document])
        - router.es -> es_writer.documents (List[Document])
    ```

<br>

4. ç¹ªè£½ç®¡é“åœ–ã€‚

    ```python
    # ç¹ªè£½ç®¡é“åœ–
    rag_pipeline.draw("rag_pipeline.png")
    ```

    ![](images/img_60.png)

<br>

4. æå•ï¼šè‹±æ–‡æŸ¥è©¢ã€‚

    ```python
    # æ¸¬è©¦è‹±æ–‡æŸ¥è©¢
    en_question = "Is this apartment conveniently located?"
    result = rag_pipeline.run({
        "router": {"text": en_question},
        "prompt_builder": {"query": en_question}
    })
    print(result["llm"]["replies"][0])
    ```

<br>

5. æå•ï¼šè¥¿ç­ç‰™èªæŸ¥è©¢ã€‚

    ```python
    # æ¸¬è©¦è¥¿ç­ç‰™èªæŸ¥è©¢
    es_question = "Â¿El desayuno es genial?"
    result = rag_pipeline.run({
        "router": {"text": es_question},
        "prompt_builder": {"query": es_question}
    })
    print(result["llm"]["replies"][0])
    ```

<br>

___

_END_