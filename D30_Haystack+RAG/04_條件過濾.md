# 使用元數據過濾文件

_根據給定的元數據過濾文件_

<br>

## 說明

1. 使用的模組：InMemoryDocumentStore, InMemoryBM25Retriever  

<br>

2. 儘管新的檢索技術很實用，但有時只想在特定文件上執行搜索，可以是任何與特定用戶相關的所有文件，或在某個日期之後發布的文件等情況時可使用元數據過濾。

<br>

## 開始進行

1. 安裝 Haystack 2.0

```bash
pip install haystack-ai
```

<br>

2. 準備文件：手動創建了 3 個附加元數據的簡單文件，然後將這些文件寫入 `InMemoryDocumentStore`，也可以使用其他可用的文件儲存，例如 OpenSearch、Chroma、Pinecone 等，但請特別注意不是所有的儲存都支持內儲存存，可能需要額外的設置。

<br>

3. 有關如何將文件寫入不同文件儲存的更多說明可參考 [索引不同文件類型](https://haystack.deepset.ai/docs/2.0/indexing)；關於可對元數據使用的比較運算符包括邏輯比較如 NOT、AND 等，請參考 [元數據過濾文件](https://haystack.deepset.ai/docs/2.0/meta_filtering)。

```python
from datetime import datetime
from haystack import Document
from haystack.document_stores.in_memory import InMemoryDocumentStore
from haystack.components.retrievers.in_memory import InMemoryBM25Retriever

# 創建文件
documents = [
    Document(
        content="Use pip to install a basic version of Haystack's latest release: pip install farm-haystack. All the core Haystack components live in the haystack repo. But there's also the haystack-extras repo which contains components that are not as widely used, and you need to install them separately.",
        meta={"version": 1.15, "date": datetime(2023, 3, 30)},
    ),
    Document(
        content="Use pip to install a basic version of Haystack's latest release: pip install farm-haystack[inference]. All the core Haystack components live in the haystack repo. But there's also the haystack-extras repo which contains components that are not as widely used, and you need to install them separately.",
        meta={"version": 1.22, "date": datetime(2023, 11, 7)},
    ),
    Document(
        content="Use pip to install only the Haystack 2.0 code: pip install haystack-ai. The haystack-ai package is built on the main branch which is an unstable beta version, but it's useful if you want to try the new features as soon as they are merged.",
        meta={"version": 2.0, "date": datetime(2023, 12, 4)},
    ),
]

# 初始化內存文件儲存
document_store = InMemoryDocumentStore(bm25_algorithm="BM25Plus")
# 將文件寫入文件儲存
document_store.write_documents(documents=documents)
```

<br>

4. 建立文件搜索管道：建立一個簡單的文件搜索管道，其中包含檢索器。可嘗試更改這個管道以執行更多操作，例如生成問題的答案或其他功能。

```python
from haystack import Pipeline

# 初始化管道
pipeline = Pipeline()
# 添加內存 BM25 檢索器到管道
pipeline.add_component(
    instance=InMemoryBM25Retriever(document_store=document_store),
    name="retriever"
)
```

<br>

5. 進行元數據過濾：通過過濾文件來回答問題，過濾條件為 `version > 1.21`。

```python
# 提問並進行元數據過濾
query = "Haystack installation"
result = pipeline.run(
    data={
        "retriever": {
            "query": query,
            "filters": {
                "field": "meta.version",
                "operator": ">", "value": 1.21
            }
        }
    }
)

# 輸出結果
print(result)
```

_結果_
{'retriever': {'documents': [Document(id=b53625c67fee5ba5ac6dc86e7ca0adff567bf8376e86ae4b3fc6f6f858ccf1e5, content: 'Use pip to install a basic version of Haystack's latest release: pip install farm-haystack[inference...', meta: {'version': 1.22, 'date': datetime.datetime(2023, 11, 7, 0, 0)}, score: 0.37481165807926137), Document(id=8ac1f8119bdec5c898d5a5c69f49ff47f64056bce1a0f95073e34493bbaf9354, content: 'Use pip to install only the Haystack 2.0 code: pip install haystack-ai. The haystack-ai package is b...', meta: {'version': 2.0, 'date': datetime.datetime(2023, 12, 4, 0, 0)}, score: 0.34124689226266874)]}}

<br>

6. 添加邏輯運算符到過濾條件：要求檢索到的文件版本大於 1.21 並且日期晚於 2023 年 11 月 7 日。

```python
# 提問並進行複合條件過濾
query = "Haystack installation"
result = pipeline.run(
    data={
        "retriever": {
            "query": query,
            "filters": {
                "operator": "AND",
                "conditions": [
                    {"field": "meta.version", "operator": ">", "value": 1.21},
                    {"field": "meta.date", "operator": ">", "value": datetime(2023, 11, 7)},
                ],
            },
        }
    }
)

# 輸出結果
print(result)
```

<br>

_結果_
{'retriever': {'documents': [Document(id=8ac1f8119bdec5c898d5a5c69f49ff47f64056bce1a0f95073e34493bbaf9354, content: 'Use pip to install only the Haystack 2.0 code: pip install haystack-ai. The haystack-ai package is b...', meta: {'version': 2.0, 'date': datetime.datetime(2023, 12, 4, 0, 0)}, score: 0.34124689226266874)]}}

<br>

___

_END_
