# æœ‰æ¢ä»¶çš„è·¯ç”±ç®¡é“

![](images/img_29.png)

_Building Fallbacks to Websearch with Conditional Routing_

<br>

## èªªæ˜

1. é€™æ˜¯åœ¨ `2024/04/25` ç™¼ä½ˆçš„ [å®˜æ–¹æ•™ç¨‹](https://haystack.deepset.ai/tutorials/36_building_fallbacks_with_conditional_routing)ã€‚

<br>

2. ä½¿ç”¨ `Haystack` å»ºç«‹å…·æœ‰ `æœ‰æ¢ä»¶çš„è·¯ç”±ï¼ˆConditional Routingï¼‰` çš„ `ç®¡é“`ï¼›æ‰€è¬‚ `æœ‰æ¢ä»¶çš„è·¯ç”±` æ˜¯æŒ‡åœ¨ `æ•¸æ“šé›†` ä¸­æ‰¾ä¸åˆ°ç­”æ¡ˆæ™‚ï¼Œå¯é€€å› `åœ¨ç¶²çµ¡é€²è¡Œæœå°‹`ã€‚

<br>

3. åœ¨ä½¿ç”¨ `æª¢ç´¢å¢å¼·ç”Ÿæˆï¼ˆRAGï¼‰` é€²è¡Œæ‡‰ç”¨é–‹ç™¼æ™‚ï¼Œ`æª¢ç´¢æ­¥é©Ÿ` æ˜¯ `LLMs` ç”Ÿæˆ `å›æ‡‰` çš„ä¸»è¦ä¿¡æ¯ä¾†æºï¼Œç•¶æ•¸æ“šåº«ç¼ºä¹æ‰€éœ€ä¿¡æ¯ï¼Œæ”¹ç”¨ç¶²çµ¡ä½œç‚º `RAG æ‡‰ç”¨` çš„æ•¸æ“šä¾†æºæ˜¯ä¸€ç¨®å¯¦ç”¨çš„è§£æ±ºæ–¹æ¡ˆï¼›é€™å¯é€šéåœ¨ç³»çµ±ä¸­å¯¦ç¾ `æ¢ä»¶è·¯ç”±æ©Ÿåˆ¶` æ§åˆ¶æ•¸æ“šæµï¼Œè¨­è¨ˆåœ¨æŸäº›æƒ…æ³ä¸‹åˆ©ç”¨ç¶²çµ¡ä½œç‚ºæ•¸æ“šæºçš„ç³»çµ±ã€‚

<br>

4. ç°¡è¨€ä¹‹ï¼Œé€™å€‹ç¯„ä¾‹çš„ç›®æ¨™å°±æ˜¯å»ºç«‹ä¸€å€‹å…·æœ‰ `æ¢ä»¶è·¯ç”±`çš„ `ç®¡é“`ï¼Œç•¶åœ¨æ•¸æ“šé›†ä¸­æ‰¾ä¸åˆ°ç­”æ¡ˆæ™‚ï¼Œå¯ä»¥è‡ªå‹•æ”¹ç”¨ç¶²çµ¡é€²è¡Œæœç´¢ã€‚

<br>

## ä½¿ç”¨çš„çµ„ä»¶èˆ‡ API

1. `ConditionalRouter`ï¼šæ ¹æ“š `æ¢ä»¶` å°‡æ•¸æ“š `è·¯ç”±` åˆ°ä¸åŒçš„ `ç®¡é“åˆ†æ”¯`ï¼Œæ ¹æ“šæŒ‡å®šçš„æ¢ä»¶æ±ºå®šæ•¸æ“šæµå‘ã€‚

<br>

2. `SerperDevWebSearch`ï¼šé€²è¡Œç¶²é æœç´¢ä»¥ç²å–ç›¸é—œè³‡æ–™å’Œä¿¡æ¯ï¼Œé€šå¸¸ç”¨æ–¼å¾ç¶²è·¯ä¸ŠæŸ¥è©¢å’Œæª¢ç´¢æ•¸æ“šã€‚

<br>

3. `PromptBuilder`ï¼šç”¨æ–¼æ§‹å»ºå’Œç”Ÿæˆæç¤ºæ¨¡æ¿ï¼Œå¹«åŠ©ç”Ÿæˆæ¨¡å‹ç†è§£å’Œè™•ç†è¼¸å…¥æ•¸æ“šä¸¦ç”Ÿæˆåˆé©çš„å›æ‡‰ã€‚

<br>

4. `OpenAIGenerator`ï¼šåˆ©ç”¨ OpenAI çš„æ¨¡å‹ç”Ÿæˆæ–‡æœ¬å›æ‡‰ï¼Œé€šå¸¸ç”¨æ–¼è‡ªç„¶èªè¨€ç”Ÿæˆä»»å‹™å¦‚å›ç­”å•é¡Œæˆ–æ–‡æœ¬å‰µå»ºã€‚

<br>

5. `OpenAI API`ï¼šæä¾› OpenAI æ¨¡å‹çš„æ¥å£ï¼Œç”¨æ–¼è‡ªç„¶èªè¨€è™•ç†å’Œç”Ÿæˆä»»å‹™ï¼ŒåŒ…æ‹¬èŠå¤©æ©Ÿå™¨äººã€æ–‡æœ¬ç”Ÿæˆç­‰æ‡‰ç”¨ã€‚

<br>

6. `Serper API`ï¼šé€™æ˜¯ Google æä¾›çš„ç¶²é æœç´¢å’Œæ•¸æ“šæª¢ç´¢æœå‹™çš„æ¥å£ï¼Œç”¨æ–¼åœ¨ç¨‹åºä¸­é€²è¡Œç¶²é æœç´¢ä»¥ç²å–å’Œè™•ç†å¤–éƒ¨ä¿¡æ¯ã€‚

<br>

## é—œæ–¼ serper

_é›†æˆäº†ç¶²çµ¡æœç´¢å¼•æ“çš„åŠŸèƒ½ï¼Œå…è¨±ç”¨æˆ¶åœ¨ä»–å€‘çš„æ‡‰ç”¨ä¸­é€²è¡Œé«˜æ•ˆçš„ç¶²é æœç´¢ã€‚_

<br>

1. é€²è¡Œ [å®˜ç¶²](https://serper.dev/) å¾Œç™»å…¥æˆ–è¨»å†Šã€‚

    ![](images/img_30.png)

<br>

2. è¨»å†Šå®Œæˆé»æ“Š `API Key` ä¾†ç”Ÿæˆå¯†é‘°ï¼Œä¸¦å°‡å¯†é‘°å¯«å…¥ `.env`ï¼Œéµçš„åç¨±ä½¿ç”¨ `SERPERDEV_API_KEY`ã€‚

    ![](images/img_31.png)

<br>

3. è£œå……ä»‹ç´¹ `serper` åç¨±çš„ç”±ä¾†ï¼Œæ‡‰è©²æ˜¯ `SERP` é€™å€‹ç¸®å¯«åŠ ä¸Šå°¾ç¶´ `er` è€Œä¾†ï¼Œè€Œ `SERP` æ˜¯ `Search Engine Results Page` çš„ç¸®å¯«ï¼Œä¹Ÿå°±æ˜¯ `æœç´¢å¼•æ“çµæœé é¢` çš„æ„æ€ã€‚

<br>

## é–‹å§‹é–‹ç™¼

1. å®‰è£ Haystack 2.0ã€‚

    ```bash
    pip install haystack-ai
    ```

<br>

2. å»ºç«‹ç’°å¢ƒè®Šæ•¸ï¼Œç›¸é—œç´°ç¯€ä¸å†è´…è¿°ã€‚

    ```python
    from getpass import getpass
    import os
    from dotenv import load_dotenv

    # è¼‰å…¥ç’°å¢ƒè®Šæ•¸
    load_dotenv()
    # å…©å€‹ API çš„å¯†é‘°
    os.environ["OPENAI_API_KEY"] = os.getenv("OPENAI_API_KEY")
    os.environ["SERPERDEV_API_KEY"] = os.getenv("SERPERDEV_API_KEY")
    # åˆ¤æ–·æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨å¯é€éæ‰‹å‹•è¼¸å…¥
    if "OPENAI_API_KEY" not in os.environ:
        os.environ["OPENAI_API_KEY"] = getpass("Enter OpenAI API key:")
    if "SERPERDEV_API_KEY" not in os.environ:
        os.environ["SERPERDEV_API_KEY"] = getpass("Enter Serper API key:")
    ```

<br>

## å»ºç«‹æ–‡ä»¶

1. å»ºç«‹ä¸€å€‹æä¾›æœå°‹çš„æ–‡ä»¶ï¼Œå…§å®¹æ˜¯é—œæ–¼ `æ…•å°¼é»‘` çš„ç¨®ç¨®æè¿°ï¼Œé€™å°‡ç”¨æ–¼åœ¨ä»£ç¢¼ä¸­é€²è¡Œæœç´¢ç­”æ¡ˆã€‚

    ```python
    # ç”¨æ–¼å»ºç«‹æ–‡ä»¶
    from haystack.dataclasses import Document

    # å®šç¾©ä¸€å€‹æ–‡ä»¶ï¼Œå…§å®¹æè¿°äº†å¾·åœ‹å—éƒ¨å·´ä¼åˆ©äºå·é¦–åºœæ…•å°¼é»‘
    documents = [
        Document(
            content="""æ…•å°¼é»‘æ˜¯å¾·åœ‹å—éƒ¨å·´ä¼åˆ©äºå·çš„é¦–åºœï¼Œå……æ»¿äº†è±å¯Œçš„æ–‡åŒ–éºç”¢å’Œç¾ä»£åŸå¸‚çš„å„ªé›…ã€‚ä½æ–¼ä¼Šè–©çˆ¾æ²³ç•”ï¼Œæ…•å°¼é»‘ä»¥å…¶è¯éº—çš„å»ºç¯‰è€Œèåï¼Œå¦‚é¦¬éº—æ©å»£å ´çš„æ…•å°¼é»‘æ–°å¸‚æ”¿å»³å’Œå¯§èŠ¬å ¡å®®çš„å®å‰å£¯è§€ã€‚é€™åº§åŸå¸‚æ˜¯è—è¡“æ„›å¥½è€…çš„å¤©å ‚ï¼Œæ“æœ‰ä¸–ç•Œç´šçš„åšç‰©é¤¨ï¼Œå¦‚é˜¿çˆ¾ç‰¹Â·çš®ç´ç§‘ç‰¹å…‹ï¼Œæ”¶è—äº†è¨±å¤šè‘—åè—è¡“å®¶çš„å‚‘ä½œã€‚æ…•å°¼é»‘ä¹Ÿå› å…¶ç†±é¬§çš„å•¤é…’èŠ±åœ’è€Œèåï¼Œç•¶åœ°äººå’ŒéŠå®¢èšé›†åœ¨é€™è£¡äº«å—åŸå¸‚è‘—åçš„å•¤é…’å’Œå‚³çµ±å·´ä¼åˆ©äºç¾é£Ÿã€‚æ¯å¹´çš„æ…•å°¼é»‘å•¤é…’ç¯€æ˜¯ä¸–ç•Œä¸Šæœ€å¤§çš„å•¤é…’ç¯€ï¼Œå¸å¼•äº†ä¾†è‡ªä¸–ç•Œå„åœ°çš„æ•¸ç™¾è¬éŠå®¢ã€‚é™¤äº†è±å¯Œçš„æ–‡åŒ–å’Œç¾é£Ÿäº«å—å¤–ï¼Œæ…•å°¼é»‘é‚„æ“æœ‰å¦‚è‹±åœ‹èŠ±åœ’é€™æ¨£çš„ç¾éº—å…¬åœ’ï¼Œç‚ºç¹å¿™çš„éƒ½å¸‚æä¾›äº†ä¸€å€‹å¯§éœçš„é¿é¢¨æ¸¯ã€‚éŠå®¢å€‘ç‚ºæ…•å°¼é»‘çš„ç†±æƒ…å¥½å®¢æ‰€æ‰“å‹•ï¼Œä½¿å¾—é€™è£¡æˆç‚ºäº†æƒ³è¦é«”é©—å¤è€é­…åŠ›å’Œç¾ä»£é­…åŠ›çš„æ—…è¡Œè€…å¿…å»çš„ç›®çš„åœ°ã€‚"""
        )
    ]
    ```

<br>

## å»ºç«‹æ¨¡æ¿

_åœ¨é€™å€‹ç¯„ä¾‹ä¸­æœƒä½¿ç”¨åˆ°å…©å€‹æ¨¡æ¿ï¼Œåˆ†åˆ¥æ˜¯ `æç¤ºæ¨¡æ¿` èˆ‡ `ç¶²è·¯æœå°‹æ¨¡æ¿`_

<br>

1. è‡ªå®šç¾© `æç¤ºæ¨¡æ¿`ï¼šé€™å€‹æ¨¡æ¿å°‡ç”¨ä¾†æŒ‡å° `LLM` é€²è¡Œå›ç­”ï¼Œæ˜ç¢ºæŒ‡ç¤ºè‹¥åœ¨æä¾›çš„æ–‡ä»¶ä¸­æ²’æœ‰è¶³å¤ çš„ä¸Šä¸‹æ–‡ä¾†å›ç­”æ™‚ï¼Œå°‡ç›´æ¥å›è¦† `no_answer`ï¼›åœ¨å¾ŒçºŒæ­¥é©Ÿæœƒå°‡é€™å€‹ `æç¤º` å‚³çµ¦ `PromptBuilder` å°è±¡ä½œç‚ºåƒæ•¸ï¼Œè€Œ `æœ‰æ¢ä»¶çš„è·¯ç”±` å°±æ˜¯ç•¶ `LLM` å›è¦† `no_answer` é€™å€‹ `é—œéµè©`æ™‚æœƒä¾æ“šæŒ‡ç¤ºé€€å›åˆ°çš„ç¶²çµ¡é€²è¡Œæœç´¢ï¼Œå±†æ™‚å°±æœƒä½¿ç”¨åˆ°å¦ä¸€å€‹æ¨¡æ¿ `ç¶²è·¯æœå°‹æ¨¡æ¿`ã€‚

    ```python
    # å®šç¾©ä¸€å€‹æç¤ºæ¨¡æ¿ï¼ŒæŒ‡å° LLM å›ç­”æŸ¥è©¢
    prompt_template = """
    æ ¹æ“šæ–‡ä»¶å›ç­”ä¸‹åˆ—å•é¡Œã€‚
    å¦‚æœç­”æ¡ˆæœªåŒ…å«åœ¨æ–‡ä»¶ä¸­ï¼Œè«‹å›è¦†
    'no_answer'

    Query: {{query}}

    Documents:
    {% for document in documents %}
        {{document.content}}
    {% endfor %}
    """
    ```

<br>

## å»ºç«‹çµ„ä»¶

1. å»ºç«‹çµ„ä»¶ï¼šæç¤ºç”Ÿæˆå™¨ã€‚ 

    ```python
    from haystack.components.builders.prompt_builder import PromptBuilder
    # ä½¿ç”¨å®šç¾©çš„æ¨¡æ¿å»ºç«‹ PromptBuilder
    prompt_builder = PromptBuilder(template=prompt_template)
    ```

<br>

2. å»ºç«‹çµ„ä»¶ï¼šèªè¨€æ¨¡å‹ç”Ÿæˆå™¨ã€‚

    ```python
    from haystack.components.generators import OpenAIGenerator
    # åˆå§‹åŒ– OpenAIGeneratorï¼Œä½¿ç”¨ gpt-4-turbo æ¨¡å‹
    llm = OpenAIGenerator(model="gpt-4-turbo")
    ```

<br>

## å»ºç«‹ç¶²è·¯æœç´¢

1. å»ºç«‹ç¶²è·¯æœç´¢æ¨¡æ¿ã€‚

    ```python
    # å®šç¾©ä¸€å€‹æç¤ºæ¨¡æ¿ï¼Œç”¨æ–¼ç¶²çµ¡æœç´¢
    prompt_for_websearch = """
    æ ¹æ“šå¾ Web æª¢ç´¢åˆ°çš„æ–‡ä»¶ï¼Œå›ç­”ä»¥ä¸‹æŸ¥è©¢ã€‚
    ä½ çš„ç­”æ¡ˆæ‡‰è¡¨æ˜ä½ çš„ç­”æ¡ˆæ˜¯é€éç¶²è·¯æœå°‹ç”¢ç”Ÿçš„ã€‚

    Query: {{query}}
    Documents:
    {% for document in documents %}
        {{document.content}}
    {% endfor %}
    """
    ```

<br>

## å»ºç«‹çµ„ä»¶

1. å»ºç«‹çµ„ä»¶ï¼šç¶²çµ¡æœç´¢å™¨ã€‚

    ```python
    from haystack.components.websearch.serper_dev import SerperDevWebSearch

    # åˆå§‹åŒ–ç¶²çµ¡æœç´¢çµ„ä»¶
    websearch = SerperDevWebSearch()
    ```

<br>

2. å»ºç«‹çµ„ä»¶ï¼šæç¤ºç”Ÿæˆå™¨ã€‚

    ```python
    from haystack.components.builders.prompt_builder import PromptBuilder
    # ä½¿ç”¨ç¶²çµ¡æœç´¢æç¤ºæ¨¡æ¿å»ºç«‹ PromptBuilder
    prompt_builder_for_websearch = PromptBuilder(template=prompt_for_websearch)
    ```

<br>

3. å»ºç«‹çµ„ä»¶ï¼šå›ç­”ç”Ÿæˆå™¨ã€‚

    ```python
    from haystack.components.generators import OpenAIGenerator
    # åˆå§‹åŒ– OpenAIGeneratorï¼Œä½¿ç”¨ gpt-4-turbo æ¨¡å‹
    llm_for_websearch = OpenAIGenerator(model="gpt-4-turbo")
    ```

<br>

## å»ºç«‹æ¢ä»¶è·¯ç”±å™¨

1. `ConditionalRouter` æ˜¯ç”¨ä¾†æ ¹æ“šç‰¹å®šæ¢ä»¶è™•ç† `æ•¸æ“šè·¯ç”±` çš„çµ„ä»¶ï¼Œéœ€è¦ç‚ºæ¯å€‹è·¯ç”±å®šç¾© `ä¸€å€‹æ¢ä»¶`ã€`ä¸€å€‹è¼¸å‡º`ã€`ä¸€å€‹è¼¸å‡ºåç¨±` å’Œ `ä¸€å€‹è¼¸å‡ºé¡å‹`ï¼Œæ¯å€‹ç”± `ConditionalRouter` å»ºç«‹çš„è·¯ç”±éƒ½å……ç•¶é€™å€‹çµ„ä»¶çš„ `è¼¸å‡º`ï¼Œå¯ä»¥é€£æ¥åˆ°ç›¸åŒ `ç®¡é“` ä¸­çš„å…¶ä»– `çµ„ä»¶`ã€‚

<br>

2. å®šç¾©å…©å€‹è·¯ç”±è¦å‰‡ï¼šå¦‚æœ `LLM` å›è¦† `no_answer` é—œéµè©ï¼Œç®¡é“æ‡‰è©²é€²è¡Œ `ç¶²çµ¡æœç´¢`ï¼Œä¹Ÿå°±æ˜¯å°‡æŠŠåŸå§‹æŸ¥è©¢ä½œç‚ºè¼¸å‡ºå€¼å‚³éçµ¦ä¸‹ä¸€å€‹ `çµ„ä»¶`ï¼Œåœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œä¸‹ä¸€å€‹çµ„ä»¶å°‡æ˜¯ `SerperDevWebSearch`ï¼Œä¸¦ä¸” `è¼¸å‡ºåç¨±` å°‡æ˜¯ `go_to_websearch`ã€‚é™¤æ­¤ï¼Œæä¾›çš„æ–‡ä»¶å·²è¶³å¤ å›ç­”å•é¡Œï¼Œç®¡é“åŸ·è¡Œåœ¨æ­¤çµæŸï¼Œä¸¦å°‡ `LLM` å›è¦†çš„ç­”æ¡ˆä½œç‚ºåç‚º `answer` çš„è¼¸å‡ºã€‚

    ```python
    from haystack.components.routers import ConditionalRouter

    # å®šç¾©è·¯ç”±è¦å‰‡
    routes = [
        {
            # å¦‚æœ LLM å›è¦†ä¸­åŒ…å« 'no_answer'
            "condition": "{{'no_answer' in replies[0]}}",
            # å°‡æŸ¥è©¢ä½œç‚ºè¼¸å‡º
            "output": "{{query}}",
            # è¼¸å‡ºåç¨±
            "output_name": "go_to_websearch",
            # è¼¸å‡ºé¡å‹
            "output_type": str
        },
        {
            # å¦‚æœ LLM å›è¦†ä¸­ä¸åŒ…å« 'no_answer'
            "condition": "{{'no_answer' not in replies[0]}}",
            # å°‡å›è¦†çš„ç­”æ¡ˆä½œç‚ºè¼¸å‡º
            "output": "{{replies[0]}}",
            # è¼¸å‡ºåç¨±
            "output_name": "answer",
            # è¼¸å‡ºé¡å‹
            "output_type": str
        }
    ]

    # åˆå§‹åŒ– ConditionalRouter
    router = ConditionalRouter(routes)
    ```

<br>

## å»ºç«‹ç®¡é“

1. å»ºç«‹ç®¡é“å°è±¡ã€‚

    ```python
    from haystack import Pipeline

    # å»ºç«‹ç®¡é“
    pipe = Pipeline()
    ```

<br>

2. å°‡çµ„ä»¶æ·»åŠ åˆ° `ç®¡é“`ã€‚

    ```python
    # æ·»åŠ çµ„ä»¶åˆ°ç®¡é“
    pipe.add_component("prompt_builder", prompt_builder)
    pipe.add_component("llm", llm)
    pipe.add_component("router", router)
    pipe.add_component("websearch", websearch)
    pipe.add_component("prompt_builder_for_websearch", prompt_builder_for_websearch)
    pipe.add_component("llm_for_websearch", llm_for_websearch)
    ```

<br>

3. é€£æ¥çµ„ä»¶ã€‚

    ```python
    # é€£æ¥ç®¡é“ä¸­çš„çµ„ä»¶
    # é€£æ¥ prompt_builder åˆ° llm
    pipe.connect(
        "prompt_builder", "llm"
    )
    # é€£æ¥ llm çš„å›è¦†åˆ° router
    pipe.connect(
        "llm.replies", "router.replies"
    )
    # é€£æ¥ router çš„ go_to_websearch åˆ° websearch çš„æŸ¥è©¢
    pipe.connect(
        "router.go_to_websearch", "websearch.query"
    )
    # é€£æ¥ router çš„ go_to_websearch åˆ° prompt_builder_for_websearch çš„æŸ¥è©¢
    pipe.connect(
        "router.go_to_websearch", "prompt_builder_for_websearch.query"
    )
    # é€£æ¥ websearch çš„æ–‡ä»¶åˆ° prompt_builder_for_websearch
    pipe.connect(
        "websearch.documents", "prompt_builder_for_websearch.documents"
    )
    # é€£æ¥ prompt_builder_for_websearch åˆ° llm_for_websearch
    pipe.connect(
        "prompt_builder_for_websearch", "llm_for_websearch"
    )
    ```

<br>

4. å®Œæˆé€£æ¥æœƒè¼¸å‡ºçµæœã€‚

    ```bash
    <haystack.core.pipeline.pipeline.Pipeline object at 0x30df951b0>

    ğŸš… Components
        - prompt_builder: PromptBuilder
        - llm: OpenAIGenerator
        - router: ConditionalRouter
        - websearch: SerperDevWebSearch
        - prompt_builder_for_websearch: PromptBuilder
        - llm_for_websearch: OpenAIGenerator

    ğŸ›¤ï¸ Connections
        - prompt_builder.prompt -> llm.prompt (str)
        - llm.replies -> router.replies (List[str])
        - router.go_to_websearch -> websearch.query (str)
        - router.go_to_websearch -> prompt_builder_for_websearch.query (str)
        - websearch.documents -> prompt_builder_for_websearch.documents (List[Document])
        - prompt_builder_for_websearch.prompt -> llm_for_websearch.prompt (str)
    ```

<br>

5. ä½¿ç”¨è‡ªè¨‚æ‹“å±•ç¹ªè£½ç®¡é“åœ–ã€‚

    ```python
    from utils.draw_pipeline import draw_and_display

    draw_and_display(indexing_pipeline, "ex10_1_pipe.png")
    ```

    ![](images/img_32.png)

<br>

## é‹è¡Œç®¡é“

1. æå•ä¸¦é‹è¡Œç®¡é“ `run()`ï¼Œå°‡ `æå•ï¼ˆqueryï¼‰` å‚³éçµ¦ `prompt_builder` å’Œ `router`ï¼Œâ— ç‰¹åˆ¥æ³¨æ„ï¼Œåœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæ–‡ä»¶é€šå¸¸ç”± `æª¢ç´¢å™¨` æä¾›ï¼Œé€™è£¡åŸºæ–¼ç°¡åŒ–ç¤ºç¯„ï¼Œå°‡è‡ªè¡Œå®šç¾©çš„æ–‡ä»¶ç›´æ¥æä¾›çµ¦ `prompt_builder`ã€‚

    ```python
    # å®šç¾©æŸ¥è©¢
    query = "æ…•å°¼é»‘åœ¨å“ªè£¡ï¼Ÿ"

    # é‹è¡Œç®¡é“
    result = pipe.run({
        "prompt_builder": {
            "query": query,
            "documents": documents
        },
        "router": {"query": query}
    })

    # è¼¸å‡ºä¾†è‡ª ConditionalRouter çš„ `answer`
    print(result["router"]["answer"])
    # âœ… ç­”æ¡ˆå¯ä»¥åœ¨å®šç¾©çš„æ–‡ä»¶ä¸­æ‰¾åˆ°ã€‚
    ```

<br>

2. çµæœæœƒé¡¯ç¤ºã€‚

    ![](images/img_33.png)

<br>

3. å˜—è©¦åœ¨æ²’æœ‰ç­”æ¡ˆçš„çµ¦å®šæ–‡ä»¶ä¸­æŸ¥è©¢ï¼Œæ¸¬è©¦ç¶²çµ¡æœç´¢æ˜¯å¦æŒ‰é æœŸå·¥ä½œã€‚

    ```python
    # å®šç¾©æŸ¥è©¢
    query = "æ…•å°¼é»‘æœ‰å¤šå°‘äººå£ï¼Ÿ"

    # é‹è¡Œç®¡é“
    result = pipe.run({
        "prompt_builder": {
            "query": query,
            "documents": documents
        },
        "router": {"query": query}
    })

    # è¼¸å‡ºä½¿ç”¨ç¶²çµ¡æœç´¢æ–‡ä»¶ç”Ÿæˆçš„ `replies`
    print(result["llm_for_websearch"]["replies"])

    # æŸ¥çœ‹å®Œæ•´çµæœï¼Œä½ å°‡çœ‹åˆ°ç¶²çµ¡æœç´¢çµ„ä»¶é‚„æä¾›äº†å¾ç¶²ä¸Šæª¢ç´¢åˆ°çš„æ–‡ä»¶éˆæ¥ï¼š
    print(result)
    ```

<br>

4. è¼¸å‡ºçµæœã€‚

    ![](images/img_34.png)

<br>

5. å…¶ä¸­æœƒè¼¸å‡ºä¸€å€‹è³‡è¨Šå­—å…¸å¦‚ä¸‹ï¼Œåœ¨ç¶²è·¯æœå°‹ä¾†æºåŒ…å«ç¶­åŸºç™¾ç§‘ã€ç™¾åº¦ç™¾ç§‘ã€wicco ç­‰å¤šå€‹ä¾†æºã€‚

    ```python
    {
        "llm": {
            "meta": [
                {
                    "model": "gpt-4-turbo-2024-04-09",
                    "index": 0,
                    "finish_reason": "stop",
                    "usage": {
                        "completion_tokens": 2,
                        "prompt_tokens": 557,
                        "total_tokens": 559,
                    },
                }
            ]
        },
        "websearch": {
            "links": [
                "https://zh.wikipedia.org/zh-hans/%E6%85%95%E5%B0%BC%E9%BB%91",
                "https://zh.wikipedia.org/zh-hans/%E5%BE%B7%E5%9B%BD%E5%9F%8E%E5%B8%82%E5%88%97%E8%A1%A8_(%E6%8C%89%E4%BA%BA%E5%8F%A3%E6%8E%92%E5%88%97)",
                "https://baike.baidu.com/item/%E6%85%95%E5%B0%BC%E9%BB%91%E5%B8%82/12766218",
                "https://www.wicco.net/city/149",
                "http://goabroad.sohu.com/20090421/n263520876.shtml",
                "https://www.tatsachen-ueber-deutschland.de/zh-hans/gailan/duocaizhiguo",
                "https://yuanhang.buaa.edu.cn/yhwx/info/1240/4953.htm",
                "http://fao.sz.gov.cn/ztzl/lszt/gjmcszft/content/post_11844.html",
                "https://www.epochtimes.com/gb/11/11/29/n3443938.htm",
                "https://www.aklishi.com/sjls/ozls/20438.html",
            ]
        },
        "llm_for_websearch": {
            "replies": ["æ ¹æ®æä¾›çš„æ–‡ä»¶ï¼Œæ…•å°¼é»‘åœ¨2020å¹´7æœˆ31æ—¥çš„äººå£ä¸º1,558,395äººã€‚"],
            "meta": [
                {
                    "model": "gpt-4-turbo-2024-04-09",
                    "index": 0,
                    "finish_reason": "stop",
                    "usage": {
                        "completion_tokens": 33,
                        "prompt_tokens": 876,
                        "total_tokens": 909,
                    },
                }
            ],
        },
    }
    ```

<br>

___

_END_