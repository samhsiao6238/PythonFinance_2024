# 快速上手

_根據官方的說明建立簡單的問答系統_

<br>

## 建立虛擬環境

1. 要建立新的虛擬環境來進行操作，細節省略。

    ```bash
    python -m venv envHaystack
    ```

<br>

2. 修改環境參數並啟動虛擬環境。

    ```bash
    source ~/.zshrc
    ```

<br>

3. 建立完成時可查看當前套件環境，並依指示進行更新，確認這是一個乾淨的新環境，便可展開後續操作。

    ![](images/img_10.png)

<br>

## 開始撰寫範例

1. 安裝官方套件 `Haystack` 和 `Chroma`。

    ```bash
    pip install haystack-ai chroma-haystack
    ```

<br>

2. 安裝套件用以設置 OpenAI 的 API Key。

    ```bash
    pip install python-dotenv
    ```

<br>

## 建立敏感文件管理

1. 建立 `.env` 與 `.gitignore` 文件。

<br>

2. 寫入 `OPENAI_API_KEY`。

    ```json
    OPENAI_API_KEY=<填入自己的 API KEY>
    ```

<br>

3. 將 `.env` 寫入 `.gitignore`。

<br>

## 繼續編輯腳本

1. 透過腳本從網絡下載文件，並使用 `Haystack` 預設定義索引管道來索引文件；特別注意，腳本中隱式使用了 `OpenAI API`，所以一定要載入環境變數。

    ```python
    import urllib.request
    from haystack import Pipeline, PredefinedPipeline
    import os
    from dotenv import load_dotenv
    # 載入環境變數
    load_dotenv()
    os.environ["OPENAI_API_KEY"] = os.getenv("OPENAI_API_KEY")

    # 下載範例電子書文件
    urllib.request.urlretrieve(
        # 下載網址
        "https://www.gutenberg.org/cache/epub/7785/pg7785.txt",
        # 寫入本地文件名稱
        "davinci.txt"
    )

    # 使用預定義的索引管道
    indexing_pipeline = Pipeline.from_template(
        PredefinedPipeline.INDEXING
    )
    # 使用 Haystack 框架進行文件處理和索引
    indexing_pipeline.run(
        data={"sources": ["davinci.txt"]}
    )
    ```

<br>

2. 說明輸出的訊息。

    ```json
    {
        'embedder': {
            // 包含嵌入模型的元數據
            'meta': {
                // 使用 OpenAI 的 text-embedding-ada-002 模型
                // 這是用於將文本轉換成嵌入向量的模型
                'model': 'text-embedding-ada-002',
                // 包含有關嵌入模型使用的詳細信息
                'usage': {
                    // 提示詞 tokens 數量是 `12972`
                    // 在生成嵌入向量時使用的文本總共包含 12972 個 tokens
                    'prompt_tokens': 12972,
                    'total_tokens': 12972
                }
            }
        },
        // 表示寫入的文檔數量，表示在處理過程中一共生成並寫入了 50 個文檔
        'writer': {'documents_written': 50}
    }
    ```

<br>

3. 另外會添加兩個文件，分別是文本文件 `davinci.txt` 以及資料庫文件 `chroma.sqlite3`，其中文本文件是調用了 `urllib.request.urlretrieve` 所下載的；另外，在使用 `Haystack` 進行文檔索引時，系統預設會建立一個 `SQLite` 文件 `chroma.sqlite3` 來保存數據，這就是 `Document Store` 的實現，而這個文件中包含了索引數據，用以支持快速檢索文件。

<br>

4. 建立 RAG 管道：使用預定義的 RAG 管道來回答問題。

    ```python
    from haystack import Pipeline, PredefinedPipeline

    # 建立 RAG 管道
    rag_pipeline = Pipeline.from_template(PredefinedPipeline.RAG)

    # 提出問題
    query = "他是誰？叫什麼名字？出生地在哪裡？他往生的時候是幾歲？"
    # 結果
    result = rag_pipeline.run(
        data={
            "prompt_builder": {"query": query},
            "text_embedder": {"text": query}
        }
    )

    # 輸出答案
    print(result["llm"]["replies"][0])
    ```

<br>

3. 得到以下結果，特別注意，每次運行會得到近似但不完全相同的文本。

    他是利安納多‧達‧文西（Leonardo da Vinci），出生在意大利的小鎮文奇（Vinci），在1519年的復活節前夕去世，享年67歲。

<br>

## 補充資料庫的操作

1. 檢查 SQLite 資料庫。

    ```python
    import sqlite3

    # 連接到 SQLite 資料庫文件
    conn = sqlite3.connect('chroma.sqlite3')
    cursor = conn.cursor()

    # 列出所有的表名
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table';")
    tables = cursor.fetchall()
    print("資料庫中的表:")
    for table in tables:
        print(table[0])

    # 顯示表中一些數據示例（假設表名為 'documents'）
    try:
        cursor.execute("SELECT * FROM documents LIMIT 5;")
        rows = cursor.fetchall()
        print("\n'documents' 表中的示例數據:")
        for row in rows:
            print(row)
    except sqlite3.OperationalError as e:
        print(f"出現錯誤: {e}")

    # 關閉資料庫連接
    conn.close()
    ```

<br>

___

_END_